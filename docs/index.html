<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Brandon Martínez">
<meta name="description" content="Tráfico marítimo en el Canal de Panamá, análisis técnico operacional-temporal con separación de prueba externa.">

<title>Green Maritime Corridors - Canal de Panamá</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cc63fce9873912f1bbbccf05079cc9ea.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Green Maritime Corridors - Canal de Panamá</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Buscar"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navegación de palanca" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Inicio</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Brandon780/avances_analytic_corridors"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Contenidos</h2>
   
  <ul>
  <li><a href="#librerías-y-dependencias" id="toc-librerías-y-dependencias" class="nav-link active" data-scroll-target="#librerías-y-dependencias"><span class="header-section-number">0.1</span> Librerías y dependencias</a></li>
  <li><a href="#lectura-y-limpieza-inicial" id="toc-lectura-y-limpieza-inicial" class="nav-link" data-scroll-target="#lectura-y-limpieza-inicial"><span class="header-section-number">0.2</span> Lectura y limpieza inicial</a></li>
  <li><a href="#partición-externa" id="toc-partición-externa" class="nav-link" data-scroll-target="#partición-externa"><span class="header-section-number">0.3</span> Partición externa</a></li>
  <li><a href="#exploración-inicial-eda" id="toc-exploración-inicial-eda" class="nav-link" data-scroll-target="#exploración-inicial-eda"><span class="header-section-number">1</span> Exploración inicial (EDA)</a>
  <ul class="collapse">
  <li><a href="#resumen-de-train_val" id="toc-resumen-de-train_val" class="nav-link" data-scroll-target="#resumen-de-train_val"><span class="header-section-number">1.1</span> Resumen de train_val</a></li>
  <li><a href="#exploración-inicial-de-datos-sin-h3_sequence" id="toc-exploración-inicial-de-datos-sin-h3_sequence" class="nav-link" data-scroll-target="#exploración-inicial-de-datos-sin-h3_sequence"><span class="header-section-number">1.2</span> Exploración inicial de datos (sin h3_sequence)</a></li>
  <li><a href="#revisión-de-tipos-de-datos" id="toc-revisión-de-tipos-de-datos" class="nav-link" data-scroll-target="#revisión-de-tipos-de-datos"><span class="header-section-number">1.3</span> Revisión de tipos de datos</a></li>
  <li><a href="#distribución-de-registros-por-buque" id="toc-distribución-de-registros-por-buque" class="nav-link" data-scroll-target="#distribución-de-registros-por-buque"><span class="header-section-number">1.4</span> Distribución de registros por buque</a>
  <ul class="collapse">
  <li><a href="#gráfico-de-distribución-de-registros-por-buque" id="toc-gráfico-de-distribución-de-registros-por-buque" class="nav-link" data-scroll-target="#gráfico-de-distribución-de-registros-por-buque"><span class="header-section-number">1.4.1</span> Gráfico de distribución de registros por buque</a></li>
  </ul></li>
  <li><a href="#verificar-viajes-puertopuerto" id="toc-verificar-viajes-puertopuerto" class="nav-link" data-scroll-target="#verificar-viajes-puertopuerto"><span class="header-section-number">1.5</span> Verificar viajes puerto–puerto</a></li>
  <li><a href="#revisar-consumos-de-energía" id="toc-revisar-consumos-de-energía" class="nav-link" data-scroll-target="#revisar-consumos-de-energía"><span class="header-section-number">1.6</span> Revisar consumos de energía</a></li>
  <li><a href="#duración-de-viajes-puertopuerto" id="toc-duración-de-viajes-puertopuerto" class="nav-link" data-scroll-target="#duración-de-viajes-puertopuerto"><span class="header-section-number">1.7</span> Duración de viajes puerto–puerto</a></li>
  <li><a href="#análisis-de-viajes-específicos-puertopuerto" id="toc-análisis-de-viajes-específicos-puertopuerto" class="nav-link" data-scroll-target="#análisis-de-viajes-específicos-puertopuerto"><span class="header-section-number">1.8</span> Análisis de viajes específicos puerto–puerto</a></li>
  <li><a href="#cuántos-buques-tienen-secuencias" id="toc-cuántos-buques-tienen-secuencias" class="nav-link" data-scroll-target="#cuántos-buques-tienen-secuencias"><span class="header-section-number">1.9</span> Cuántos buques tienen secuencias</a></li>
  <li><a href="#creación-de-la-variable-objetivo-co2_emission" id="toc-creación-de-la-variable-objetivo-co2_emission" class="nav-link" data-scroll-target="#creación-de-la-variable-objetivo-co2_emission"><span class="header-section-number">1.10</span> Creación de la variable objetivo: CO2_emission</a>
  <ul class="collapse">
  <li><a href="#bloque-1-ver-ceros-en-co2_emission" id="toc-bloque-1-ver-ceros-en-co2_emission" class="nav-link" data-scroll-target="#bloque-1-ver-ceros-en-co2_emission"><span class="header-section-number">1.10.1</span> <strong>Bloque 1: Ver ceros en CO2_emission</strong></a></li>
  <li><a href="#eliminar-registros-con-cero" id="toc-eliminar-registros-con-cero" class="nav-link" data-scroll-target="#eliminar-registros-con-cero"><span class="header-section-number">1.10.2</span> <strong>Eliminar registros con cero</strong></a></li>
  </ul></li>
  <li><a href="#limpieza-de-nan-en-target-y-verificación-de-secuencias-mínimas" id="toc-limpieza-de-nan-en-target-y-verificación-de-secuencias-mínimas" class="nav-link" data-scroll-target="#limpieza-de-nan-en-target-y-verificación-de-secuencias-mínimas"><span class="header-section-number">1.11</span> Limpieza de NaN en target y verificación de secuencias mínimas</a></li>
  <li><a href="#recorte-de-buques-que-no-cumplen-la-longitud-mínima" id="toc-recorte-de-buques-que-no-cumplen-la-longitud-mínima" class="nav-link" data-scroll-target="#recorte-de-buques-que-no-cumplen-la-longitud-mínima"><span class="header-section-number">1.12</span> Recorte de buques que no cumplen la longitud mínima</a></li>
  <li><a href="#valores-nulos" id="toc-valores-nulos" class="nav-link" data-scroll-target="#valores-nulos"><span class="header-section-number">1.13</span> valores nulos</a></li>
  <li><a href="#partición-interna" id="toc-partición-interna" class="nav-link" data-scroll-target="#partición-interna"><span class="header-section-number">1.14</span> Partición interna</a>
  <ul class="collapse">
  <li><a href="#definición-de-la-función-de-imputación" id="toc-definición-de-la-función-de-imputación" class="nav-link" data-scroll-target="#definición-de-la-función-de-imputación"><span class="header-section-number">1.14.1</span> Definición de la función de imputación</a></li>
  <li><a href="#aplicación-en-training-entrenamiento-interno" id="toc-aplicación-en-training-entrenamiento-interno" class="nav-link" data-scroll-target="#aplicación-en-training-entrenamiento-interno"><span class="header-section-number">1.14.2</span> Aplicación en training (entrenamiento interno)</a></li>
  <li><a href="#aplicación-en-validación" id="toc-aplicación-en-validación" class="nav-link" data-scroll-target="#aplicación-en-validación"><span class="header-section-number">1.14.3</span> Aplicación en validación</a></li>
  </ul></li>
  <li><a href="#creación-de-features-feature-engineering" id="toc-creación-de-features-feature-engineering" class="nav-link" data-scroll-target="#creación-de-features-feature-engineering"><span class="header-section-number">1.15</span> creación de features (feature engineering)</a>
  <ul class="collapse">
  <li><a href="#aplicación-a-entrenamiento-interno" id="toc-aplicación-a-entrenamiento-interno" class="nav-link" data-scroll-target="#aplicación-a-entrenamiento-interno"><span class="header-section-number">1.15.1</span> Aplicación a entrenamiento interno</a></li>
  <li><a href="#aplicación-a-validación-interna" id="toc-aplicación-a-validación-interna" class="nav-link" data-scroll-target="#aplicación-a-validación-interna"><span class="header-section-number">1.15.2</span> Aplicación a validación interna</a></li>
  <li><a href="#vista" id="toc-vista" class="nav-link" data-scroll-target="#vista"><span class="header-section-number">1.15.3</span> vista</a></li>
  </ul></li>
  <li><a href="#visualización-de-matriz-de-correlación-heatmap" id="toc-visualización-de-matriz-de-correlación-heatmap" class="nav-link" data-scroll-target="#visualización-de-matriz-de-correlación-heatmap"><span class="header-section-number">1.16</span> Visualización de matriz de correlación (heatmap)</a>
  <ul class="collapse">
  <li><a href="#definición-de-la-función-para-eliminar-correlación-alta" id="toc-definición-de-la-función-para-eliminar-correlación-alta" class="nav-link" data-scroll-target="#definición-de-la-función-para-eliminar-correlación-alta"><span class="header-section-number">1.16.1</span> <strong>Definición de la función para eliminar correlación alta</strong></a></li>
  <li><a href="#aplicación-de-la-función-a-entrenamiento-y-validación" id="toc-aplicación-de-la-función-a-entrenamiento-y-validación" class="nav-link" data-scroll-target="#aplicación-de-la-función-a-entrenamiento-y-validación"><span class="header-section-number">1.16.2</span> <strong>Aplicación de la función a entrenamiento y validación</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#aplicar-la-eliminación-de-columnas-seleccionadas-a-train-y-validación" id="toc-aplicar-la-eliminación-de-columnas-seleccionadas-a-train-y-validación" class="nav-link" data-scroll-target="#aplicar-la-eliminación-de-columnas-seleccionadas-a-train-y-validación"><span class="header-section-number">2</span> Aplicar la eliminación de columnas seleccionadas a train y validación</a>
  <ul class="collapse">
  <li><a href="#variables-resultante" id="toc-variables-resultante" class="nav-link" data-scroll-target="#variables-resultante"><span class="header-section-number">2.1</span> variables resultante</a></li>
  <li><a href="#outliers" id="toc-outliers" class="nav-link" data-scroll-target="#outliers"><span class="header-section-number">2.2</span> outliers</a></li>
  <li><a href="#definir-features-numéricas-y-categóricas" id="toc-definir-features-numéricas-y-categóricas" class="nav-link" data-scroll-target="#definir-features-numéricas-y-categóricas"><span class="header-section-number">2.3</span> <strong>Definir features numéricas y categóricas</strong></a></li>
  <li><a href="#escalado-de-features-numéricas-y-codificación-de-categóricas" id="toc-escalado-de-features-numéricas-y-codificación-de-categóricas" class="nav-link" data-scroll-target="#escalado-de-features-numéricas-y-codificación-de-categóricas"><span class="header-section-number">2.4</span> <strong>Escalado de features numéricas y codificación de categóricas</strong></a></li>
  <li><a href="#escalado-de-la-variable-objetivo" id="toc-escalado-de-la-variable-objetivo" class="nav-link" data-scroll-target="#escalado-de-la-variable-objetivo"><span class="header-section-number">2.5</span> <strong>Escalado de la variable objetivo</strong></a></li>
  <li><a href="#inspeccionar_target" id="toc-inspeccionar_target" class="nav-link" data-scroll-target="#inspeccionar_target"><span class="header-section-number">2.6</span> inspeccionar_target</a></li>
  <li><a href="#crear-secuencias-para-lstm-con-índices-originales" id="toc-crear-secuencias-para-lstm-con-índices-originales" class="nav-link" data-scroll-target="#crear-secuencias-para-lstm-con-índices-originales"><span class="header-section-number">2.7</span> <strong>Crear secuencias para LSTM (con índices originales)</strong></a></li>
  <li><a href="#construcción-y-entrenamiento-del-modelo-lstm" id="toc-construcción-y-entrenamiento-del-modelo-lstm" class="nav-link" data-scroll-target="#construcción-y-entrenamiento-del-modelo-lstm"><span class="header-section-number">2.8</span> <strong>Construcción y entrenamiento del modelo LSTM</strong></a></li>
  <li><a href="#evaluación-del-modelo" id="toc-evaluación-del-modelo" class="nav-link" data-scroll-target="#evaluación-del-modelo"><span class="header-section-number">2.9</span> <strong>Evaluación del modelo</strong></a></li>
  <li><a href="#conjunto-de-prueba" id="toc-conjunto-de-prueba" class="nav-link" data-scroll-target="#conjunto-de-prueba"><span class="header-section-number">2.10</span> conjunto de prueba</a></li>
  <li><a href="#crear-target-co2_emission-en-test" id="toc-crear-target-co2_emission-en-test" class="nav-link" data-scroll-target="#crear-target-co2_emission-en-test"><span class="header-section-number">2.11</span> Crear target CO2_emission en test</a></li>
  <li><a href="#eliminar-filas-con-co2_emission-0" id="toc-eliminar-filas-con-co2_emission-0" class="nav-link" data-scroll-target="#eliminar-filas-con-co2_emission-0"><span class="header-section-number">2.12</span> Eliminar filas con CO2_emission = 0</a></li>
  <li><a href="#revisar-cuántas-filas-quedan-tras-eliminar-ceros" id="toc-revisar-cuántas-filas-quedan-tras-eliminar-ceros" class="nav-link" data-scroll-target="#revisar-cuántas-filas-quedan-tras-eliminar-ceros"><span class="header-section-number">2.13</span> Revisar cuántas filas quedan tras eliminar ceros</a></li>
  <li><a href="#filtrar-filas-con-target-válido-y-revisar-buques-con-secuencia-mínima" id="toc-filtrar-filas-con-target-válido-y-revisar-buques-con-secuencia-mínima" class="nav-link" data-scroll-target="#filtrar-filas-con-target-válido-y-revisar-buques-con-secuencia-mínima"><span class="header-section-number">2.14</span> Filtrar filas con target válido y revisar buques con secuencia mínima</a></li>
  <li><a href="#recorte-de-buques-por-secuencia-mínima" id="toc-recorte-de-buques-por-secuencia-mínima" class="nav-link" data-scroll-target="#recorte-de-buques-por-secuencia-mínima"><span class="header-section-number">2.15</span> Recorte de buques por secuencia mínima</a></li>
  <li><a href="#definir-vairables-de-entrada" id="toc-definir-vairables-de-entrada" class="nav-link" data-scroll-target="#definir-vairables-de-entrada"><span class="header-section-number">2.16</span> definir vairables de entrada</a></li>
  <li><a href="#features" id="toc-features" class="nav-link" data-scroll-target="#features"><span class="header-section-number">2.17</span> features</a></li>
  <li><a href="#ajustes-de-correlaciones" id="toc-ajustes-de-correlaciones" class="nav-link" data-scroll-target="#ajustes-de-correlaciones"><span class="header-section-number">2.18</span> ajustes de correlaciones</a></li>
  <li><a href="#features-test" id="toc-features-test" class="nav-link" data-scroll-target="#features-test"><span class="header-section-number">2.19</span> features test</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Green Maritime Corridors - Canal de Panamá</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Código</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Mostrar todo el código</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Ocultar todo el código</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Ver el código fuente</a></li></ul></div></div>
</div>

<div>
  <div class="description">
    Tráfico marítimo en el Canal de Panamá, análisis técnico operacional-temporal con separación de prueba externa.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Brandon Martínez </p>
          </div>
  </div>
    
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Resumen</div>
    <p>Este documento presenta un análisis de trayectorias marítimas a través del Canal de Panamá, incluyendo limpieza de datos, análisis exploratorio, análisis espacial H3 y modelado secuencial con LSTM para la predicción de emisiones de CO₂.</p>
  </div>
</div>


</header>


<p>quarto preview</p>
<section id="librerías-y-dependencias" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="librerías-y-dependencias"><span class="header-section-number">0.1</span> Librerías y dependencias</h2>
<div id="librerias" class="cell" data-message="false" data-execution_count="1">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> SelectKBest, f_regression</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="lectura-y-limpieza-inicial" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="lectura-y-limpieza-inicial"><span class="header-section-number">0.2</span> Lectura y limpieza inicial</h2>
<div id="lectura_limpieza_inicial" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lectura y limpieza inicial</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ruta_data <span class="op">=</span> <span class="vs">r"C:</span><span class="er">\</span><span class="vs">Users</span><span class="er">\</span><span class="vs">limco</span><span class="dv">\D</span><span class="vs">ocuments</span><span class="dv">\D</span><span class="vs">ATA_C</span><span class="dv">\s</span><span class="vs">ample_training</span><span class="dv">.</span><span class="vs">parquet"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df_raw <span class="op">=</span> pd.read_parquet(ruta_data, engine<span class="op">=</span><span class="st">'fastparquet'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpiar nombres de columnas</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>df_raw.columns <span class="op">=</span> (</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    df_raw.columns.<span class="bu">str</span>.strip()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                  .<span class="bu">str</span>.replace(<span class="st">' '</span>, <span class="st">'_'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                  .<span class="bu">str</span>.replace(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="pp">]</span><span class="vs">'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir columna de fecha</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">=</span> pd.to_datetime(df_raw[<span class="st">'first_dt_pos_utc'</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="partición-externa" class="level2" data-number="0.3">
<h2 data-number="0.3" class="anchored" data-anchor-id="partición-externa"><span class="header-section-number">0.3</span> Partición externa</h2>
<div id="particion_externa" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Partición externa</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>fecha_corte <span class="op">=</span> pd.to_datetime(<span class="st">'2019-06-01'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>train_val <span class="op">=</span> df_raw[df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">&lt;</span> fecha_corte].copy()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>test_ext  <span class="op">=</span> df_raw[df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">&gt;=</span> fecha_corte].copy()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="exploración-inicial-eda" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Exploración inicial (EDA)</h1>
<section id="resumen-de-train_val" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="resumen-de-train_val"><span class="header-section-number">1.1</span> Resumen de train_val</h2>
<div id="resumen_train_val" class="cell" data-message="false" data-execution_count="4">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cantidad de filas en train_val: </span><span class="sc">{</span><span class="bu">len</span>(train_val)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cantidad de columnas en train_val: </span><span class="sc">{</span><span class="bu">len</span>(train_val.columns)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad de filas en train_val: 27532
Cantidad de columnas en train_val: 46
</code></pre>
</div>
</div>
</section>
<section id="exploración-inicial-de-datos-sin-h3_sequence" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="exploración-inicial-de-datos-sin-h3_sequence"><span class="header-section-number">1.2</span> Exploración inicial de datos (sin h3_sequence)</h2>
<div id="exploracion_i" class="cell" data-message="false" data-execution_count="5">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas a mostrar (excluyendo 'h3_sequence')</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>cols_to_show <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_val.columns <span class="cf">if</span> c <span class="op">!=</span> <span class="st">'h3_sequence'</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar primeras filas</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(train_val[cols_to_show].head(<span class="dv">5</span>), headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+----+-----------+---------------------------+---------------------------+---------+---------------------+---------------------+---------------------------+------------------+--------------+-----------------+-----------------+------------------------+------------------+---------------------+----------------+--------------+--------------+---------+------------------+--------------+--------------------+---------------+-------+--------------+-------------------+---------+------------+----------------+------------------+-----------------+---------------------+---------------------+----------------------------+-----------------+------------------+------------------+-----------------------------+------------------+-----------------------+------------------------+----------+--------+----------+------------+-----------+
|    |      mmsi | start_leg                 | end_leg                   |   imo_x | ref_in              | ref_out             | port_before               | country_before   | port_after   | country_after   | op_phase        | StandardVesselType_x   |   GrossTonnage_x | first_dt_pos_utc    |     sum_me_ene |   sum_ae_ene |   sum_ab_ene |   imo_y |   GrossTonnage_y |   Deadweight |   LengthOverallLOA |   DateOfBuild |   TEU |   Powerkwmax | MainEngineModel   |   Speed |   Speedmax |   Speedservice |   BreadthExtreme |   SummerDraught |   FuelType1Capacity |   FuelType2Capacity |   LightDisplacementTonnage |   MainEngineRPM | MainEngineType   |   Powerkwservice | PropulsionType              | ShiptypeLevel5   |   TotalBunkerCapacity | StandardVesselType_y   |   imobin | fuel   | meType   |   ais_beam |   ais_loa |
|----+-----------+---------------------------+---------------------------+---------+---------------------+---------------------+---------------------------+------------------+--------------+-----------------+-----------------+------------------------+------------------+---------------------+----------------+--------------+--------------+---------+------------------+--------------+--------------------+---------------+-------+--------------+-------------------+---------+------------+----------------+------------------+-----------------+---------------------+---------------------+----------------------------+-----------------+------------------+------------------+-----------------------------+------------------+-----------------------+------------------------+----------+--------+----------+------------+-----------|
|  0 | 205681000 | 2019-02-10 22:02:21+00:00 | 2019-02-23 20:29:37+00:00 | 9659139 | 2019-02-18 08:16:03 | 2019-02-18 14:51:33 | BAHIA_QUINTERO_(VENTANAS) | CL               | PORT_ARANSAS | US              | Normal cruising | Liquified gas tanker   |            25143 | 2019-02-10 22:05:12 |    1.11291e+06 |  38922.9     |   16217.9    | 9659139 |            25143 |        28590 |              174   |        201501 |     0 |         8360 | 6S50ME-B9         |    16.8 |        0   |           16.8 |           30.03  |          10.3   |                 156 |                2083 |                      11354 |              99 | Oil              |                0 | Oil Engine(s), Direct Drive | LPG Tanker       |                  2239 | Liquified gas tanker   |        1 | HFO    | SSD      |         30 |       174 |
|  1 | 205681000 | 2019-02-10 22:02:21+00:00 | 2019-02-23 20:29:37+00:00 | 9659139 | 2019-02-18 08:16:03 | 2019-02-18 14:51:33 | BAHIA_QUINTERO_(VENTANAS) | CL               | PORT_ARANSAS | US              | Anchorage       | Liquified gas tanker   |            25143 | 2019-02-11 17:58:45 |    0           |   3169.8     |    2641.5    | 9659139 |            25143 |        28590 |              174   |        201501 |     0 |         8360 | 6S50ME-B9         |    16.8 |        0   |           16.8 |           30.03  |          10.3   |                 156 |                2083 |                      11354 |              99 | Oil              |                0 | Oil Engine(s), Direct Drive | LPG Tanker       |                  2239 | Liquified gas tanker   |        1 | HFO    | SSD      |         30 |       174 |
|  2 | 205681000 | 2019-02-10 22:02:21+00:00 | 2019-02-23 20:29:37+00:00 | 9659139 | 2019-02-18 08:16:03 | 2019-02-18 14:51:33 | BAHIA_QUINTERO_(VENTANAS) | CL               | PORT_ARANSAS | US              | Slow transit    | Liquified gas tanker   |            25143 | 2019-02-13 02:40:16 | 1107.73        |    390.467   |     162.694  | 9659139 |            25143 |        28590 |              174   |        201501 |     0 |         8360 | 6S50ME-B9         |    16.8 |        0   |           16.8 |           30.03  |          10.3   |                 156 |                2083 |                      11354 |              99 | Oil              |                0 | Oil Engine(s), Direct Drive | LPG Tanker       |                  2239 | Liquified gas tanker   |        1 | HFO    | SSD      |         30 |       174 |
|  3 | 205681000 | 2019-02-10 22:02:21+00:00 | 2019-02-23 20:29:37+00:00 | 9659139 | 2019-02-18 08:16:03 | 2019-02-18 14:51:33 | BAHIA_QUINTERO_(VENTANAS) | CL               | PORT_ARANSAS | US              | Manoeuvring     | Liquified gas tanker   |            25143 | 2019-02-18 07:50:28 |   17.5365      |     55.6     |      30.8889 | 9659139 |            25143 |        28590 |              174   |        201501 |     0 |         8360 | 6S50ME-B9         |    16.8 |        0   |           16.8 |           30.03  |          10.3   |                 156 |                2083 |                      11354 |              99 | Oil              |                0 | Oil Engine(s), Direct Drive | LPG Tanker       |                  2239 | Liquified gas tanker   |        1 | HFO    | SSD      |         30 |       174 |
|  4 | 205760000 | 2019-01-23 07:35:52+00:00 | 2019-03-11 03:18:59+00:00 | 9402017 | 2019-02-24 06:50:06 | 2019-02-24 13:36:16 | MIZUSHIMA_KO              | JP               | ST._JAMES    | US              | Normal cruising | Bulk carrier           |            30619 | 2019-02-08 20:55:45 |   18.9087      |      1.37222 |       0      | 9336983 |            79235 |       149876 |              274.2 |        200802 |     0 |        16440 | 6RTA72            |    12.3 |       15.4 |           12.3 |           48.041 |          16.022 |                 340 |                3830 |                      22770 |              94 | Oil              |                0 | Oil Engine(s), Direct Drive | Crude Oil Tanker |                  4170 | Oil tanker             |        7 | HFO    | SSD      |         48 |       274 |
+----+-----------+---------------------------+---------------------------+---------+---------------------+---------------------+---------------------------+------------------+--------------+-----------------+-----------------+------------------------+------------------+---------------------+----------------+--------------+--------------+---------+------------------+--------------+--------------------+---------------+-------+--------------+-------------------+---------+------------+----------------+------------------+-----------------+---------------------+---------------------+----------------------------+-----------------+------------------+------------------+-----------------------------+------------------+-----------------------+------------------------+----------+--------+----------+------------+-----------+</code></pre>
</div>
</div>
</section>
<section id="revisión-de-tipos-de-datos" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="revisión-de-tipos-de-datos"><span class="header-section-number">1.3</span> Revisión de tipos de datos</h2>
<div id="tipos_columnas" class="cell" data-message="false" data-execution_count="6">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>tipos <span class="op">=</span> train_val.dtypes.reset_index()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>tipos.columns <span class="op">=</span> [<span class="st">'Columna'</span>, <span class="st">'Tipo de dato'</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tipos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+----+--------------------------+---------------------+
|    | Columna                  | Tipo de dato        |
|----+--------------------------+---------------------|
|  0 | mmsi                     | int32               |
|  1 | start_leg                | datetime64[ns, UTC] |
|  2 | end_leg                  | datetime64[ns, UTC] |
|  3 | h3_sequence              | object              |
|  4 | imo_x                    | int32               |
|  5 | ref_in                   | datetime64[us]      |
|  6 | ref_out                  | datetime64[us]      |
|  7 | port_before              | object              |
|  8 | country_before           | object              |
|  9 | port_after               | object              |
| 10 | country_after            | object              |
| 11 | op_phase                 | object              |
| 12 | StandardVesselType_x     | object              |
| 13 | GrossTonnage_x           | int32               |
| 14 | first_dt_pos_utc         | datetime64[us]      |
| 15 | sum_me_ene               | float64             |
| 16 | sum_ae_ene               | float64             |
| 17 | sum_ab_ene               | float64             |
| 18 | imo_y                    | int32               |
| 19 | GrossTonnage_y           | int32               |
| 20 | Deadweight               | int32               |
| 21 | LengthOverallLOA         | float64             |
| 22 | DateOfBuild              | int32               |
| 23 | TEU                      | int32               |
| 24 | Powerkwmax               | float64             |
| 25 | MainEngineModel          | object              |
| 26 | Speed                    | float64             |
| 27 | Speedmax                 | float64             |
| 28 | Speedservice             | float64             |
| 29 | BreadthExtreme           | float64             |
| 30 | SummerDraught            | float64             |
| 31 | FuelType1Capacity        | float64             |
| 32 | FuelType2Capacity        | float64             |
| 33 | LightDisplacementTonnage | int32               |
| 34 | MainEngineRPM            | float64             |
| 35 | MainEngineType           | object              |
| 36 | Powerkwservice           | int32               |
| 37 | PropulsionType           | object              |
| 38 | ShiptypeLevel5           | object              |
| 39 | TotalBunkerCapacity      | float64             |
| 40 | StandardVesselType_y     | object              |
| 41 | imobin                   | int64               |
| 42 | fuel                     | object              |
| 43 | meType                   | object              |
| 44 | ais_beam                 | float64             |
| 45 | ais_loa                  | float64             |
+----+--------------------------+---------------------+</code></pre>
</div>
</div>
</section>
<section id="distribución-de-registros-por-buque" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="distribución-de-registros-por-buque"><span class="header-section-number">1.4</span> Distribución de registros por buque</h2>
<div id="eda_secuencias" class="cell" data-message="false" data-execution_count="7">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>tabla_freq <span class="op">=</span> registros_por_buque.value_counts().sort_index()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>tabla_freq_df <span class="op">=</span> tabla_freq.reset_index()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>tabla_freq_df.columns <span class="op">=</span> [<span class="st">"n_registros_por_buque"</span>, <span class="st">"n_buques"</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>tabla_freq_df <span class="op">=</span> tabla_freq_df.sort_values(by<span class="op">=</span><span class="st">"n_buques"</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>La tabla muestra que la mayoría de los buques tienen pocos registros, la mayor parte entre 1 y 5 pasos. Solo unos pocos buques tienen muchos registros (más de 50), lo que indica que unos pocos son muy activos mientras la mayoría realiza trayectorias cortas o tiene menos datos registrados</p>
<div id="a_secuencias" class="cell" data-message="false" data-execution_count="8">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Tabla de registros por buque ordenada por n_buques:"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_freq_df, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Tabla de registros por buque ordenada por n_buques:
+----+-------------------------+------------+
|    |   n_registros_por_buque |   n_buques |
|----+-------------------------+------------|
|  0 |                       4 |        588 |
|  1 |                       1 |        381 |
|  2 |                       5 |        380 |
|  3 |                       9 |        172 |
|  4 |                       2 |        166 |
|  5 |                       8 |        158 |
|  6 |                      10 |        123 |
|  7 |                       3 |         92 |
|  8 |                       6 |         65 |
|  9 |                      13 |         55 |
| 10 |                      15 |         39 |
| 11 |                      14 |         38 |
| 12 |                      18 |         36 |
| 13 |                       7 |         31 |
| 14 |                      17 |         28 |
| 15 |                      19 |         24 |
| 16 |                      12 |         24 |
| 17 |                      11 |         23 |
| 18 |                      16 |         19 |
| 19 |                      20 |         19 |
| 20 |                      25 |         17 |
| 21 |                      35 |         17 |
| 22 |                      21 |         14 |
| 23 |                      24 |         13 |
| 24 |                      39 |         12 |
| 25 |                      22 |         11 |
| 26 |                      30 |         11 |
| 27 |                      29 |         10 |
| 28 |                      32 |          8 |
| 29 |                      40 |          8 |
| 30 |                      41 |          7 |
| 31 |                      28 |          7 |
| 32 |                      23 |          7 |
| 33 |                      45 |          7 |
| 34 |                      27 |          6 |
| 35 |                      49 |          6 |
| 36 |                      33 |          6 |
| 37 |                      50 |          6 |
| 38 |                      55 |          6 |
| 39 |                      26 |          5 |
| 40 |                      38 |          5 |
| 41 |                      54 |          5 |
| 42 |                      44 |          5 |
| 43 |                      36 |          5 |
| 44 |                      31 |          4 |
| 45 |                      51 |          4 |
| 46 |                      48 |          4 |
| 47 |                      34 |          4 |
| 48 |                      42 |          4 |
| 49 |                      56 |          4 |
| 50 |                      71 |          4 |
| 51 |                      74 |          4 |
| 52 |                      57 |          3 |
| 53 |                      62 |          3 |
| 54 |                      65 |          3 |
| 55 |                      43 |          2 |
| 56 |                      59 |          2 |
| 57 |                      69 |          2 |
| 58 |                      60 |          2 |
| 59 |                      53 |          2 |
| 60 |                      37 |          2 |
| 61 |                      75 |          2 |
| 62 |                      81 |          2 |
| 63 |                      63 |          2 |
| 64 |                      87 |          2 |
| 65 |                      61 |          1 |
| 66 |                      58 |          1 |
| 67 |                      47 |          1 |
| 68 |                      52 |          1 |
| 69 |                      72 |          1 |
| 70 |                      70 |          1 |
| 71 |                      64 |          1 |
| 72 |                      77 |          1 |
| 73 |                      79 |          1 |
| 74 |                      80 |          1 |
| 75 |                      82 |          1 |
| 76 |                      66 |          1 |
| 77 |                      85 |          1 |
| 78 |                      86 |          1 |
| 79 |                      91 |          1 |
| 80 |                      94 |          1 |
| 81 |                      98 |          1 |
| 82 |                     100 |          1 |
| 83 |                     104 |          1 |
| 84 |                     110 |          1 |
| 85 |                     116 |          1 |
| 86 |                     122 |          1 |
| 87 |                     132 |          1 |
| 88 |                     137 |          1 |
| 89 |                     139 |          1 |
| 90 |                     149 |          1 |
| 91 |                     195 |          1 |
| 92 |                     240 |          1 |
+----+-------------------------+------------+</code></pre>
</div>
</div>
<section id="gráfico-de-distribución-de-registros-por-buque" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="gráfico-de-distribución-de-registros-por-buque"><span class="header-section-number">1.4.1</span> Gráfico de distribución de registros por buque</h3>
<div id="cell-eda_grafico" class="cell" data-message="false" data-execution_count="9">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>tabla_freq_df[<span class="st">'n_buques_acum'</span>] <span class="op">=</span> tabla_freq_df[<span class="st">'n_buques'</span>].cumsum()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>sns.barplot(</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>tabla_freq_df, </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'n_registros_por_buque'</span>, </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'n_buques'</span>, </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'steelblue'</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Número de registros por buque"</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Número de buques"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribución de registros por buque (train_val)"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/eda_grafico-output-1.png" id="eda_grafico" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="verificar-viajes-puertopuerto" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="verificar-viajes-puertopuerto"><span class="header-section-number">1.5</span> Verificar viajes puerto–puerto</h2>
<div id="eda_viajes_puerto" class="cell" data-message="false" data-execution_count="10">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>viajes_incompletos <span class="op">=</span> train_val[</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    train_val[<span class="st">'port_before'</span>].isna() <span class="op">|</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    train_val[<span class="st">'port_after'</span>].isna()  <span class="op">|</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (train_val[<span class="st">'port_before'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>])) <span class="op">|</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (train_val[<span class="st">'port_after'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>]))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cantidad de registros con viajes incompletos (puertos faltantes o desconocidos):"</span>, <span class="bu">len</span>(viajes_incompletos))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    viajes_incompletos[[<span class="st">'mmsi'</span>,<span class="st">'port_before'</span>,<span class="st">'port_after'</span>]].head(<span class="dv">10</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span><span class="st">'keys'</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    tablefmt<span class="op">=</span><span class="st">'psql'</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad de registros con viajes incompletos (puertos faltantes o desconocidos): 0
+--------+---------------+--------------+
| mmsi   | port_before   | port_after   |
|--------+---------------+--------------|
+--------+---------------+--------------+</code></pre>
</div>
</div>
<p><strong>“Todos los registros de viajes de puerto a puerto están completos; cada buque tiene correctamente registrado su puerto de salida y de llegada, sin información faltante ni desconocida.”</strong></p>
</section>
<section id="revisar-consumos-de-energía" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="revisar-consumos-de-energía"><span class="header-section-number">1.6</span> Revisar consumos de energía</h2>
<div id="eda_consumos" class="cell" data-message="false" data-execution_count="11">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cols_energia <span class="op">=</span> [<span class="st">'sum_me_ene'</span>,<span class="st">'sum_ae_ene'</span>,<span class="st">'sum_ab_ene'</span>]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>resumen_consumos <span class="op">=</span> []</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cols_energia:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    n_nulos <span class="op">=</span> train_val[col].isna().<span class="bu">sum</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    n_cero  <span class="op">=</span> (train_val[col] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    n_neg   <span class="op">=</span> (train_val[col] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    resumen_consumos.append([col, n_nulos, n_cero, n_neg])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e_consumos" class="cell" data-message="false" data-execution_count="12">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores nulos, cero y negativos en consumos:"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_consumos, headers<span class="op">=</span>[<span class="st">"Columna"</span>,<span class="st">"Nulos"</span>,<span class="st">"Ceros"</span>,<span class="st">"Negativos"</span>], tablefmt<span class="op">=</span><span class="st">"psql"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Valores nulos, cero y negativos en consumos:
+------------+---------+---------+-------------+
| Columna    |   Nulos |   Ceros |   Negativos |
|------------+---------+---------+-------------|
| sum_me_ene |      71 |   13973 |           0 |
| sum_ae_ene |       0 |    7513 |           0 |
| sum_ab_ene |       0 |   15753 |           0 |
+------------+---------+---------+-------------+</code></pre>
</div>
</div>
<p>Los consumos de energía son consistentes: ninguna columna tiene valores negativos, aunque <code>sum_me_ene</code> presenta 71 valores nulos y 13,973 registros con consumo cero, <code>sum_ae_ene</code> tiene 7,513 registros con consumo cero, y <code>sum_ab_ene</code> cuenta con 15,753 registros con consumo cero.</p>
<hr>
<div id="d_consumos" class="cell" data-message="false" data-execution_count="13">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Resumen estadístico de consumos energéticos:"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(train_val[cols_energia].describe().reset_index(), headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Resumen estadístico de consumos energéticos:
+----+---------+------------------+------------------+--------------+
|    | index   |       sum_me_ene |       sum_ae_ene |   sum_ab_ene |
|----+---------+------------------+------------------+--------------|
|  0 | count   |  27461           |  27532           |    27532     |
|  1 | mean    | 339900           |  33129.4         |     3261.32  |
|  2 | std     |      1.54909e+06 | 117658           |    14657.8   |
|  3 | min     |      0           |      0           |        0     |
|  4 | 25%     |      0           |      0           |        0     |
|  5 | 50%     |      0           |   1539.12        |        0     |
|  6 | 75%     |   7838.64        |  16867.7         |      542.319 |
|  7 | max     |      4.96151e+07 |      4.54976e+06 |   665954     |
+----+---------+------------------+------------------+--------------+</code></pre>
</div>
</div>
<p>Los consumos de energía varían mucho entre los registros. Muchos viajes registran cero consumo, mientras que unos pocos tienen consumos muy altos, lo que eleva el promedio. En general, la mayoría de los viajes usan poca energía, pero existen algunos casos con consumos significativamente mayores.</p>
</section>
<section id="duración-de-viajes-puertopuerto" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="duración-de-viajes-puertopuerto"><span class="header-section-number">1.7</span> Duración de viajes puerto–puerto</h2>
<div id="eda_duracion_viajes" class="cell" data-message="false" data-execution_count="14">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>mmsi_validos <span class="op">=</span> train_val[<span class="st">'mmsi'</span>].value_counts()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mmsi_validos <span class="op">=</span> mmsi_validos[mmsi_validos <span class="op">&gt;=</span> <span class="dv">12</span>].index</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_filtrado <span class="op">=</span> train_val[train_val[<span class="st">'mmsi'</span>].isin(mmsi_validos)].copy()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_viaje_horas'</span>] <span class="op">=</span> (</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> <span class="dv">3600</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>La duración de los tramos de viaje entre puertos varía mucho: van desde unas 44 horas hasta más de 2,000 horas, con la mayoría de los tramos entre 200 y 600 horas y un promedio de unas 430 horas</p>
<div id="duracion_horas" class="cell" data-message="false" data-execution_count="15">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Distribución de duración de viajes (horas):"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(df_filtrado[<span class="st">'duracion_viaje_horas'</span>].describe().reset_index(),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>               headers<span class="op">=</span>[<span class="st">'Métrica'</span>,<span class="st">'Valor'</span>],</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>               tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Distribución de duración de viajes (horas):
+----+-----------+------------+
|    | Métrica   |      Valor |
|----+-----------+------------|
|  0 | count     | 17389      |
|  1 | mean      |   429.841  |
|  2 | std       |   285.03   |
|  3 | min       |    43.9656 |
|  4 | 25%       |   202.708  |
|  5 | 50%       |   364.996  |
|  6 | 75%       |   604.001  |
|  7 | max       |  2087.47   |
+----+-----------+------------+</code></pre>
</div>
</div>
<p>La duración de los viajes varía ampliamente, desde unas 44 horas hasta más de 2,000 horas, con la mayoría de los viajes entre 200 y 600 horas y un promedio de aproximadamente 430 horas.</p>
<div id="eda_frecuencia_duracion_dias" class="cell" data-message="false" data-execution_count="16">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_viaje_dias'</span>] <span class="op">=</span> (</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>).astype(<span class="bu">int</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tabla_frec <span class="op">=</span> df_filtrado[<span class="st">'duracion_viaje_dias'</span>].value_counts().reset_index()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>tabla_frec.columns <span class="op">=</span> [<span class="st">'Duración (días)'</span>, <span class="st">'Cantidad de viajes'</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>tabla_frec <span class="op">=</span> tabla_frec.sort_values(<span class="st">'Cantidad de viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="duracion_dias" class="cell" data-message="false" data-execution_count="17">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frecuencia de duración de viajes (en días) ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Frecuencia de duración de viajes (en días) ordenada de mayor a menor cantidad de viajes:
+----+-------------------+----------------------+
|    |   Duración (días) |   Cantidad de viajes |
|----+-------------------+----------------------|
|  0 |                 6 |                 1084 |
|  1 |                 5 |                 1026 |
|  2 |                 7 |                  999 |
|  3 |                11 |                  825 |
|  4 |                15 |                  810 |
|  5 |                10 |                  682 |
|  6 |                12 |                  679 |
|  7 |                 9 |                  667 |
|  8 |                16 |                  645 |
|  9 |                 8 |                  638 |
| 10 |                 4 |                  547 |
| 11 |                26 |                  516 |
| 12 |                14 |                  515 |
| 13 |                27 |                  492 |
| 14 |                13 |                  488 |
| 15 |                23 |                  461 |
| 16 |                17 |                  411 |
| 17 |                18 |                  411 |
| 18 |                24 |                  407 |
| 19 |                25 |                  398 |
| 20 |                19 |                  382 |
| 21 |                29 |                  361 |
| 22 |                20 |                  356 |
| 23 |                28 |                  325 |
| 24 |                 3 |                  315 |
| 25 |                22 |                  306 |
| 26 |                30 |                  290 |
| 27 |                32 |                  279 |
| 28 |                21 |                  260 |
| 29 |                33 |                  254 |
| 30 |                31 |                  192 |
| 31 |                34 |                  138 |
| 32 |                35 |                  133 |
| 33 |                40 |                   94 |
| 34 |                61 |                   85 |
| 35 |                41 |                   77 |
| 36 |                39 |                   70 |
| 37 |                57 |                   66 |
| 38 |                36 |                   66 |
| 39 |                37 |                   64 |
| 40 |                38 |                   56 |
| 41 |                 2 |                   48 |
| 42 |                43 |                   48 |
| 43 |                45 |                   36 |
| 44 |                42 |                   36 |
| 45 |                52 |                   36 |
| 46 |                49 |                   28 |
| 47 |                47 |                   22 |
| 48 |                71 |                   21 |
| 49 |                59 |                   20 |
| 50 |                54 |                   18 |
| 51 |                68 |                   18 |
| 52 |                51 |                   18 |
| 53 |                46 |                   16 |
| 54 |                65 |                   13 |
| 55 |                66 |                   13 |
| 56 |                44 |                   13 |
| 57 |                74 |                   12 |
| 58 |                62 |                   11 |
| 59 |                72 |                   10 |
| 60 |                58 |                   10 |
| 61 |                48 |                   10 |
| 62 |                55 |                   10 |
| 63 |                56 |                    9 |
| 64 |                63 |                    9 |
| 65 |                64 |                    9 |
| 66 |                69 |                    9 |
| 67 |                53 |                    8 |
| 68 |                 1 |                    4 |
| 69 |                70 |                    2 |
| 70 |                86 |                    1 |
| 71 |                78 |                    1 |
+----+-------------------+----------------------+</code></pre>
</div>
</div>
<p>La mayoría de los tramos de viaje entre puertos duran entre 5 y 7 días, siendo 6 días el más frecuente. Sin embargo, también hay viajes mucho más largos, algunos de hasta 86 días, lo que muestra que mientras la mayoría de los tramos son relativamente cortos, existen casos con duraciones significativamente mayores</p>
<div id="eda_duracion_horas" class="cell" data-message="false" data-execution_count="18">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_filtrado <span class="op">=</span> df_filtrado[</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    df_filtrado[<span class="st">'port_before'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    df_filtrado[<span class="st">'port_after'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    (<span class="op">~</span>df_filtrado[<span class="st">'port_before'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>])) <span class="op">&amp;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    (<span class="op">~</span>df_filtrado[<span class="st">'port_after'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>]))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_horas'</span>] <span class="op">=</span> (</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> <span class="dv">3600</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas <span class="op">=</span> df_filtrado.groupby([<span class="st">'port_before'</span>,<span class="st">'port_after'</span>,<span class="st">'duracion_horas'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'cantidad_viajes'</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas <span class="op">=</span> tabla_frec_horas.sort_values(<span class="st">'cantidad_viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="on_horas" class="cell" data-message="false" data-execution_count="19">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas_top10 <span class="op">=</span> tabla_frec_horas.head(<span class="dv">10</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frecuencia de duración de viajes (horas) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec_horas_top10, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Frecuencia de duración de viajes (horas) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:
+------+-----------------+------------------+------------------+-------------------+
|      | port_before     | port_after       |   duracion_horas |   cantidad_viajes |
|------+-----------------+------------------+------------------+-------------------|
|  427 | CHIRIQUI_GRANDE | CHIRIQUI_GRANDE  |          568.726 |                74 |
| 1007 | MARIEL          | PUERTO_DE_HENCAN |         1476.04  |                65 |
| 1912 | SANTA_MARTA     | GEORGETOWN       |          814.829 |                49 |
|  423 | CHIRIQUI_GRANDE | CHIRIQUI_GRANDE  |          324.607 |                45 |
| 1238 | PAITA           | TAURANGA         |         1376.92  |                40 |
|  537 | EL_BOSQUE       | PUERTO_BOLIVAR   |          179.317 |                40 |
|  591 | FREEPORT        | KINGSTON         |          585.148 |                40 |
|  424 | CHIRIQUI_GRANDE | CHIRIQUI_GRANDE  |          397.629 |                39 |
| 1544 | PUERTO_CORTES   | MARIEL           |         1005.14  |                35 |
|  666 | GALVESTON       | PUERTO_BOLIVAR   |          431.959 |                25 |
+------+-----------------+------------------+------------------+-------------------+</code></pre>
</div>
</div>
<p>Los datos muestran los <strong>tramos de viaje más frecuentes entre puertos</strong> y su duración en horas. Por ejemplo, los viajes dentro de <strong>Chiriquí Grande</strong> son los más repetidos, con varias duraciones registradas (alrededor de 325–570 horas). Otros tramos frecuentes incluyen rutas como <strong>Mariel → Puerto de Hencan</strong> o <strong>Santa Marta → Georgetown</strong>, con duraciones más largas, entre 800 y 1,500 horas. Esto indica que algunos trayectos son recorridos muy a menudo, mientras que otros, aunque menos frecuentes, implican viajes más largos.</p>
<div id="eda_duracion_dias" class="cell" data-message="false" data-execution_count="20">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_dias'</span>] <span class="op">=</span> ((df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias <span class="op">=</span> df_filtrado.groupby([<span class="st">'port_before'</span>,<span class="st">'port_after'</span>,<span class="st">'duracion_dias'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'cantidad_viajes'</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias <span class="op">=</span> tabla_frec_dias.sort_values(<span class="st">'cantidad_viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="puerto" class="cell" data-message="false" data-execution_count="21">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias_top10 <span class="op">=</span> tabla_frec_dias.head(<span class="dv">10</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top 10 frecuencia de duración de viajes (días) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec_dias_top10, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Top 10 frecuencia de duración de viajes (días) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:
+------+------------------------------+------------------------------+-----------------+-------------------+
|      | port_before                  | port_after                   |   duracion_dias |   cantidad_viajes |
|------+------------------------------+------------------------------+-----------------+-------------------|
|  623 | MANZANILLO                   | KINGSTON                     |              10 |               206 |
| 1054 | PUERTO_SAN_ANTONIO           | FREEPORT                     |              11 |               165 |
|   39 | ANDRES_(ANDRES_LNG_TERMINAL) | BUENAVENTURA                 |               6 |               150 |
|  166 | BUENAVENTURA                 | ANDRES_(ANDRES_LNG_TERMINAL) |               5 |               137 |
|  911 | PUERTO_BOLIVAR               | ROTTERDAM                    |              16 |               136 |
|  985 | PUERTO_MARITIMO_DE_GUAYAQUIL | PUERTO_MARITIMO_DE_GUAYAQUIL |               5 |               134 |
| 1259 | TAURANGA                     | PHILADELPHIA                 |              26 |               131 |
|  695 | MIAMI                        | PUERTO_MARITIMO_DE_GUAYAQUIL |               7 |               124 |
| 1206 | SINES                        | MANZANILLO                   |              15 |               121 |
|    8 | ACAJUTLA                     | PAITA                        |               5 |               114 |
+------+------------------------------+------------------------------+-----------------+-------------------+</code></pre>
</div>
</div>
<p>Los datos muestran los <strong>trayectos puerto a puerto más frecuentes y su duración en días</strong>. Por ejemplo, el viaje <strong>Manzanillo → Kingston</strong> es el más común, con 206 registros y una duración de 10 días. Otros trayectos frecuentes incluyen <strong>Puerto San Antonio → Freeport</strong> (11 días) y <strong>Andrés LNG Terminal ↔︎ Buenaventura</strong> (5–6 días). Esto refleja que algunos recorridos son muy habituales, mientras que otros, aunque menos frecuentes, pueden durar hasta varias semanas.</p>
</section>
<section id="análisis-de-viajes-específicos-puertopuerto" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="análisis-de-viajes-específicos-puertopuerto"><span class="header-section-number">1.8</span> Análisis de viajes específicos puerto–puerto</h2>
<div id="eda_inspeccionar" class="cell" data-message="false" data-execution_count="22">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>puerto_inicio <span class="op">=</span> <span class="st">"MANZANILLO"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>puerto_fin    <span class="op">=</span> <span class="st">"KINGSTON"</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>dias_viaje    <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>viajes_filtrados <span class="op">=</span> df_filtrado[</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'port_before'</span>] <span class="op">==</span> puerto_inicio) <span class="op">&amp;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'port_after'</span>] <span class="op">==</span> puerto_fin) <span class="op">&amp;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    (((df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)).astype(<span class="bu">int</span>) <span class="op">==</span> dias_viaje)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>resumen_mmsi <span class="op">=</span> viajes_filtrados.groupby(<span class="st">'mmsi'</span>).size().reset_index(name<span class="op">=</span><span class="st">'registros_viaje'</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Barcos que hicieron el viaje </span><span class="sc">{</span>puerto_inicio<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>puerto_fin<span class="sc">}</span><span class="ss"> en </span><span class="sc">{</span>dias_viaje<span class="sc">}</span><span class="ss"> días:"</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_mmsi, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Barcos que hicieron el viaje MANZANILLO -&gt; KINGSTON en 10 días:
+----+-------------+-------------------+
|    |        mmsi |   registros_viaje |
|----+-------------+-------------------|
|  0 | 2.18643e+08 |                30 |
|  1 | 2.48426e+08 |                15 |
|  2 | 2.48473e+08 |                16 |
|  3 | 2.56937e+08 |                30 |
|  4 | 2.56938e+08 |                14 |
|  5 | 2.5694e+08  |                15 |
|  6 | 2.56968e+08 |                25 |
|  7 | 5.38006e+08 |                20 |
|  8 | 5.6695e+08  |                11 |
|  9 | 6.36016e+08 |                30 |
+----+-------------+-------------------+</code></pre>
</div>
</div>
<p>El análisis muestra qué barcos realizaron el trayecto <strong>Manzanillo → Kingston en exactamente 10 días</strong>. Por ejemplo, algunos barcos completaron el viaje varias veces, con registros que van de 11 a 30 tramos por barco. Esto indica que hay rutas muy recurrentes y que ciertos buques realizan este viaje de manera repetida dentro del periodo analizado.</p>
</section>
<section id="cuántos-buques-tienen-secuencias" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="cuántos-buques-tienen-secuencias"><span class="header-section-number">1.9</span> Cuántos buques tienen secuencias</h2>
<div id="n_buques" class="cell" data-message="false" data-execution_count="23">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">20</span>]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>resumen_secuencias <span class="op">=</span> []</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>total_buques <span class="op">=</span> <span class="bu">len</span>(registros_por_buque)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> l <span class="kw">in</span> longitudes:</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> (registros_por_buque <span class="op">&gt;=</span> l).<span class="bu">sum</span>()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    porcentaje <span class="op">=</span> n_buques <span class="op">/</span> total_buques <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    resumen_secuencias.append([l, n_buques, porcentaje])</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>resumen_df <span class="op">=</span> pd.DataFrame(resumen_secuencias, columns<span class="op">=</span>[<span class="st">'Min Registros'</span>, <span class="st">'N° Buques'</span>, <span class="st">'Porcentaje (%)'</span>])</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(resumen_df)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min Registros  N° Buques  Porcentaje (%)
0              1       2754      100.000000
1              5       1527       55.446623
2             10        721       26.180102
3             12        575       20.878722
4             15        458       16.630356
5             20        312       11.328976</code></pre>
</div>
</div>
<p>El análisis muestra <strong>cuántos buques tienen distintos niveles de registros en los datos</strong>. Todos los buques (2,754) aparecen al menos una vez, pero conforme pedimos más registros por buque, el número disminuye: alrededor de la mitad tiene 5 o más registros, un cuarto tiene 10 o más, y solo un pequeño grupo (11 %) tiene 20 o más registros. Esto indica que mientras muchos buques aparecen pocas veces, algunos cuentan con series de datos más largas y consistentes.</p>
<div id="registros_por" class="cell" data-message="false" data-execution_count="24">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">15</span>]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> longitudes:</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> (registros_por_buque <span class="op">&gt;=</span> n).<span class="bu">sum</span>()</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Buques con al menos </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> registros: </span><span class="sc">{</span>n_buques<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buques con al menos 5 registros: 1527
Buques con al menos 6 registros: 1147
Buques con al menos 12 registros: 575
Buques con al menos 15 registros: 458</code></pre>
</div>
</div>
<div id="registros_por_buque" class="cell" data-message="false" data-execution_count="25">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [ <span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>, <span class="dv">12</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> longitudes:</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    buques_validos <span class="op">=</span> registros_por_buque[registros_por_buque <span class="op">&gt;=</span> n].index</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    df_filtrado <span class="op">=</span> train_val[train_val[<span class="st">'mmsi'</span>].isin(buques_validos)]</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    n_filas <span class="op">=</span> <span class="bu">len</span>(df_filtrado)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> <span class="bu">len</span>(buques_validos)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Secuencia </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>n_buques<span class="sc">}</span><span class="ss"> buques, </span><span class="sc">{</span>n_filas<span class="sc">}</span><span class="ss"> filas"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Secuencia 3: 2207 buques, 26819 filas
Secuencia 4: 2115 buques, 26543 filas
Secuencia 5: 1527 buques, 24191 filas
Secuencia 6: 1147 buques, 22291 filas
Secuencia 7: 1082 buques, 21901 filas
Secuencia 8: 1051 buques, 21684 filas
Secuencia 12: 575 buques, 17389 filas</code></pre>
</div>
</div>
</section>
<section id="creación-de-la-variable-objetivo-co2_emission" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="creación-de-la-variable-objetivo-co2_emission"><span class="header-section-number">1.10</span> Creación de la variable objetivo: CO2_emission</h2>
<div id="crear_target_emisiones" class="cell" data-message="false" data-execution_count="26">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crear_target_emisiones(df, sfoc_me<span class="op">=</span><span class="fl">0.2</span>, sfoc_ae<span class="op">=</span><span class="fl">0.22</span>, sfoc_ab<span class="op">=</span><span class="fl">0.25</span>, factor_emision<span class="op">=</span><span class="fl">3.17</span>):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_me'</span>] <span class="op">=</span> df[<span class="st">'sum_me_ene'</span>] <span class="op">*</span> sfoc_me</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_ae'</span>] <span class="op">=</span> df[<span class="st">'sum_ae_ene'</span>] <span class="op">*</span> sfoc_ae</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_ab'</span>] <span class="op">=</span> df[<span class="st">'sum_ab_ene'</span>] <span class="op">*</span> sfoc_ab</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'fuel_consumption'</span>] <span class="op">=</span> df[<span class="st">'combustible_me'</span>] <span class="op">+</span> df[<span class="st">'combustible_ae'</span>] <span class="op">+</span> df[<span class="st">'combustible_ab'</span>]</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CO2_emission'</span>] <span class="op">=</span> df[<span class="st">'fuel_consumption'</span>] <span class="op">*</span> factor_emision</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="target_emisiones" class="cell" data-message="false" data-execution_count="27">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> crear_target_emisiones(train_val)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">'CO2_emission'</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="bloque-1-ver-ceros-en-co2_emission" class="level3" data-number="1.10.1">
<h3 data-number="1.10.1" class="anchored" data-anchor-id="bloque-1-ver-ceros-en-co2_emission"><span class="header-section-number">1.10.1</span> <strong>Bloque 1: Ver ceros en CO2_emission</strong></h3>
<div id="inspeccionar_ceros" class="cell" data-message="false" data-execution_count="28">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar ceros en la variable objetivo</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>ceros_target <span class="op">=</span> (train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>porc_ceros <span class="op">=</span> ceros_target <span class="op">/</span> <span class="bu">len</span>(train_val_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Registros con CO2_emission = 0: </span><span class="sc">{</span>ceros_target<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>porc_ceros<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspeccionar algunos registros con cero</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Primeros registros con CO2_emission = 0:"</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_val_filtrado[train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>].head())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Registros con CO2_emission = 0: 7500 (27.24%)

Primeros registros con CO2_emission = 0:
         mmsi                 start_leg                   end_leg  \
32  232013522 2019-01-19 05:34:50+00:00 2019-02-15 03:45:41+00:00   
34  232013522 2019-01-19 05:34:50+00:00 2019-02-15 03:45:41+00:00   
36  232013522 2019-01-19 05:34:50+00:00 2019-02-15 03:45:41+00:00   
38  232013522 2019-01-19 05:34:50+00:00 2019-02-15 03:45:41+00:00   
40  232013522 2019-04-06 02:54:28+00:00 2019-05-03 09:04:38+00:00   

                                          h3_sequence    imo_x  \
32  [582173814721347583, 582314552209702911, 58278...  9362401   
34  [582173814721347583, 582314552209702911, 58278...  9362401   
36  [582173814721347583, 582314552209702911, 58278...  9362401   
38  [582173814721347583, 582314552209702911, 58278...  9362401   
40  [581720815930703871, 582173814721347583, 58231...  9362401   

                ref_in             ref_out port_before country_before  \
32 2019-01-25 14:28:08 2019-01-25 21:54:15  CHARLESTON             US   
34 2019-01-25 14:28:08 2019-01-25 21:54:15  CHARLESTON             US   
36 2019-01-25 14:28:08 2019-01-25 21:54:15  CHARLESTON             US   
38 2019-01-25 14:28:08 2019-01-25 21:54:15  CHARLESTON             US   
40 2019-04-12 15:01:40 2019-04-12 22:53:59  CHARLESTON             US   

   port_after  ... imobin fuel meType  ais_beam ais_loa  combustible_me  \
32   TAURANGA  ...      4  HFO    SSD      32.0   254.0             0.0   
34   TAURANGA  ...      4  HFO    SSD      32.0   254.0             0.0   
36   TAURANGA  ...      4  HFO    SSD      32.0   254.0             0.0   
38   TAURANGA  ...      4  HFO    SSD      32.0   254.0             0.0   
40   TAURANGA  ...      4  HFO    SSD      32.0   254.0             0.0   

    combustible_ae  combustible_ab  fuel_consumption  CO2_emission  
32             0.0             0.0               0.0           0.0  
34             0.0             0.0               0.0           0.0  
36             0.0             0.0               0.0           0.0  
38             0.0             0.0               0.0           0.0  
40             0.0             0.0               0.0           0.0  

[5 rows x 51 columns]</code></pre>
</div>
</div>
<div id="mmsi_con_ceros" class="cell" data-message="false" data-execution_count="29">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar registros con CO2_emission = 0</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>df_ceros <span class="op">=</span> train_val_filtrado[train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuántos MMSI distintos tienen registros con cero</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>mmsi_ceros <span class="op">=</span> df_ceros[<span class="st">'mmsi'</span>].nunique()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Número de buques (mmsi) con al menos un CO2_emission = 0: </span><span class="sc">{</span>mmsi_ceros<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar registros con cero por buque</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>registros_ceros_por_mmsi <span class="op">=</span> df_ceros.groupby(<span class="st">'mmsi'</span>).size().reset_index(name<span class="op">=</span><span class="st">'registros_cero'</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Registros con CO2_emission = 0 por buque (top 10):"</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(registros_ceros_por_mmsi.sort_values(<span class="st">'registros_cero'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Número de buques (mmsi) con al menos un CO2_emission = 0: 797

Registros con CO2_emission = 0 por buque (top 10):
          mmsi  registros_cero
317  370120000             209
638  563587000             125
620  563058900              88
746  636017164              75
325  370837000              71
21   212917000              66
483  477711300              63
10   210159000              61
619  563056800              60
669  566278000              58</code></pre>
</div>
</div>
<div id="mmsi_con_ceros_todos" class="cell" data-message="false" data-execution_count="30">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(registros_ceros_por_mmsi.sort_values(<span class="st">'registros_cero'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          mmsi  registros_cero
317  370120000             209
638  563587000             125
620  563058900              88
746  636017164              75
325  370837000              71
..         ...             ...
105  244870440               1
428  477013200               1
429  477027400               1
430  477030800               1
5    209393000               1

[797 rows x 2 columns]</code></pre>
</div>
</div>
<div id="resumen_mmsi_ceros" class="cell" data-message="false" data-execution_count="31">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Total de buques únicos</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>total_mmsi <span class="op">=</span> train_val_filtrado[<span class="st">'mmsi'</span>].nunique()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Buques con al menos un cero</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>mmsi_con_ceros <span class="op">=</span> train_val_filtrado.loc[train_val_filtrado[<span class="st">'CO2_emission'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'mmsi'</span>].nunique()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Buques sin ceros</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>mmsi_sin_ceros <span class="op">=</span> total_mmsi <span class="op">-</span> mmsi_con_ceros</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Armar tabla resumen</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>resumen_mmsi <span class="op">=</span> pd.DataFrame({</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grupo"</span>: [<span class="st">"Con ceros"</span>, <span class="st">"Sin ceros"</span>],</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"count_mmsi"</span>: [mmsi_con_ceros, mmsi_sin_ceros],</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"porcentaje"</span>: [mmsi_con_ceros<span class="op">/</span>total_mmsi<span class="op">*</span><span class="dv">100</span>, mmsi_sin_ceros<span class="op">/</span>total_mmsi<span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total buques únicos (mmsi): </span><span class="sc">{</span>total_mmsi<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(resumen_mmsi.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{<span class="st">"porcentaje"</span>: <span class="st">"</span><span class="sc">{:.2f}</span><span class="st">%"</span>.<span class="bu">format</span>}))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total buques únicos (mmsi): 2754

    grupo  count_mmsi porcentaje
Con ceros         797     28.94%
Sin ceros        1957     71.06%</code></pre>
</div>
</div>
<p>casi 3 de cada 10 buques pasan por situaciones de “cero emisiones” (posible parada, fondeo, error o falta de consumo registrado).</p>
</section>
<section id="eliminar-registros-con-cero" class="level3" data-number="1.10.2">
<h3 data-number="1.10.2" class="anchored" data-anchor-id="eliminar-registros-con-cero"><span class="header-section-number">1.10.2</span> <strong>Eliminar registros con cero</strong></h3>
<div id="eliminar_ceros" class="cell" data-message="false" data-execution_count="32">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar filas donde CO2_emission es cero</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> train_val_filtrado[train_val_filtrado[target] <span class="op">!=</span> <span class="dv">0</span>].copy()</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después de eliminar ceros en CO2_emission: </span><span class="sc">{</span><span class="bu">len</span>(train_val_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Filas después de eliminar ceros en CO2_emission: 20032</code></pre>
</div>
</div>
</section>
</section>
<section id="limpieza-de-nan-en-target-y-verificación-de-secuencias-mínimas" class="level2" data-number="1.11">
<h2 data-number="1.11" class="anchored" data-anchor-id="limpieza-de-nan-en-target-y-verificación-de-secuencias-mínimas"><span class="header-section-number">1.11</span> Limpieza de NaN en target y verificación de secuencias mínimas</h2>
<div id="limpieza_nan_target" class="cell" data-message="false" data-execution_count="33">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar filas donde CO2_emission es NaN</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>train_val_target <span class="op">=</span> train_val_filtrado[train_val_filtrado[target].notna()].copy()</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">4</span>  <span class="co"># longitud mínima de secuencia</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar buques válidos antes y después de eliminar NaN</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>registros_por_buque_orig <span class="op">=</span> train_val_filtrado.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>buques_validos_orig <span class="op">=</span> (registros_por_buque_orig <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>registros_por_buque_filtrado <span class="op">=</span> train_val_target.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>buques_validos_filtrado <span class="op">=</span> (registros_por_buque_filtrado <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>resumen <span class="op">=</span> pd.DataFrame({</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'Original'</span>, <span class="st">'Filtrado por target'</span>],</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Buques válidos'</span>: [buques_validos_orig, buques_validos_filtrado],</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(train_val_filtrado), <span class="bu">len</span>(train_val_target)]</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+----+---------------------+------------------+-----------------+
|    | Dataset             |   Buques válidos |   Filas totales |
|----+---------------------+------------------+-----------------|
|  0 | Original            |             2086 |           20032 |
|  1 | Filtrado por target |             2074 |           19961 |
+----+---------------------+------------------+-----------------+</code></pre>
</div>
</div>
<p>Al filtrar los valores faltantes, quedarán 19,961 registros y 2,074 buques válidos. Esto significará que se habrán eliminado 71 registros individuales y 12 buques completos que ya no tendrán suficientes datos para formar secuencias mínimas.</p>
</section>
<section id="recorte-de-buques-que-no-cumplen-la-longitud-mínima" class="level2" data-number="1.12">
<h2 data-number="1.12" class="anchored" data-anchor-id="recorte-de-buques-que-no-cumplen-la-longitud-mínima"><span class="header-section-number">1.12</span> Recorte de buques que no cumplen la longitud mínima</h2>
<div id="recorte_buques_min" class="cell" data-message="false" data-execution_count="34">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para filtrar buques por cantidad mínima de registros</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filtrar_buques_por_min_registros(df, min_registros<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    registros_por_buque <span class="op">=</span> df.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    buques_validos <span class="op">=</span> registros_por_buque[registros_por_buque <span class="op">&gt;=</span> min_registros].index</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[df[<span class="st">'mmsi'</span>].isin(buques_validos)].copy()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="recorte_buques" class="cell" data-message="false" data-execution_count="35">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> filtrar_buques_por_min_registros(train_val_target, min_registros<span class="op">=</span>seq_len)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después del recorte por secuencia mínima: </span><span class="sc">{</span><span class="bu">len</span>(train_val_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Filas después del recorte por secuencia mínima: 19140</code></pre>
</div>
</div>
</section>
<section id="valores-nulos" class="level2" data-number="1.13">
<h2 data-number="1.13" class="anchored" data-anchor-id="valores-nulos"><span class="header-section-number">1.13</span> valores nulos</h2>
<div id="valores_nulos" class="cell" data-message="false" data-execution_count="36">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>nulos_por_col <span class="op">=</span> train_val_filtrado.isnull().<span class="bu">sum</span>()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>nulos_filtrados <span class="op">=</span> nulos_por_col[nulos_por_col <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>resumen_nulos <span class="op">=</span> pd.DataFrame({</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Columna'</span>: nulos_filtrados.index,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Valores nulos'</span>: nulos_filtrados.values,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Porcentaje nulos (%)'</span>: nulos_filtrados <span class="op">/</span> <span class="bu">len</span>(train_val_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>}).sort_values(by<span class="op">=</span><span class="st">'Porcentaje nulos (%)'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_nulos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'grid'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------------+-----------------+------------------------+
| Columna             |   Valores nulos |   Porcentaje nulos (%) |
+=====================+=================+========================+
| TotalBunkerCapacity |            3205 |             16.745     |
+---------------------+-----------------+------------------------+
| MainEngineRPM       |             161 |              0.84117   |
+---------------------+-----------------+------------------------+
| FuelType1Capacity   |              96 |              0.501567  |
+---------------------+-----------------+------------------------+
| ais_loa             |               4 |              0.0208986 |
+---------------------+-----------------+------------------------+</code></pre>
</div>
</div>
<div id="filas_train_val_filtrado" class="cell" data-message="false" data-execution_count="37">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un pequeño DataFrame resumen</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>resumen_filas <span class="op">=</span> pd.DataFrame({</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'train_val_filtrado'</span>],</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(train_val_filtrado)]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir en formato tabulate</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_filas, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-----------------+
| Dataset            |   Filas totales |
|--------------------+-----------------|
| train_val_filtrado |           19140 |
+--------------------+-----------------+</code></pre>
</div>
</div>
<p>Después de aplicar los filtros sobre el conjunto de datos, se eliminarán los registros con valores nulos en la variable objetivo CO2_emission y aquellos donde esta sea igual a cero. Tras estas operaciones, el dataset train_val_filtrado contendrá 19,140 filas, correspondientes a los buques que cumplen con los criterios mínimos de secuencia. Esto permitirá que los análisis y modelos posteriores se enfoquen únicamente en datos válidos y consistentes.</p>
</section>
<section id="partición-interna" class="level2" data-number="1.14">
<h2 data-number="1.14" class="anchored" data-anchor-id="partición-interna"><span class="header-section-number">1.14</span> Partición interna</h2>
<div id="particion_interna" class="cell" data-message="false" data-execution_count="38">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir X (features) y y (target)</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> train_val_filtrado.drop(columns<span class="op">=</span>[target])</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> train_val_filtrado[target]</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Partición interna: entrenamiento interno y validación interna</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>X_train_int, X_val_int, y_train_int, y_val_int <span class="op">=</span> train_test_split(</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    X, y,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.2</span>,      <span class="co"># 20% para validación interna</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span>,    <span class="co"># para reproducibilidad</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño X_train_int: </span><span class="sc">{</span>X_train_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño X_val_int: </span><span class="sc">{</span>X_val_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño y_train_int: </span><span class="sc">{</span>y_train_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño y_val_int: </span><span class="sc">{</span>y_val_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tamaño X_train_int: (15312, 50)
Tamaño X_val_int: (3828, 50)
Tamaño y_train_int: (15312,)
Tamaño y_val_int: (3828,)</code></pre>
</div>
</div>
<section id="definición-de-la-función-de-imputación" class="level3" data-number="1.14.1">
<h3 data-number="1.14.1" class="anchored" data-anchor-id="definición-de-la-función-de-imputación"><span class="header-section-number">1.14.1</span> Definición de la función de imputación</h3>
<div id="imputacion_def" class="cell" data-message="false" data-execution_count="39">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> imputar_datos(df, columnas_numericas, columnas_categoricas, flags_nulos<span class="op">=</span><span class="va">None</span>, medianas<span class="op">=</span><span class="va">None</span>, modas<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Imputa valores faltantes en un DataFrame.</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame a imputar.</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co">        columnas_numericas (list): Columnas numéricas a imputar con mediana.</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co">        columnas_categoricas (list): Columnas categóricas a imputar con moda.</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">        flags_nulos (list, optional): Columnas para crear flag de valores nulos originales.</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">        medianas (dict, optional): Median values para usar (train stats).</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co">        modas (dict, optional): Moda values para usar (train stats).</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="co">        df_imputado (pd.DataFrame): DataFrame imputado.</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co">        medianas (dict): Median values calculadas si no se pasan.</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="co">        modas (dict): Moda values calculadas si no se pasan.</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    df_imputado <span class="op">=</span> df.copy()</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crear flags de nulos</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> flags_nulos:</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> flags_nulos:</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>            df_imputado[<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_is_missing"</span>] <span class="op">=</span> df_imputado[col].isna().astype(<span class="bu">int</span>)</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Si no vienen medianas y modas, calcular a partir del df actual</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> medianas <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>        medianas <span class="op">=</span> {col: df_imputado[col].median() <span class="cf">for</span> col <span class="kw">in</span> columnas_numericas}</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> modas <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>        modas <span class="op">=</span> {col: df_imputado[col].mode()[<span class="dv">0</span>] <span class="cf">for</span> col <span class="kw">in</span> columnas_categoricas}</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputar columnas numéricas</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columnas_numericas:</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>        df_imputado[col] <span class="op">=</span> df_imputado[col].fillna(medianas[col])</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputar columnas categóricas</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columnas_categoricas:</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>        df_imputado[col] <span class="op">=</span> df_imputado[col].fillna(modas[col])</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_imputado, medianas, modas</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="aplicación-en-training-entrenamiento-interno" class="level3" data-number="1.14.2">
<h3 data-number="1.14.2" class="anchored" data-anchor-id="aplicación-en-training-entrenamiento-interno"><span class="header-section-number">1.14.2</span> Aplicación en training (entrenamiento interno)</h3>
<div id="imputacion_columnas" class="cell" data-message="false" data-execution_count="40">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>columnas_num <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>, <span class="st">'MainEngineRPM'</span>, <span class="st">'FuelType1Capacity'</span>, <span class="st">'ais_loa'</span>]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>flags <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>]  <span class="co"># opcional si quieres marcar dónde estaban los nulos</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>columnas_cat <span class="op">=</span> []  <span class="co"># No hay columnas categóricas con nulos</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="imputacion_train" class="cell" data-message="false" data-execution_count="41">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>X_train_int_imputado, medianas, modas <span class="op">=</span> imputar_datos(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    X_train_int,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="aplicación-en-validación" class="level3" data-number="1.14.3">
<h3 data-number="1.14.3" class="anchored" data-anchor-id="aplicación-en-validación"><span class="header-section-number">1.14.3</span> Aplicación en validación</h3>
<div id="imputacion_val" class="cell" data-message="false" data-execution_count="42">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>X_val_int_imputado, _, _ <span class="op">=</span> imputar_datos(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    X_val_int,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    medianas<span class="op">=</span>medianas,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    modas<span class="op">=</span>modas</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="creación-de-features-feature-engineering" class="level2" data-number="1.15">
<h2 data-number="1.15" class="anchored" data-anchor-id="creación-de-features-feature-engineering"><span class="header-section-number">1.15</span> creación de features (feature engineering)</h2>
<div id="crear_features_def" class="cell" data-message="false" data-execution_count="43">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crear_features(df):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Crea nuevas variables/features a partir de un DataFrame imputado.</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Variables creadas:</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">        - duration_min: duración entre posiciones consecutivas por buque</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_puerto: identificador de viaje basado en cambio de puerto</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_gap: identificador de viaje basado en gaps de tiempo</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_leg: identificador de viaje basado en start_leg y end_leg</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">        - frecuencia_puerto: número de veces que un puerto aparece como port_after por buque</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame imputado con columnas necesarias (fechas, puertos, leg info)</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: DataFrame con las nuevas features</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ordenar por buque y tiempo</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(by<span class="op">=</span>[<span class="st">'mmsi'</span>,<span class="st">'first_dt_pos_utc'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># duration_min</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'duration_min'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'first_dt_pos_utc'</span>].diff().dt.total_seconds() <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'duration_min'</span>] <span class="op">=</span> df[<span class="st">'duration_min'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_puerto</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_change_puerto'</span>] <span class="op">=</span> (</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">'port_before'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'port_before'</span>].shift(<span class="dv">1</span>)) <span class="op">|</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">'port_after'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'port_after'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_puerto'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'viaje_change_puerto'</span>].cumsum()</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">'viaje_change_puerto'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_gap</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>    umbral_gap <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_change_gap'</span>] <span class="op">=</span> (df[<span class="st">'duration_min'</span>] <span class="op">&gt;</span> umbral_gap).astype(<span class="bu">int</span>)</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_gap'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'viaje_change_gap'</span>].cumsum()</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">'viaje_change_gap'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_leg</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_leg'</span>] <span class="op">=</span> ((df[<span class="st">'start_leg'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'start_leg'</span>].shift(<span class="dv">1</span>)) <span class="op">|</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>                       (df[<span class="st">'end_leg'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'end_leg'</span>].shift(<span class="dv">1</span>))).cumsum()</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># frecuencia_puerto</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    freq_puerto <span class="op">=</span> df.groupby([<span class="st">'mmsi'</span>,<span class="st">'port_after'</span>]).size().rename(<span class="st">'frecuencia_puerto'</span>)</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(freq_puerto, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'mmsi'</span>,<span class="st">'port_after'</span>])</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="aplicación-a-entrenamiento-interno" class="level3" data-number="1.15.1">
<h3 data-number="1.15.1" class="anchored" data-anchor-id="aplicación-a-entrenamiento-interno"><span class="header-section-number">1.15.1</span> Aplicación a entrenamiento interno</h3>
<div id="crear_features_train" class="cell" data-message="false" data-execution_count="44">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>X_train_int_features <span class="op">=</span> crear_features(X_train_int_imputado)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="aplicación-a-validación-interna" class="level3" data-number="1.15.2">
<h3 data-number="1.15.2" class="anchored" data-anchor-id="aplicación-a-validación-interna"><span class="header-section-number">1.15.2</span> Aplicación a validación interna</h3>
<div id="crear_features_val" class="cell" data-message="false" data-execution_count="45">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>X_val_int_features <span class="op">=</span> crear_features(X_val_int_imputado)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="vista" class="level3" data-number="1.15.3">
<h3 data-number="1.15.3" class="anchored" data-anchor-id="vista"><span class="header-section-number">1.15.3</span> vista</h3>
<div id="resumen_variables" class="cell" data-message="false" data-execution_count="46">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrame de ejemplo: X_train_int_imputado</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> X_train_int_imputado.copy()</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear lista de variables y su tipo</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>variable_tipo <span class="op">=</span> [(col, <span class="bu">str</span>(df[col].dtype)) <span class="cf">for</span> col <span class="kw">in</span> df.columns]</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar en formato tabulate</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(variable_tipo, headers<span class="op">=</span>[<span class="st">'Variable'</span>, <span class="st">'Tipo'</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------------------+---------------------+
| Variable                       | Tipo                |
+================================+=====================+
| mmsi                           | int32               |
+--------------------------------+---------------------+
| start_leg                      | datetime64[ns, UTC] |
+--------------------------------+---------------------+
| end_leg                        | datetime64[ns, UTC] |
+--------------------------------+---------------------+
| h3_sequence                    | object              |
+--------------------------------+---------------------+
| imo_x                          | int32               |
+--------------------------------+---------------------+
| ref_in                         | datetime64[us]      |
+--------------------------------+---------------------+
| ref_out                        | datetime64[us]      |
+--------------------------------+---------------------+
| port_before                    | object              |
+--------------------------------+---------------------+
| country_before                 | object              |
+--------------------------------+---------------------+
| port_after                     | object              |
+--------------------------------+---------------------+
| country_after                  | object              |
+--------------------------------+---------------------+
| op_phase                       | object              |
+--------------------------------+---------------------+
| StandardVesselType_x           | object              |
+--------------------------------+---------------------+
| GrossTonnage_x                 | int32               |
+--------------------------------+---------------------+
| first_dt_pos_utc               | datetime64[us]      |
+--------------------------------+---------------------+
| sum_me_ene                     | float64             |
+--------------------------------+---------------------+
| sum_ae_ene                     | float64             |
+--------------------------------+---------------------+
| sum_ab_ene                     | float64             |
+--------------------------------+---------------------+
| imo_y                          | int32               |
+--------------------------------+---------------------+
| GrossTonnage_y                 | int32               |
+--------------------------------+---------------------+
| Deadweight                     | int32               |
+--------------------------------+---------------------+
| LengthOverallLOA               | float64             |
+--------------------------------+---------------------+
| DateOfBuild                    | int32               |
+--------------------------------+---------------------+
| TEU                            | int32               |
+--------------------------------+---------------------+
| Powerkwmax                     | float64             |
+--------------------------------+---------------------+
| MainEngineModel                | object              |
+--------------------------------+---------------------+
| Speed                          | float64             |
+--------------------------------+---------------------+
| Speedmax                       | float64             |
+--------------------------------+---------------------+
| Speedservice                   | float64             |
+--------------------------------+---------------------+
| BreadthExtreme                 | float64             |
+--------------------------------+---------------------+
| SummerDraught                  | float64             |
+--------------------------------+---------------------+
| FuelType1Capacity              | float64             |
+--------------------------------+---------------------+
| FuelType2Capacity              | float64             |
+--------------------------------+---------------------+
| LightDisplacementTonnage       | int32               |
+--------------------------------+---------------------+
| MainEngineRPM                  | float64             |
+--------------------------------+---------------------+
| MainEngineType                 | object              |
+--------------------------------+---------------------+
| Powerkwservice                 | int32               |
+--------------------------------+---------------------+
| PropulsionType                 | object              |
+--------------------------------+---------------------+
| ShiptypeLevel5                 | object              |
+--------------------------------+---------------------+
| TotalBunkerCapacity            | float64             |
+--------------------------------+---------------------+
| StandardVesselType_y           | object              |
+--------------------------------+---------------------+
| imobin                         | int64               |
+--------------------------------+---------------------+
| fuel                           | object              |
+--------------------------------+---------------------+
| meType                         | object              |
+--------------------------------+---------------------+
| ais_beam                       | float64             |
+--------------------------------+---------------------+
| ais_loa                        | float64             |
+--------------------------------+---------------------+
| combustible_me                 | float64             |
+--------------------------------+---------------------+
| combustible_ae                 | float64             |
+--------------------------------+---------------------+
| combustible_ab                 | float64             |
+--------------------------------+---------------------+
| fuel_consumption               | float64             |
+--------------------------------+---------------------+
| TotalBunkerCapacity_is_missing | int64               |
+--------------------------------+---------------------+</code></pre>
</div>
</div>
</section>
</section>
<section id="visualización-de-matriz-de-correlación-heatmap" class="level2" data-number="1.16">
<h2 data-number="1.16" class="anchored" data-anchor-id="visualización-de-matriz-de-correlación-heatmap"><span class="header-section-number">1.16</span> Visualización de matriz de correlación (heatmap)</h2>
<div id="visualizar_correlacion" class="cell" data-message="false" data-execution_count="47">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mostrar_matriz_correlacion(df, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">10</span>), cmap<span class="op">=</span><span class="st">'coolwarm'</span>):</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Genera un heatmap de la matriz de correlación solo para columnas numéricas.</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame a analizar.</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">        figsize (tuple, optional): Tamaño de la figura. Default (12,10).</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co">        cmap (str, optional): Colormap de Seaborn. Default 'coolwarm'.</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Retorna:</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="co">        corr (pd.DataFrame): Matriz de correlación (solo numéricas) para uso posterior.</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    df_numerico <span class="op">=</span> df.select_dtypes(include<span class="op">=</span><span class="st">'number'</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> df_numerico.corr()</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>figsize)</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(corr, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">".2f"</span>, cmap<span class="op">=</span>cmap, cbar<span class="op">=</span><span class="va">True</span>, square<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Matriz de correlación (columnas numéricas)"</span>)</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corr</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="a8b887f7" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instancia: aplicar a X_train_int_imputado</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>corr_train <span class="op">=</span> mostrar_matriz_correlacion(X_train_int_imputado)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="definición-de-la-función-para-eliminar-correlación-alta" class="level3" data-number="1.16.1">
<h3 data-number="1.16.1" class="anchored" data-anchor-id="definición-de-la-función-para-eliminar-correlación-alta"><span class="header-section-number">1.16.1</span> <strong>Definición de la función para eliminar correlación alta</strong></h3>
<div id="eliminar_correlacion" class="cell" data-message="false" data-execution_count="49">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para elegir variables altamente correlacionadas</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> choose_one_from_highly_correlated(correlation_matrix, threshold<span class="op">=</span><span class="fl">0.60</span>):</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Identifica columnas a eliminar según correlación alta.</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">        correlation_matrix (pd.DataFrame): matriz de correlación absoluta.</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co">        threshold (float): umbral de correlación para eliminar variables.</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co">        list: columnas a eliminar.</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    columns_to_remove <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column <span class="kw">in</span> correlation_matrix.columns:</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        high_corr_columns <span class="op">=</span> correlation_matrix[column][correlation_matrix[column] <span class="op">&gt;</span> threshold].index.tolist()</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> column <span class="kw">in</span> high_corr_columns:</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>            high_corr_columns.remove(column)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> high_corr_columns:</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>            columns_to_remove.update(high_corr_columns[<span class="dv">1</span>:])</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(columns_to_remove)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="aplicación-de-la-función-a-entrenamiento-y-validación" class="level3" data-number="1.16.2">
<h3 data-number="1.16.2" class="anchored" data-anchor-id="aplicación-de-la-función-a-entrenamiento-y-validación"><span class="header-section-number">1.16.2</span> <strong>Aplicación de la función a entrenamiento y validación</strong></h3>
<div id="aplicar_eliminar_correlacion" class="cell" data-message="false" data-execution_count="50">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular matriz de correlación absoluta solo de columnas numéricas</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>correlation_matrix_train <span class="op">=</span> X_train_int_imputado.select_dtypes(include<span class="op">=</span>[np.number]).corr().<span class="bu">abs</span>()</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar columnas a eliminar según correlación</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>columns_to_drop <span class="op">=</span> choose_one_from_highly_correlated(correlation_matrix_train, threshold<span class="op">=</span><span class="fl">0.60</span>)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar columnas de X_train_int y X_val_int</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>X_train_int_sin_corr <span class="op">=</span> X_train_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>X_val_int_sin_corr <span class="op">=</span> X_val_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas originales en train: </span><span class="sc">{</span>X_train_int_imputado<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas eliminadas por alta correlación: </span><span class="sc">{</span><span class="bu">len</span>(columns_to_drop)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas después de eliminación en train: </span><span class="sc">{</span>X_train_int_sin_corr<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Columnas originales en train: 51
Columnas eliminadas por alta correlación: 18
Columnas después de eliminación en train: 33</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="aplicar-la-eliminación-de-columnas-seleccionadas-a-train-y-validación" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Aplicar la eliminación de columnas seleccionadas a train y validación</h1>
<div id="eliminar_variables" class="cell" data-message="false" data-execution_count="51">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># eliminar de train y validación usando la lista calculada</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>X_train_int_imputado <span class="op">=</span> X_train_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>X_val_int_imputado   <span class="op">=</span> X_val_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="variables-resultante" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="variables-resultante"><span class="header-section-number">2.1</span> variables resultante</h2>
<div id="b3b3af0b" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear lista de columnas y su tipo</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>variable_tipo <span class="op">=</span> [(col, <span class="bu">str</span>(X_train_int_imputado[col].dtype)) <span class="cf">for</span> col <span class="kw">in</span> X_train_int_imputado.columns]</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar en formato tabla</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(variable_tipo, headers<span class="op">=</span>[<span class="st">'Variable'</span>, <span class="st">'Tipo'</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------------------+---------------------+
| Variable                       | Tipo                |
+================================+=====================+
| mmsi                           | int32               |
+--------------------------------+---------------------+
| start_leg                      | datetime64[ns, UTC] |
+--------------------------------+---------------------+
| end_leg                        | datetime64[ns, UTC] |
+--------------------------------+---------------------+
| h3_sequence                    | object              |
+--------------------------------+---------------------+
| imo_x                          | int32               |
+--------------------------------+---------------------+
| ref_in                         | datetime64[us]      |
+--------------------------------+---------------------+
| ref_out                        | datetime64[us]      |
+--------------------------------+---------------------+
| port_before                    | object              |
+--------------------------------+---------------------+
| country_before                 | object              |
+--------------------------------+---------------------+
| port_after                     | object              |
+--------------------------------+---------------------+
| country_after                  | object              |
+--------------------------------+---------------------+
| op_phase                       | object              |
+--------------------------------+---------------------+
| StandardVesselType_x           | object              |
+--------------------------------+---------------------+
| GrossTonnage_x                 | int32               |
+--------------------------------+---------------------+
| first_dt_pos_utc               | datetime64[us]      |
+--------------------------------+---------------------+
| sum_me_ene                     | float64             |
+--------------------------------+---------------------+
| sum_ab_ene                     | float64             |
+--------------------------------+---------------------+
| imo_y                          | int32               |
+--------------------------------+---------------------+
| DateOfBuild                    | int32               |
+--------------------------------+---------------------+
| MainEngineModel                | object              |
+--------------------------------+---------------------+
| Speedmax                       | float64             |
+--------------------------------+---------------------+
| BreadthExtreme                 | float64             |
+--------------------------------+---------------------+
| FuelType1Capacity              | float64             |
+--------------------------------+---------------------+
| MainEngineRPM                  | float64             |
+--------------------------------+---------------------+
| MainEngineType                 | object              |
+--------------------------------+---------------------+
| Powerkwservice                 | int32               |
+--------------------------------+---------------------+
| PropulsionType                 | object              |
+--------------------------------+---------------------+
| ShiptypeLevel5                 | object              |
+--------------------------------+---------------------+
| StandardVesselType_y           | object              |
+--------------------------------+---------------------+
| fuel                           | object              |
+--------------------------------+---------------------+
| meType                         | object              |
+--------------------------------+---------------------+
| combustible_ab                 | float64             |
+--------------------------------+---------------------+
| TotalBunkerCapacity_is_missing | int64               |
+--------------------------------+---------------------+</code></pre>
</div>
</div>
</section>
<section id="outliers" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="outliers"><span class="header-section-number">2.2</span> outliers</h2>
</section>
<section id="definir-features-numéricas-y-categóricas" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="definir-features-numéricas-y-categóricas"><span class="header-section-number">2.3</span> <strong>Definir features numéricas y categóricas</strong></h2>
<div id="definir_features" class="cell" data-message="false" data-execution_count="53">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas numéricas que vamos a escalar</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GrossTonnage_x'</span>, <span class="st">'sum_me_ene'</span>, <span class="st">'sum_ab_ene'</span>, </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Speedmax'</span>, <span class="st">'BreadthExtreme'</span>, <span class="st">'FuelType1Capacity'</span>, </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineRPM'</span>, <span class="st">'Powerkwservice'</span>, <span class="st">'combustible_ab'</span>, </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TotalBunkerCapacity_is_missing'</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas categóricas (objetos) excluyendo h3_sequence</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> X_train_int_imputado.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>]).columns.tolist()</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'h3_sequence'</span> <span class="kw">in</span> categorical_features:</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    categorical_features.remove(<span class="st">'h3_sequence'</span>)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Numéricas:"</span>, numeric_features)</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Categóricas:"</span>, categorical_features)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Numéricas: ['GrossTonnage_x', 'sum_me_ene', 'sum_ab_ene', 'Speedmax', 'BreadthExtreme', 'FuelType1Capacity', 'MainEngineRPM', 'Powerkwservice', 'combustible_ab', 'TotalBunkerCapacity_is_missing']
Categóricas: ['port_before', 'country_before', 'port_after', 'country_after', 'op_phase', 'StandardVesselType_x', 'MainEngineModel', 'MainEngineType', 'PropulsionType', 'ShiptypeLevel5', 'StandardVesselType_y', 'fuel', 'meType']</code></pre>
</div>
</div>
</section>
<section id="escalado-de-features-numéricas-y-codificación-de-categóricas" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="escalado-de-features-numéricas-y-codificación-de-categóricas"><span class="header-section-number">2.4</span> <strong>Escalado de features numéricas y codificación de categóricas</strong></h2>
<div id="escalado_numerico" class="cell" data-message="false" data-execution_count="54">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Escalado numérico</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="op">=</span> X_train_int_imputado.copy()</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>X_val_scaled <span class="op">=</span> X_val_int_imputado.copy()</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>X_train_scaled[numeric_features] <span class="op">=</span> scaler.fit_transform(X_train_scaled[numeric_features])</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>X_val_scaled[numeric_features] <span class="op">=</span> scaler.transform(X_val_scaled[numeric_features])</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Escalado numérico realizado ✅"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Escalado numérico realizado ✅</code></pre>
</div>
</div>
<div id="conversion_categoricas" class="cell" data-message="false" data-execution_count="55">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir todas las columnas categóricas a string (por si hay tipos mixtos)</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>X_train_scaled[categorical_features] <span class="op">=</span> X_train_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>X_val_scaled[categorical_features] <span class="op">=</span> X_val_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Columnas categóricas convertidas a string ✅"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Columnas categóricas convertidas a string ✅</code></pre>
</div>
</div>
<div id="codificacion_onehot" class="cell" data-message="false" data-execution_count="56">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Codificación one-hot</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> ColumnTransformer(</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[(<span class="st">'cat'</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>), categorical_features)],</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    remainder<span class="op">=</span><span class="st">'drop'</span>  <span class="co"># solo se procesan las columnas categóricas que definimos</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>X_train_enc <span class="op">=</span> encoder.fit_transform(X_train_scaled)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>X_val_enc <span class="op">=</span> encoder.transform(X_val_scaled)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Codificación One-Hot realizada ✅"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Codificación One-Hot realizada ✅</code></pre>
</div>
</div>
<div id="conversion_dataframe" class="cell" data-message="false" data-execution_count="57">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertimos a DataFrame para inspección</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>X_train_df <span class="op">=</span> pd.DataFrame(X_train_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_train_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_train_enc)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>X_val_df <span class="op">=</span> pd.DataFrame(X_val_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_val_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_val_enc)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conversión a DataFrame realizada ✅"</span>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dimensiones X_train_df:"</span>, X_train_df.shape)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dimensiones X_val_df:"</span>, X_val_df.shape)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Conversión a DataFrame realizada ✅
Dimensiones X_train_df: (15312, 1364)
Dimensiones X_val_df: (3828, 1364)</code></pre>
</div>
</div>
<div id="verificacion_targuet" class="cell" data-message="false" data-execution_count="58">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_train_int:"</span>, y_train_int.isna().<span class="bu">sum</span>())</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_val_int:"</span>, y_val_int.isna().<span class="bu">sum</span>())</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores únicos en y_train_int:"</span>, y_train_int.unique())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>NaN en y_train_int: 0
NaN en y_val_int: 0
Valores únicos en y_train_int: [2.47487183e+03 2.08071100e+01 7.57015043e+02 ... 1.39331007e+03
 1.60673185e+04 3.65883159e+04]</code></pre>
</div>
</div>
</section>
<section id="escalado-de-la-variable-objetivo" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="escalado-de-la-variable-objetivo"><span class="header-section-number">2.5</span> <strong>Escalado de la variable objetivo</strong></h2>
<div id="escalado_target" class="cell" data-message="false" data-execution_count="59">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>scaler_y <span class="op">=</span> MinMaxScaler()</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>y_train_scaled <span class="op">=</span> scaler_y.fit_transform(y_train_int.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>y_val_scaled <span class="op">=</span> scaler_y.transform(y_val_int.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inspeccionar_target" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="inspeccionar_target"><span class="header-section-number">2.6</span> inspeccionar_target</h2>
<div id="verificar_y" class="cell" data-message="false" data-execution_count="60">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_train_scaled:"</span>, np.isnan(y_train_scaled).<span class="bu">sum</span>())</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Inf en y_train_scaled:"</span>, np.isinf(y_train_scaled).<span class="bu">sum</span>())</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_val_scaled:"</span>, np.isnan(y_val_scaled).<span class="bu">sum</span>())</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Inf en y_val_scaled:"</span>, np.isinf(y_val_scaled).<span class="bu">sum</span>())</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores mínimos y máximos en y_train_scaled:"</span>, y_train_scaled.<span class="bu">min</span>(), y_train_scaled.<span class="bu">max</span>())</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores mínimos y máximos en y_val_scaled:"</span>, y_val_scaled.<span class="bu">min</span>(), y_val_scaled.<span class="bu">max</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>NaN en y_train_scaled: 0
Inf en y_train_scaled: 0
NaN en y_val_scaled: 0
Inf en y_val_scaled: 0
Valores mínimos y máximos en y_train_scaled: 0.0 1.0000000000000002
Valores mínimos y máximos en y_val_scaled: -5.700627960199813e-09 1.2468833255578058</code></pre>
</div>
</div>
</section>
<section id="crear-secuencias-para-lstm-con-índices-originales" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="crear-secuencias-para-lstm-con-índices-originales"><span class="header-section-number">2.7</span> <strong>Crear secuencias para LSTM (con índices originales)</strong></h2>
<div id="crear_secuencias" class="cell" data-message="false" data-execution_count="61">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_sequences(X, y, df_indices, seq_len<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    X_seq, y_seq, idx_seq_all <span class="op">=</span> [], [], []</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, group <span class="kw">in</span> df_indices.groupby(<span class="st">'mmsi'</span>):</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&lt;=</span> seq_len:</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n <span class="op">-</span> seq_len):</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>            idx_seq <span class="op">=</span> group.index[i:i<span class="op">+</span>seq_len].to_list()</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>            X_seq.append(X[idx_seq])</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>            y_seq.append(y[idx_seq[<span class="op">-</span><span class="dv">1</span>]])</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Guardamos el índice real del último valor de la secuencia</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>            idx_seq_all.append(group.loc[idx_seq[<span class="op">-</span><span class="dv">1</span>], <span class="st">"index_original"</span>])</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(X_seq), np.array(y_seq), np.array(idx_seq_all)</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar índice original</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>X_train_scaled_reset <span class="op">=</span> X_train_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>X_train_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_train_scaled_reset.index</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>X_val_scaled_reset <span class="op">=</span> X_val_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>X_val_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_val_scaled_reset.index</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear secuencias</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>X_train_seq, y_train_seq, idx_train_seq <span class="op">=</span> create_sequences(</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    X_train_df.values, y_train_scaled, X_train_scaled_reset, seq_len</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>X_val_seq, y_val_seq, idx_val_seq <span class="op">=</span> create_sequences(</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>    X_val_df.values, y_val_scaled, X_val_scaled_reset, seq_len</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="construcción-y-entrenamiento-del-modelo-lstm" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="construcción-y-entrenamiento-del-modelo-lstm"><span class="header-section-number">2.8</span> <strong>Construcción y entrenamiento del modelo LSTM</strong></h2>
<div id="entrenamiento_lstm" class="cell" data-message="false" data-execution_count="62">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> LSTM, Dense, Dropout, Input</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>model.add(Input(shape<span class="op">=</span>(seq_len, X_train_seq.shape[<span class="dv">2</span>])))</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>model.add(Dropout(<span class="fl">0.2</span>))</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mse'</span>, metrics<span class="op">=</span>[<span class="st">'mae'</span>])</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    X_train_seq, y_train_seq,</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    validation_data<span class="op">=</span>(X_val_seq, y_val_seq),</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="evaluación-del-modelo" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="evaluación-del-modelo"><span class="header-section-number">2.9</span> <strong>Evaluación del modelo</strong></h2>
<div id="evaluacion_lstm_metricas" class="cell" data-message="false" data-execution_count="63">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluación del modelo en validación</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>loss, mae <span class="op">=</span> model.evaluate(X_val_seq, y_val_seq, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicciones</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>y_pred_scaled <span class="op">=</span> model.predict(X_val_seq, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> scaler_y.inverse_transform(y_pred_scaled.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> scaler_y.inverse_transform(y_val_seq.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_pred))</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_true, y_pred)</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((y_true <span class="op">-</span> y_pred) <span class="op">/</span> (y_true <span class="op">+</span> epsilon))) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Prints resumidos y claros</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R²: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loss (scaled): </span><span class="sc">{</span>loss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAE (scaled): </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAE original: </span><span class="sc">{</span>mae_original<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R²: 0.7696
MAPE: 63968.24%
Loss (scaled): 0.0003
MAE (scaled): 0.0057
MAE original: 150875.57</code></pre>
</div>
</div>
<div id="cell-tu_loss" class="cell" data-message="false" data-execution_count="64">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Supongamos que tu entrenamiento devuelve un objeto 'history'</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="co"># history.history['loss'] contiene el loss por época</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> history.history[<span class="st">'loss'</span>]  </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>val_loss <span class="op">=</span> history.history.get(<span class="st">'val_loss'</span>)  <span class="co"># opcional, si tienes validación</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>plt.plot(loss, label<span class="op">=</span><span class="st">'Entrenamiento'</span>)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> val_loss:</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    plt.plot(val_loss, label<span class="op">=</span><span class="st">'Validación'</span>)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Evolución del Loss'</span>)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Época'</span>)</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/tu_loss-output-1.png" id="tu_loss" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conjunto-de-prueba" class="level2" data-number="2.10">
<h2 data-number="2.10" class="anchored" data-anchor-id="conjunto-de-prueba"><span class="header-section-number">2.10</span> conjunto de prueba</h2>
</section>
<section id="crear-target-co2_emission-en-test" class="level2" data-number="2.11">
<h2 data-number="2.11" class="anchored" data-anchor-id="crear-target-co2_emission-en-test"><span class="header-section-number">2.11</span> Crear target CO2_emission en test</h2>
<div id="crear_target_test" class="cell" data-message="false" data-execution_count="65">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear target en test_ext</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>test_ext <span class="op">=</span> crear_target_emisiones(test_ext)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">'CO2_emission'</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="08ca055d" class="cell" data-message="false" data-execution_count="66">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> test_ext.copy()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="eliminar-filas-con-co2_emission-0" class="level2" data-number="2.12">
<h2 data-number="2.12" class="anchored" data-anchor-id="eliminar-filas-con-co2_emission-0"><span class="header-section-number">2.12</span> Eliminar filas con CO2_emission = 0</h2>
<div id="db70da1d" class="cell" data-message="false" data-execution_count="67">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> test_ext_filtrado[test_ext_filtrado[target] <span class="op">!=</span> <span class="dv">0</span>].copy()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
<section id="revisar-cuántas-filas-quedan-tras-eliminar-ceros" class="level2" data-number="2.13">
<h2 data-number="2.13" class="anchored" data-anchor-id="revisar-cuántas-filas-quedan-tras-eliminar-ceros"><span class="header-section-number">2.13</span> Revisar cuántas filas quedan tras eliminar ceros</h2>
<div id="f469b155" class="cell" data-message="false" data-execution_count="68">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas en test después de eliminar ceros en CO2_emission: </span><span class="sc">{</span><span class="bu">len</span>(test_ext_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Filas en test después de eliminar ceros en CO2_emission: 1887</code></pre>
</div>
</div>
<hr>
</section>
<section id="filtrar-filas-con-target-válido-y-revisar-buques-con-secuencia-mínima" class="level2" data-number="2.14">
<h2 data-number="2.14" class="anchored" data-anchor-id="filtrar-filas-con-target-válido-y-revisar-buques-con-secuencia-mínima"><span class="header-section-number">2.14</span> Filtrar filas con target válido y revisar buques con secuencia mínima</h2>
<div id="61cbd917" class="cell" data-message="false" data-execution_count="69">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">4</span>  <span class="co"># longitud mínima de secuencia</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar filas con target válido</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>test_ext_target <span class="op">=</span> test_ext_filtrado[test_ext_filtrado[<span class="st">'CO2_emission'</span>].notna()].copy()</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar buques válidos antes y después de filtrar NaN</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>registros_por_buque_orig <span class="op">=</span> test_ext_filtrado.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>buques_validos_orig <span class="op">=</span> (registros_por_buque_orig <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>registros_por_buque_filtrado <span class="op">=</span> test_ext_target.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>buques_validos_filtrado <span class="op">=</span> (registros_por_buque_filtrado <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>resumen_test <span class="op">=</span> pd.DataFrame({</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'Original test'</span>, <span class="st">'Filtrado por target'</span>],</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Buques válidos'</span>: [buques_validos_orig, buques_validos_filtrado],</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(test_ext_filtrado), <span class="bu">len</span>(test_ext_target)]</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_test, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+----+---------------------+------------------+-----------------+
|    | Dataset             |   Buques válidos |   Filas totales |
|----+---------------------+------------------+-----------------|
|  0 | Original test       |              312 |            1887 |
|  1 | Filtrado por target |              312 |            1885 |
+----+---------------------+------------------+-----------------+</code></pre>
</div>
</div>
<hr>
</section>
<section id="recorte-de-buques-por-secuencia-mínima" class="level2" data-number="2.15">
<h2 data-number="2.15" class="anchored" data-anchor-id="recorte-de-buques-por-secuencia-mínima"><span class="header-section-number">2.15</span> Recorte de buques por secuencia mínima</h2>
<div id="d116e09f" class="cell" data-message="false" data-execution_count="70">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> filtrar_buques_por_min_registros(test_ext_target, min_registros<span class="op">=</span>seq_len)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después del recorte por secuencia mínima en test: </span><span class="sc">{</span><span class="bu">len</span>(test_ext_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Filas después del recorte por secuencia mínima en test: 1631</code></pre>
</div>
</div>
<div id="2e63d72b" class="cell" data-message="false" data-execution_count="71">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver valores nulos en test_ext_filtrado</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>nulos_por_col <span class="op">=</span> test_ext_filtrado.isnull().<span class="bu">sum</span>()</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>nulos_filtrados <span class="op">=</span> nulos_por_col[nulos_por_col <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>resumen_nulos <span class="op">=</span> pd.DataFrame({</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Columna'</span>: nulos_filtrados.index,</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Valores nulos'</span>: nulos_filtrados.values,</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Porcentaje nulos (%)'</span>: nulos_filtrados <span class="op">/</span> <span class="bu">len</span>(test_ext_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>}).sort_values(by<span class="op">=</span><span class="st">'Porcentaje nulos (%)'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_nulos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'grid'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------------+-----------------+------------------------+
| Columna             |   Valores nulos |   Porcentaje nulos (%) |
+=====================+=================+========================+
| TotalBunkerCapacity |             310 |              19.0067   |
+---------------------+-----------------+------------------------+
| MainEngineRPM       |              13 |               0.797057 |
+---------------------+-----------------+------------------------+
| FuelType1Capacity   |               5 |               0.30656  |
+---------------------+-----------------+------------------------+</code></pre>
</div>
</div>
</section>
<section id="definir-vairables-de-entrada" class="level2" data-number="2.16">
<h2 data-number="2.16" class="anchored" data-anchor-id="definir-vairables-de-entrada"><span class="header-section-number">2.16</span> definir vairables de entrada</h2>
<div id="0615ed8c" class="cell" data-message="false" data-execution_count="72">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_ext_filtrado.drop(columns<span class="op">=</span>[target])</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_ext_filtrado[target]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="4dd80432" class="cell" data-message="false" data-execution_count="73">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas a imputar en test</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>columnas_num <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>, <span class="st">'MainEngineRPM'</span>, <span class="st">'FuelType1Capacity'</span>]</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>flags <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>]  <span class="co"># opcional: marcar dónde había nulos</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>columnas_cat <span class="op">=</span> []  <span class="co"># no hay categóricas con nulos</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar imputación al test usando stats del train</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>X_test_imputado, _, _ <span class="op">=</span> imputar_datos(</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    X_test,</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags,</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    medianas<span class="op">=</span>medianas,  <span class="co"># de X_train_int_imputado</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    modas<span class="op">=</span>modas</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="features" class="level2" data-number="2.17">
<h2 data-number="2.17" class="anchored" data-anchor-id="features"><span class="header-section-number">2.17</span> features</h2>
<div id="5ea964c7" class="cell" data-message="false" data-execution_count="74">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>X_test_features <span class="op">=</span> crear_features(X_test_imputado)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="ajustes-de-correlaciones" class="level2" data-number="2.18">
<h2 data-number="2.18" class="anchored" data-anchor-id="ajustes-de-correlaciones"><span class="header-section-number">2.18</span> ajustes de correlaciones</h2>
<div id="7c0fa0f4" class="cell" data-message="false" data-execution_count="75">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>X_test_sin_corr <span class="op">=</span> X_test_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas en test antes de eliminar correladas: </span><span class="sc">{</span>X_test_imputado<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas en test después de eliminar correladas: </span><span class="sc">{</span>X_test_sin_corr<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Columnas en test antes de eliminar correladas: 51
Columnas en test después de eliminar correladas: 33</code></pre>
</div>
</div>
<div id="4a4f2646" class="cell" data-message="false" data-execution_count="76">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de columnas finales del test</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>resumen_test_final <span class="op">=</span> pd.DataFrame({</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Columnas finales"</span>: X_test_sin_corr.columns,</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tipo"</span>: X_test_sin_corr.dtypes.values</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_test_final, headers<span class="op">=</span><span class="st">"keys"</span>, tablefmt<span class="op">=</span><span class="st">"psql"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>+----+--------------------------------+---------------------+
|    | Columnas finales               | Tipo                |
|----+--------------------------------+---------------------|
|  0 | mmsi                           | int32               |
|  1 | start_leg                      | datetime64[ns, UTC] |
|  2 | end_leg                        | datetime64[ns, UTC] |
|  3 | h3_sequence                    | object              |
|  4 | imo_x                          | int32               |
|  5 | ref_in                         | datetime64[us]      |
|  6 | ref_out                        | datetime64[us]      |
|  7 | port_before                    | object              |
|  8 | country_before                 | object              |
|  9 | port_after                     | object              |
| 10 | country_after                  | object              |
| 11 | op_phase                       | object              |
| 12 | StandardVesselType_x           | object              |
| 13 | GrossTonnage_x                 | int32               |
| 14 | first_dt_pos_utc               | datetime64[us]      |
| 15 | sum_me_ene                     | float64             |
| 16 | sum_ab_ene                     | float64             |
| 17 | imo_y                          | int32               |
| 18 | DateOfBuild                    | int32               |
| 19 | MainEngineModel                | object              |
| 20 | Speedmax                       | float64             |
| 21 | BreadthExtreme                 | float64             |
| 22 | FuelType1Capacity              | float64             |
| 23 | MainEngineRPM                  | float64             |
| 24 | MainEngineType                 | object              |
| 25 | Powerkwservice                 | int32               |
| 26 | PropulsionType                 | object              |
| 27 | ShiptypeLevel5                 | object              |
| 28 | StandardVesselType_y           | object              |
| 29 | fuel                           | object              |
| 30 | meType                         | object              |
| 31 | combustible_ab                 | float64             |
| 32 | TotalBunkerCapacity_is_missing | int64               |
+----+--------------------------------+---------------------+</code></pre>
</div>
</div>
</section>
<section id="features-test" class="level2" data-number="2.19">
<h2 data-number="2.19" class="anchored" data-anchor-id="features-test"><span class="header-section-number">2.19</span> features test</h2>
<div id="84148163" class="cell" data-message="false" data-execution_count="77">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Features numéricas (las que se escalan)</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GrossTonnage_x'</span>, <span class="st">'sum_me_ene'</span>, <span class="st">'sum_ab_ene'</span>,</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Speedmax'</span>, <span class="st">'BreadthExtreme'</span>, <span class="st">'FuelType1Capacity'</span>,</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineRPM'</span>, <span class="st">'Powerkwservice'</span>, <span class="st">'combustible_ab'</span>,</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TotalBunkerCapacity_is_missing'</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Features categóricas (objetos), excluyendo 'h3_sequence'</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'port_before'</span>, <span class="st">'country_before'</span>, <span class="st">'port_after'</span>, <span class="st">'country_after'</span>,</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'op_phase'</span>, <span class="st">'StandardVesselType_x'</span>, <span class="st">'MainEngineModel'</span>, </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineType'</span>, <span class="st">'PropulsionType'</span>, <span class="st">'ShiptypeLevel5'</span>,</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'StandardVesselType_y'</span>, <span class="st">'fuel'</span>, <span class="st">'meType'</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="21dacdbd" class="cell" data-message="false" data-execution_count="78">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Escalar columnas numéricas</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="op">=</span> X_test_sin_corr.copy()</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>X_test_scaled[numeric_features] <span class="op">=</span> scaler.transform(X_test_scaled[numeric_features])</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  Convertir categóricas a string</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>X_test_scaled[categorical_features] <span class="op">=</span> X_test_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  Codificación One-Hot usando encoder ya ajustado</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>X_test_enc <span class="op">=</span> encoder.transform(X_test_scaled)</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>X_test_df <span class="op">=</span> pd.DataFrame(X_test_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_test_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_test_enc)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="65986aab" class="cell" data-message="false" data-execution_count="79">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  Escalar variable objetivo</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>y_test_scaled <span class="op">=</span> scaler_y.transform(y_test.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b7ac1082" class="cell" data-message="false" data-execution_count="80">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  Crear secuencias para LSTM</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>X_test_scaled_reset <span class="op">=</span> X_test_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>X_test_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_test_scaled_reset.index</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>X_test_seq, y_test_seq, idx_test_seq <span class="op">=</span> create_sequences(</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    X_test_df.values, y_test_scaled, X_test_scaled_reset, seq_len</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="316ce5dd" class="cell" data-message="false" data-execution_count="81">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  Evaluar modelo</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>loss, mae <span class="op">=</span> model.evaluate(X_test_seq, y_test_seq)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test Loss:"</span>, loss, <span class="st">"Test MAE:"</span>, mae)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold"> 1/12</span> <span class="ansi-green-fg">━</span><span class="ansi-white-fg">━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-bold">3s</span> 275ms/step - loss: 1.4128e-04 - mae: 0.0043

<span class="ansi-bold">12/12</span> <span class="ansi-green-fg">━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-bold">0s</span> 5ms/step - loss: 1.8030e-04 - mae: 0.0050  

Test Loss: 0.00018030412320513278 Test MAE: 0.004961726255714893
</pre>
</div>
</div>
</div>
<div id="9f0e36de" class="cell" data-message="false" data-execution_count="82">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener predicciones en el test</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> model.predict(X_test_seq)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstrucción con índices originales</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>df_results_test <span class="op">=</span> pd.DataFrame({</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"index_original"</span>: idx_test_seq,</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y_true"</span>: y_test_seq.flatten(),</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y_pred"</span>: y_test_pred.flatten()</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver las primeras filas</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>df_results_test.head()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold"> 1/12</span> <span class="ansi-green-fg">━</span><span class="ansi-white-fg">━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-bold">2s</span> 197ms/step

<span class="ansi-bold">12/12</span> <span class="ansi-green-fg">━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-bold">0s</span> 4ms/step  
</pre>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="82">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index_original</th>
<th data-quarto-table-cell-role="th">y_true</th>
<th data-quarto-table-cell-role="th">y_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1621</td>
<td>0.000053</td>
<td>0.001364</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>791</td>
<td>0.000052</td>
<td>0.001750</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>752</td>
<td>0.000602</td>
<td>0.001954</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>260</td>
<td>0.000163</td>
<td>0.001769</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>261</td>
<td>0.014625</td>
<td>0.011861</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="2e5fa030" class="cell" data-message="false" data-execution_count="83">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>df_results_test.to_csv(<span class="st">"df_results_test.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="69089ba6" class="cell" data-execution_count="84">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraer mmsi para cada predicción</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>df_results_test[<span class="st">'mmsi'</span>] <span class="op">=</span> X_test_scaled_reset.loc[df_results_test[<span class="st">'index_original'</span>], <span class="st">'mmsi'</span>].values</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Elegir un MMSI aleatorio del conjunto de prueba</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>mmsi_random <span class="op">=</span> np.random.choice(df_results_test[<span class="st">'mmsi'</span>].unique())</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar predicciones de ese buque</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>df_buque <span class="op">=</span> df_results_test[df_results_test[<span class="st">'mmsi'</span>] <span class="op">==</span> mmsi_random]</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_buque)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     index_original   y_true    y_pred       mmsi
313             501  0.00025  0.002559  636016650</code></pre>
</div>
</div>
<div id="e7a6d0d2" class="cell" data-execution_count="85">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar cuántos registros tiene cada MMSI</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>conteo_buques <span class="op">=</span> df_results_test[<span class="st">'mmsi'</span>].value_counts()</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Elegir un MMSI con al menos, por ejemplo, 5 secuencias</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>mmsi_ejemplo <span class="op">=</span> conteo_buques[conteo_buques <span class="op">&gt;=</span> <span class="dv">5</span>].index[<span class="dv">0</span>]</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar predicciones de ese buque</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>df_buque <span class="op">=</span> df_results_test[df_results_test[<span class="st">'mmsi'</span>] <span class="op">==</span> mmsi_ejemplo]</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>plt.plot(df_buque[<span class="st">'y_true'</span>].values, label<span class="op">=</span><span class="st">'y_true'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>plt.plot(df_buque[<span class="st">'y_pred'</span>].values, label<span class="op">=</span><span class="st">'y_pred'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Predicciones vs Valores reales para MMSI </span><span class="sc">{</span>mmsi_ejemplo<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Secuencia'</span>)</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'CO2_emission (escalado)'</span>)</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-86-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb129" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Green Maritime Corridors - Canal de Panamá</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>quarto preview</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## Librerías y dependencias</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: librerias</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> SelectKBest, f_regression</span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Lectura y limpieza inicial</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lectura_limpieza_inicial</span></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Lectura y limpieza inicial</span></span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>ruta_data <span class="op">=</span> <span class="vs">r"C:</span><span class="er">\</span><span class="vs">Users</span><span class="er">\</span><span class="vs">limco</span><span class="dv">\D</span><span class="vs">ocuments</span><span class="dv">\D</span><span class="vs">ATA_C</span><span class="dv">\s</span><span class="vs">ample_training</span><span class="dv">.</span><span class="vs">parquet"</span></span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>df_raw <span class="op">=</span> pd.read_parquet(ruta_data, engine<span class="op">=</span><span class="st">'fastparquet'</span>)</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpiar nombres de columnas</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>df_raw.columns <span class="op">=</span> (</span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>    df_raw.columns.<span class="bu">str</span>.strip()</span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>                  .<span class="bu">str</span>.replace(<span class="st">' '</span>, <span class="st">'_'</span>)</span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>                  .<span class="bu">str</span>.replace(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="pp">]</span><span class="vs">'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir columna de fecha</span></span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">=</span> pd.to_datetime(df_raw[<span class="st">'first_dt_pos_utc'</span>])</span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Partición externa</span></span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: particion_externa</span></span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Partición externa</span></span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a>fecha_corte <span class="op">=</span> pd.to_datetime(<span class="st">'2019-06-01'</span>)</span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>train_val <span class="op">=</span> df_raw[df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">&lt;</span> fecha_corte].copy()</span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>test_ext  <span class="op">=</span> df_raw[df_raw[<span class="st">'first_dt_pos_utc'</span>] <span class="op">&gt;=</span> fecha_corte].copy()</span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a><span class="fu"># Exploración inicial (EDA)</span></span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resumen de train\_val</span></span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: resumen_train_val</span></span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-70"><a href="#cb129-70" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-71"><a href="#cb129-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-72"><a href="#cb129-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cantidad de filas en train_val: </span><span class="sc">{</span><span class="bu">len</span>(train_val)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-73"><a href="#cb129-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cantidad de columnas en train_val: </span><span class="sc">{</span><span class="bu">len</span>(train_val.columns)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb129-74"><a href="#cb129-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-75"><a href="#cb129-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-76"><a href="#cb129-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-77"><a href="#cb129-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-78"><a href="#cb129-78" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploración inicial de datos (sin h3\_sequence)</span></span>
<span id="cb129-79"><a href="#cb129-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-82"><a href="#cb129-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-83"><a href="#cb129-83" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: exploracion_i</span></span>
<span id="cb129-84"><a href="#cb129-84" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-85"><a href="#cb129-85" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-86"><a href="#cb129-86" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-87"><a href="#cb129-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-88"><a href="#cb129-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas a mostrar (excluyendo 'h3_sequence')</span></span>
<span id="cb129-89"><a href="#cb129-89" aria-hidden="true" tabindex="-1"></a>cols_to_show <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_val.columns <span class="cf">if</span> c <span class="op">!=</span> <span class="st">'h3_sequence'</span>]</span>
<span id="cb129-90"><a href="#cb129-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-91"><a href="#cb129-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar primeras filas</span></span>
<span id="cb129-92"><a href="#cb129-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(train_val[cols_to_show].head(<span class="dv">5</span>), headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-93"><a href="#cb129-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-94"><a href="#cb129-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-95"><a href="#cb129-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-96"><a href="#cb129-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-97"><a href="#cb129-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Revisión de tipos de datos</span></span>
<span id="cb129-98"><a href="#cb129-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-101"><a href="#cb129-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-102"><a href="#cb129-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tipos_columnas</span></span>
<span id="cb129-103"><a href="#cb129-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-104"><a href="#cb129-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-105"><a href="#cb129-105" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-106"><a href="#cb129-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-107"><a href="#cb129-107" aria-hidden="true" tabindex="-1"></a>tipos <span class="op">=</span> train_val.dtypes.reset_index()</span>
<span id="cb129-108"><a href="#cb129-108" aria-hidden="true" tabindex="-1"></a>tipos.columns <span class="op">=</span> [<span class="st">'Columna'</span>, <span class="st">'Tipo de dato'</span>]</span>
<span id="cb129-109"><a href="#cb129-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-110"><a href="#cb129-110" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tipos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-111"><a href="#cb129-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-112"><a href="#cb129-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-113"><a href="#cb129-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-114"><a href="#cb129-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-115"><a href="#cb129-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distribución de registros por buque</span></span>
<span id="cb129-116"><a href="#cb129-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-119"><a href="#cb129-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-120"><a href="#cb129-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_secuencias</span></span>
<span id="cb129-121"><a href="#cb129-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-122"><a href="#cb129-122" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-123"><a href="#cb129-123" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-124"><a href="#cb129-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-125"><a href="#cb129-125" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb129-126"><a href="#cb129-126" aria-hidden="true" tabindex="-1"></a>tabla_freq <span class="op">=</span> registros_por_buque.value_counts().sort_index()</span>
<span id="cb129-127"><a href="#cb129-127" aria-hidden="true" tabindex="-1"></a>tabla_freq_df <span class="op">=</span> tabla_freq.reset_index()</span>
<span id="cb129-128"><a href="#cb129-128" aria-hidden="true" tabindex="-1"></a>tabla_freq_df.columns <span class="op">=</span> [<span class="st">"n_registros_por_buque"</span>, <span class="st">"n_buques"</span>]</span>
<span id="cb129-129"><a href="#cb129-129" aria-hidden="true" tabindex="-1"></a>tabla_freq_df <span class="op">=</span> tabla_freq_df.sort_values(by<span class="op">=</span><span class="st">"n_buques"</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-130"><a href="#cb129-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-131"><a href="#cb129-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-132"><a href="#cb129-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-133"><a href="#cb129-133" aria-hidden="true" tabindex="-1"></a>La tabla muestra que la mayoría de los buques tienen pocos registros, la mayor parte entre 1 y 5 pasos. Solo unos pocos buques tienen muchos registros (más de 50), lo que indica que unos pocos son muy activos mientras la mayoría realiza trayectorias cortas o tiene menos datos registrados</span>
<span id="cb129-134"><a href="#cb129-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-135"><a href="#cb129-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-136"><a href="#cb129-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-139"><a href="#cb129-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-140"><a href="#cb129-140" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: a_secuencias</span></span>
<span id="cb129-141"><a href="#cb129-141" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-142"><a href="#cb129-142" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-143"><a href="#cb129-143" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Tabla de registros por buque ordenada por n_buques:"</span>)</span>
<span id="cb129-144"><a href="#cb129-144" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_freq_df, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-145"><a href="#cb129-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-146"><a href="#cb129-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-147"><a href="#cb129-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-148"><a href="#cb129-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-149"><a href="#cb129-149" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gráfico de distribución de registros por buque</span></span>
<span id="cb129-150"><a href="#cb129-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-153"><a href="#cb129-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-154"><a href="#cb129-154" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_grafico</span></span>
<span id="cb129-155"><a href="#cb129-155" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-156"><a href="#cb129-156" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-157"><a href="#cb129-157" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb129-158"><a href="#cb129-158" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb129-159"><a href="#cb129-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-160"><a href="#cb129-160" aria-hidden="true" tabindex="-1"></a>tabla_freq_df[<span class="st">'n_buques_acum'</span>] <span class="op">=</span> tabla_freq_df[<span class="st">'n_buques'</span>].cumsum()</span>
<span id="cb129-161"><a href="#cb129-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-162"><a href="#cb129-162" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb129-163"><a href="#cb129-163" aria-hidden="true" tabindex="-1"></a>sns.barplot(</span>
<span id="cb129-164"><a href="#cb129-164" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>tabla_freq_df, </span>
<span id="cb129-165"><a href="#cb129-165" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'n_registros_por_buque'</span>, </span>
<span id="cb129-166"><a href="#cb129-166" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'n_buques'</span>, </span>
<span id="cb129-167"><a href="#cb129-167" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'steelblue'</span></span>
<span id="cb129-168"><a href="#cb129-168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-169"><a href="#cb129-169" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Número de registros por buque"</span>)</span>
<span id="cb129-170"><a href="#cb129-170" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Número de buques"</span>)</span>
<span id="cb129-171"><a href="#cb129-171" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribución de registros por buque (train_val)"</span>)</span>
<span id="cb129-172"><a href="#cb129-172" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb129-173"><a href="#cb129-173" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb129-174"><a href="#cb129-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-175"><a href="#cb129-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-176"><a href="#cb129-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-177"><a href="#cb129-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-178"><a href="#cb129-178" aria-hidden="true" tabindex="-1"></a><span class="fu">## Verificar viajes puerto–puerto</span></span>
<span id="cb129-179"><a href="#cb129-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-182"><a href="#cb129-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-183"><a href="#cb129-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_viajes_puerto</span></span>
<span id="cb129-184"><a href="#cb129-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-185"><a href="#cb129-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-186"><a href="#cb129-186" aria-hidden="true" tabindex="-1"></a>viajes_incompletos <span class="op">=</span> train_val[</span>
<span id="cb129-187"><a href="#cb129-187" aria-hidden="true" tabindex="-1"></a>    train_val[<span class="st">'port_before'</span>].isna() <span class="op">|</span> </span>
<span id="cb129-188"><a href="#cb129-188" aria-hidden="true" tabindex="-1"></a>    train_val[<span class="st">'port_after'</span>].isna()  <span class="op">|</span></span>
<span id="cb129-189"><a href="#cb129-189" aria-hidden="true" tabindex="-1"></a>    (train_val[<span class="st">'port_before'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>])) <span class="op">|</span></span>
<span id="cb129-190"><a href="#cb129-190" aria-hidden="true" tabindex="-1"></a>    (train_val[<span class="st">'port_after'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>]))</span>
<span id="cb129-191"><a href="#cb129-191" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb129-192"><a href="#cb129-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-193"><a href="#cb129-193" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cantidad de registros con viajes incompletos (puertos faltantes o desconocidos):"</span>, <span class="bu">len</span>(viajes_incompletos))</span>
<span id="cb129-194"><a href="#cb129-194" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(</span>
<span id="cb129-195"><a href="#cb129-195" aria-hidden="true" tabindex="-1"></a>    viajes_incompletos[[<span class="st">'mmsi'</span>,<span class="st">'port_before'</span>,<span class="st">'port_after'</span>]].head(<span class="dv">10</span>),</span>
<span id="cb129-196"><a href="#cb129-196" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span><span class="st">'keys'</span>,</span>
<span id="cb129-197"><a href="#cb129-197" aria-hidden="true" tabindex="-1"></a>    tablefmt<span class="op">=</span><span class="st">'psql'</span></span>
<span id="cb129-198"><a href="#cb129-198" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb129-199"><a href="#cb129-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-200"><a href="#cb129-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-201"><a href="#cb129-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-202"><a href="#cb129-202" aria-hidden="true" tabindex="-1"></a>**“Todos los registros de viajes de puerto a puerto están completos; cada buque tiene correctamente registrado su puerto de salida y de llegada, sin información faltante ni desconocida.”**</span>
<span id="cb129-203"><a href="#cb129-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-204"><a href="#cb129-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-205"><a href="#cb129-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-206"><a href="#cb129-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-207"><a href="#cb129-207" aria-hidden="true" tabindex="-1"></a><span class="fu">## Revisar consumos de energía</span></span>
<span id="cb129-208"><a href="#cb129-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-211"><a href="#cb129-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-212"><a href="#cb129-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_consumos</span></span>
<span id="cb129-213"><a href="#cb129-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-214"><a href="#cb129-214" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-215"><a href="#cb129-215" aria-hidden="true" tabindex="-1"></a>cols_energia <span class="op">=</span> [<span class="st">'sum_me_ene'</span>,<span class="st">'sum_ae_ene'</span>,<span class="st">'sum_ab_ene'</span>]</span>
<span id="cb129-216"><a href="#cb129-216" aria-hidden="true" tabindex="-1"></a>resumen_consumos <span class="op">=</span> []</span>
<span id="cb129-217"><a href="#cb129-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-218"><a href="#cb129-218" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cols_energia:</span>
<span id="cb129-219"><a href="#cb129-219" aria-hidden="true" tabindex="-1"></a>    n_nulos <span class="op">=</span> train_val[col].isna().<span class="bu">sum</span>()</span>
<span id="cb129-220"><a href="#cb129-220" aria-hidden="true" tabindex="-1"></a>    n_cero  <span class="op">=</span> (train_val[col] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb129-221"><a href="#cb129-221" aria-hidden="true" tabindex="-1"></a>    n_neg   <span class="op">=</span> (train_val[col] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb129-222"><a href="#cb129-222" aria-hidden="true" tabindex="-1"></a>    resumen_consumos.append([col, n_nulos, n_cero, n_neg])</span>
<span id="cb129-223"><a href="#cb129-223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-224"><a href="#cb129-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-227"><a href="#cb129-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-228"><a href="#cb129-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: e_consumos</span></span>
<span id="cb129-229"><a href="#cb129-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-230"><a href="#cb129-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-231"><a href="#cb129-231" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores nulos, cero y negativos en consumos:"</span>)</span>
<span id="cb129-232"><a href="#cb129-232" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_consumos, headers<span class="op">=</span>[<span class="st">"Columna"</span>,<span class="st">"Nulos"</span>,<span class="st">"Ceros"</span>,<span class="st">"Negativos"</span>], tablefmt<span class="op">=</span><span class="st">"psql"</span>))</span>
<span id="cb129-233"><a href="#cb129-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-234"><a href="#cb129-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-235"><a href="#cb129-235" aria-hidden="true" tabindex="-1"></a>Los consumos de energía son consistentes: ninguna columna tiene valores negativos, aunque <span class="in">`sum_me_ene`</span> presenta 71 valores nulos y 13,973 registros con consumo cero, <span class="in">`sum_ae_ene`</span> tiene 7,513 registros con consumo cero, y <span class="in">`sum_ab_ene`</span> cuenta con 15,753 registros con consumo cero.</span>
<span id="cb129-236"><a href="#cb129-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-237"><a href="#cb129-237" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb129-240"><a href="#cb129-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-241"><a href="#cb129-241" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: d_consumos</span></span>
<span id="cb129-242"><a href="#cb129-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-243"><a href="#cb129-243" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-244"><a href="#cb129-244" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Resumen estadístico de consumos energéticos:"</span>)</span>
<span id="cb129-245"><a href="#cb129-245" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(train_val[cols_energia].describe().reset_index(), headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-246"><a href="#cb129-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-247"><a href="#cb129-247" aria-hidden="true" tabindex="-1"></a>Los consumos de energía varían mucho entre los registros. Muchos viajes registran cero consumo, mientras que unos pocos tienen consumos muy altos, lo que eleva el promedio. En general, la mayoría de los viajes usan poca energía, pero existen algunos casos con consumos significativamente mayores.</span>
<span id="cb129-248"><a href="#cb129-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-249"><a href="#cb129-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-250"><a href="#cb129-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-251"><a href="#cb129-251" aria-hidden="true" tabindex="-1"></a><span class="fu">## Duración de viajes puerto–puerto</span></span>
<span id="cb129-252"><a href="#cb129-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-255"><a href="#cb129-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-256"><a href="#cb129-256" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_duracion_viajes</span></span>
<span id="cb129-257"><a href="#cb129-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-258"><a href="#cb129-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-259"><a href="#cb129-259" aria-hidden="true" tabindex="-1"></a>mmsi_validos <span class="op">=</span> train_val[<span class="st">'mmsi'</span>].value_counts()</span>
<span id="cb129-260"><a href="#cb129-260" aria-hidden="true" tabindex="-1"></a>mmsi_validos <span class="op">=</span> mmsi_validos[mmsi_validos <span class="op">&gt;=</span> <span class="dv">12</span>].index</span>
<span id="cb129-261"><a href="#cb129-261" aria-hidden="true" tabindex="-1"></a>df_filtrado <span class="op">=</span> train_val[train_val[<span class="st">'mmsi'</span>].isin(mmsi_validos)].copy()</span>
<span id="cb129-262"><a href="#cb129-262" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_viaje_horas'</span>] <span class="op">=</span> (</span>
<span id="cb129-263"><a href="#cb129-263" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> <span class="dv">3600</span></span>
<span id="cb129-264"><a href="#cb129-264" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-265"><a href="#cb129-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-266"><a href="#cb129-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-267"><a href="#cb129-267" aria-hidden="true" tabindex="-1"></a>La duración de los tramos de viaje entre puertos varía mucho: van desde unas 44 horas hasta más de 2,000 horas, con la mayoría de los tramos entre 200 y 600 horas y un promedio de unas 430 horas</span>
<span id="cb129-268"><a href="#cb129-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-271"><a href="#cb129-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-272"><a href="#cb129-272" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: duracion_horas</span></span>
<span id="cb129-273"><a href="#cb129-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-274"><a href="#cb129-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-275"><a href="#cb129-275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Distribución de duración de viajes (horas):"</span>)</span>
<span id="cb129-276"><a href="#cb129-276" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(df_filtrado[<span class="st">'duracion_viaje_horas'</span>].describe().reset_index(),</span>
<span id="cb129-277"><a href="#cb129-277" aria-hidden="true" tabindex="-1"></a>               headers<span class="op">=</span>[<span class="st">'Métrica'</span>,<span class="st">'Valor'</span>],</span>
<span id="cb129-278"><a href="#cb129-278" aria-hidden="true" tabindex="-1"></a>               tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-279"><a href="#cb129-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-280"><a href="#cb129-280" aria-hidden="true" tabindex="-1"></a>La duración de los viajes varía ampliamente, desde unas 44 horas hasta más de 2,000 horas, con la mayoría de los viajes entre 200 y 600 horas y un promedio de aproximadamente 430 horas.</span>
<span id="cb129-281"><a href="#cb129-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-282"><a href="#cb129-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-283"><a href="#cb129-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-286"><a href="#cb129-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-287"><a href="#cb129-287" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_frecuencia_duracion_dias</span></span>
<span id="cb129-288"><a href="#cb129-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-289"><a href="#cb129-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-290"><a href="#cb129-290" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_viaje_dias'</span>] <span class="op">=</span> (</span>
<span id="cb129-291"><a href="#cb129-291" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)</span>
<span id="cb129-292"><a href="#cb129-292" aria-hidden="true" tabindex="-1"></a>).astype(<span class="bu">int</span>)</span>
<span id="cb129-293"><a href="#cb129-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-294"><a href="#cb129-294" aria-hidden="true" tabindex="-1"></a>tabla_frec <span class="op">=</span> df_filtrado[<span class="st">'duracion_viaje_dias'</span>].value_counts().reset_index()</span>
<span id="cb129-295"><a href="#cb129-295" aria-hidden="true" tabindex="-1"></a>tabla_frec.columns <span class="op">=</span> [<span class="st">'Duración (días)'</span>, <span class="st">'Cantidad de viajes'</span>]</span>
<span id="cb129-296"><a href="#cb129-296" aria-hidden="true" tabindex="-1"></a>tabla_frec <span class="op">=</span> tabla_frec.sort_values(<span class="st">'Cantidad de viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-297"><a href="#cb129-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-298"><a href="#cb129-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-299"><a href="#cb129-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-300"><a href="#cb129-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-303"><a href="#cb129-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-304"><a href="#cb129-304" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: duracion_dias</span></span>
<span id="cb129-305"><a href="#cb129-305" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-306"><a href="#cb129-306" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-307"><a href="#cb129-307" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frecuencia de duración de viajes (en días) ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb129-308"><a href="#cb129-308" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-309"><a href="#cb129-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-310"><a href="#cb129-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-311"><a href="#cb129-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-312"><a href="#cb129-312" aria-hidden="true" tabindex="-1"></a>La mayoría de los tramos de viaje entre puertos duran entre 5 y 7 días, siendo 6 días el más frecuente. Sin embargo, también hay viajes mucho más largos, algunos de hasta 86 días, lo que muestra que mientras la mayoría de los tramos son relativamente cortos, existen casos con duraciones significativamente mayores</span>
<span id="cb129-313"><a href="#cb129-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-314"><a href="#cb129-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-315"><a href="#cb129-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-318"><a href="#cb129-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-319"><a href="#cb129-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_duracion_horas</span></span>
<span id="cb129-320"><a href="#cb129-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-321"><a href="#cb129-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-322"><a href="#cb129-322" aria-hidden="true" tabindex="-1"></a>df_filtrado <span class="op">=</span> df_filtrado[</span>
<span id="cb129-323"><a href="#cb129-323" aria-hidden="true" tabindex="-1"></a>    df_filtrado[<span class="st">'port_before'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb129-324"><a href="#cb129-324" aria-hidden="true" tabindex="-1"></a>    df_filtrado[<span class="st">'port_after'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb129-325"><a href="#cb129-325" aria-hidden="true" tabindex="-1"></a>    (<span class="op">~</span>df_filtrado[<span class="st">'port_before'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>])) <span class="op">&amp;</span></span>
<span id="cb129-326"><a href="#cb129-326" aria-hidden="true" tabindex="-1"></a>    (<span class="op">~</span>df_filtrado[<span class="st">'port_after'</span>].<span class="bu">str</span>.lower().isin([<span class="st">''</span>, <span class="st">'desconocido'</span>]))</span>
<span id="cb129-327"><a href="#cb129-327" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb129-328"><a href="#cb129-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-329"><a href="#cb129-329" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_horas'</span>] <span class="op">=</span> (</span>
<span id="cb129-330"><a href="#cb129-330" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> <span class="dv">3600</span></span>
<span id="cb129-331"><a href="#cb129-331" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-332"><a href="#cb129-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-333"><a href="#cb129-333" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas <span class="op">=</span> df_filtrado.groupby([<span class="st">'port_before'</span>,<span class="st">'port_after'</span>,<span class="st">'duracion_horas'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'cantidad_viajes'</span>)</span>
<span id="cb129-334"><a href="#cb129-334" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas <span class="op">=</span> tabla_frec_horas.sort_values(<span class="st">'cantidad_viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-335"><a href="#cb129-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-336"><a href="#cb129-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-339"><a href="#cb129-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-340"><a href="#cb129-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: on_horas</span></span>
<span id="cb129-341"><a href="#cb129-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-342"><a href="#cb129-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-343"><a href="#cb129-343" aria-hidden="true" tabindex="-1"></a>tabla_frec_horas_top10 <span class="op">=</span> tabla_frec_horas.head(<span class="dv">10</span>)</span>
<span id="cb129-344"><a href="#cb129-344" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frecuencia de duración de viajes (horas) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb129-345"><a href="#cb129-345" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec_horas_top10, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-346"><a href="#cb129-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-347"><a href="#cb129-347" aria-hidden="true" tabindex="-1"></a>Los datos muestran los **tramos de viaje más frecuentes entre puertos** y su duración en horas. Por ejemplo, los viajes dentro de **Chiriquí Grande** son los más repetidos, con varias duraciones registradas (alrededor de 325–570 horas). Otros tramos frecuentes incluyen rutas como **Mariel → Puerto de Hencan** o **Santa Marta → Georgetown**, con duraciones más largas, entre 800 y 1,500 horas. Esto indica que algunos trayectos son recorridos muy a menudo, mientras que otros, aunque menos frecuentes, implican viajes más largos.</span>
<span id="cb129-348"><a href="#cb129-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-349"><a href="#cb129-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-350"><a href="#cb129-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-353"><a href="#cb129-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-354"><a href="#cb129-354" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_duracion_dias</span></span>
<span id="cb129-355"><a href="#cb129-355" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-356"><a href="#cb129-356" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-357"><a href="#cb129-357" aria-hidden="true" tabindex="-1"></a>df_filtrado[<span class="st">'duracion_dias'</span>] <span class="op">=</span> ((df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb129-358"><a href="#cb129-358" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias <span class="op">=</span> df_filtrado.groupby([<span class="st">'port_before'</span>,<span class="st">'port_after'</span>,<span class="st">'duracion_dias'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'cantidad_viajes'</span>)</span>
<span id="cb129-359"><a href="#cb129-359" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias <span class="op">=</span> tabla_frec_dias.sort_values(<span class="st">'cantidad_viajes'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-360"><a href="#cb129-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-361"><a href="#cb129-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-364"><a href="#cb129-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-365"><a href="#cb129-365" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: puerto</span></span>
<span id="cb129-366"><a href="#cb129-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-367"><a href="#cb129-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-368"><a href="#cb129-368" aria-hidden="true" tabindex="-1"></a>tabla_frec_dias_top10 <span class="op">=</span> tabla_frec_dias.head(<span class="dv">10</span>)</span>
<span id="cb129-369"><a href="#cb129-369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top 10 frecuencia de duración de viajes (días) puerto-&gt;puerto ordenada de mayor a menor cantidad de viajes:"</span>)</span>
<span id="cb129-370"><a href="#cb129-370" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(tabla_frec_dias_top10, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-371"><a href="#cb129-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-372"><a href="#cb129-372" aria-hidden="true" tabindex="-1"></a>Los datos muestran los **trayectos puerto a puerto más frecuentes y su duración en días**. Por ejemplo, el viaje **Manzanillo → Kingston** es el más común, con 206 registros y una duración de 10 días. Otros trayectos frecuentes incluyen **Puerto San Antonio → Freeport** (11 días) y **Andrés LNG Terminal ↔ Buenaventura** (5–6 días). Esto refleja que algunos recorridos son muy habituales, mientras que otros, aunque menos frecuentes, pueden durar hasta varias semanas.</span>
<span id="cb129-373"><a href="#cb129-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-374"><a href="#cb129-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-375"><a href="#cb129-375" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis de viajes específicos puerto–puerto</span></span>
<span id="cb129-376"><a href="#cb129-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-379"><a href="#cb129-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-380"><a href="#cb129-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eda_inspeccionar</span></span>
<span id="cb129-381"><a href="#cb129-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-382"><a href="#cb129-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-383"><a href="#cb129-383" aria-hidden="true" tabindex="-1"></a>puerto_inicio <span class="op">=</span> <span class="st">"MANZANILLO"</span></span>
<span id="cb129-384"><a href="#cb129-384" aria-hidden="true" tabindex="-1"></a>puerto_fin    <span class="op">=</span> <span class="st">"KINGSTON"</span></span>
<span id="cb129-385"><a href="#cb129-385" aria-hidden="true" tabindex="-1"></a>dias_viaje    <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb129-386"><a href="#cb129-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-387"><a href="#cb129-387" aria-hidden="true" tabindex="-1"></a>viajes_filtrados <span class="op">=</span> df_filtrado[</span>
<span id="cb129-388"><a href="#cb129-388" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'port_before'</span>] <span class="op">==</span> puerto_inicio) <span class="op">&amp;</span></span>
<span id="cb129-389"><a href="#cb129-389" aria-hidden="true" tabindex="-1"></a>    (df_filtrado[<span class="st">'port_after'</span>] <span class="op">==</span> puerto_fin) <span class="op">&amp;</span></span>
<span id="cb129-390"><a href="#cb129-390" aria-hidden="true" tabindex="-1"></a>    (((df_filtrado[<span class="st">'end_leg'</span>] <span class="op">-</span> df_filtrado[<span class="st">'start_leg'</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>)).astype(<span class="bu">int</span>) <span class="op">==</span> dias_viaje)</span>
<span id="cb129-391"><a href="#cb129-391" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb129-392"><a href="#cb129-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-393"><a href="#cb129-393" aria-hidden="true" tabindex="-1"></a>resumen_mmsi <span class="op">=</span> viajes_filtrados.groupby(<span class="st">'mmsi'</span>).size().reset_index(name<span class="op">=</span><span class="st">'registros_viaje'</span>)</span>
<span id="cb129-394"><a href="#cb129-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-395"><a href="#cb129-395" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Barcos que hicieron el viaje </span><span class="sc">{</span>puerto_inicio<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>puerto_fin<span class="sc">}</span><span class="ss"> en </span><span class="sc">{</span>dias_viaje<span class="sc">}</span><span class="ss"> días:"</span>)</span>
<span id="cb129-396"><a href="#cb129-396" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_mmsi, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-397"><a href="#cb129-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-398"><a href="#cb129-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-399"><a href="#cb129-399" aria-hidden="true" tabindex="-1"></a>El análisis muestra qué barcos realizaron el trayecto **Manzanillo → Kingston en exactamente 10 días**. Por ejemplo, algunos barcos completaron el viaje varias veces, con registros que van de 11 a 30 tramos por barco. Esto indica que hay rutas muy recurrentes y que ciertos buques realizan este viaje de manera repetida dentro del periodo analizado.</span>
<span id="cb129-400"><a href="#cb129-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-401"><a href="#cb129-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-402"><a href="#cb129-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-403"><a href="#cb129-403" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cuántos buques tienen secuencias</span></span>
<span id="cb129-404"><a href="#cb129-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-407"><a href="#cb129-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-408"><a href="#cb129-408" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: n_buques</span></span>
<span id="cb129-409"><a href="#cb129-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-410"><a href="#cb129-410" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-411"><a href="#cb129-411" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb129-412"><a href="#cb129-412" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">20</span>]</span>
<span id="cb129-413"><a href="#cb129-413" aria-hidden="true" tabindex="-1"></a>resumen_secuencias <span class="op">=</span> []</span>
<span id="cb129-414"><a href="#cb129-414" aria-hidden="true" tabindex="-1"></a>total_buques <span class="op">=</span> <span class="bu">len</span>(registros_por_buque)</span>
<span id="cb129-415"><a href="#cb129-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-416"><a href="#cb129-416" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> l <span class="kw">in</span> longitudes:</span>
<span id="cb129-417"><a href="#cb129-417" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> (registros_por_buque <span class="op">&gt;=</span> l).<span class="bu">sum</span>()</span>
<span id="cb129-418"><a href="#cb129-418" aria-hidden="true" tabindex="-1"></a>    porcentaje <span class="op">=</span> n_buques <span class="op">/</span> total_buques <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb129-419"><a href="#cb129-419" aria-hidden="true" tabindex="-1"></a>    resumen_secuencias.append([l, n_buques, porcentaje])</span>
<span id="cb129-420"><a href="#cb129-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-421"><a href="#cb129-421" aria-hidden="true" tabindex="-1"></a>resumen_df <span class="op">=</span> pd.DataFrame(resumen_secuencias, columns<span class="op">=</span>[<span class="st">'Min Registros'</span>, <span class="st">'N° Buques'</span>, <span class="st">'Porcentaje (%)'</span>])</span>
<span id="cb129-422"><a href="#cb129-422" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(resumen_df)</span>
<span id="cb129-423"><a href="#cb129-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-424"><a href="#cb129-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-425"><a href="#cb129-425" aria-hidden="true" tabindex="-1"></a>El análisis muestra **cuántos buques tienen distintos niveles de registros en los datos**. Todos los buques (2,754) aparecen al menos una vez, pero conforme pedimos más registros por buque, el número disminuye: alrededor de la mitad tiene 5 o más registros, un cuarto tiene 10 o más, y solo un pequeño grupo (11 %) tiene 20 o más registros. Esto indica que mientras muchos buques aparecen pocas veces, algunos cuentan con series de datos más largas y consistentes.</span>
<span id="cb129-426"><a href="#cb129-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-427"><a href="#cb129-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-430"><a href="#cb129-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-431"><a href="#cb129-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: registros_por</span></span>
<span id="cb129-432"><a href="#cb129-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-433"><a href="#cb129-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-434"><a href="#cb129-434" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">15</span>]</span>
<span id="cb129-435"><a href="#cb129-435" aria-hidden="true" tabindex="-1"></a>registros_por_buque <span class="op">=</span> train_val.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb129-436"><a href="#cb129-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-437"><a href="#cb129-437" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> longitudes:</span>
<span id="cb129-438"><a href="#cb129-438" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> (registros_por_buque <span class="op">&gt;=</span> n).<span class="bu">sum</span>()</span>
<span id="cb129-439"><a href="#cb129-439" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Buques con al menos </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> registros: </span><span class="sc">{</span>n_buques<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-440"><a href="#cb129-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-441"><a href="#cb129-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-444"><a href="#cb129-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-445"><a href="#cb129-445" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: registros_por_buque</span></span>
<span id="cb129-446"><a href="#cb129-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-447"><a href="#cb129-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-448"><a href="#cb129-448" aria-hidden="true" tabindex="-1"></a>longitudes <span class="op">=</span> [ <span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>, <span class="dv">12</span>]</span>
<span id="cb129-449"><a href="#cb129-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-450"><a href="#cb129-450" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> longitudes:</span>
<span id="cb129-451"><a href="#cb129-451" aria-hidden="true" tabindex="-1"></a>    buques_validos <span class="op">=</span> registros_por_buque[registros_por_buque <span class="op">&gt;=</span> n].index</span>
<span id="cb129-452"><a href="#cb129-452" aria-hidden="true" tabindex="-1"></a>    df_filtrado <span class="op">=</span> train_val[train_val[<span class="st">'mmsi'</span>].isin(buques_validos)]</span>
<span id="cb129-453"><a href="#cb129-453" aria-hidden="true" tabindex="-1"></a>    n_filas <span class="op">=</span> <span class="bu">len</span>(df_filtrado)</span>
<span id="cb129-454"><a href="#cb129-454" aria-hidden="true" tabindex="-1"></a>    n_buques <span class="op">=</span> <span class="bu">len</span>(buques_validos)</span>
<span id="cb129-455"><a href="#cb129-455" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Secuencia </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>n_buques<span class="sc">}</span><span class="ss"> buques, </span><span class="sc">{</span>n_filas<span class="sc">}</span><span class="ss"> filas"</span>)</span>
<span id="cb129-456"><a href="#cb129-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-457"><a href="#cb129-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-458"><a href="#cb129-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-459"><a href="#cb129-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-460"><a href="#cb129-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-461"><a href="#cb129-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creación de la variable objetivo: CO2\_emission</span></span>
<span id="cb129-462"><a href="#cb129-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-465"><a href="#cb129-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-466"><a href="#cb129-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_target_emisiones</span></span>
<span id="cb129-467"><a href="#cb129-467" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-468"><a href="#cb129-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-469"><a href="#cb129-469" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crear_target_emisiones(df, sfoc_me<span class="op">=</span><span class="fl">0.2</span>, sfoc_ae<span class="op">=</span><span class="fl">0.22</span>, sfoc_ab<span class="op">=</span><span class="fl">0.25</span>, factor_emision<span class="op">=</span><span class="fl">3.17</span>):</span>
<span id="cb129-470"><a href="#cb129-470" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb129-471"><a href="#cb129-471" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_me'</span>] <span class="op">=</span> df[<span class="st">'sum_me_ene'</span>] <span class="op">*</span> sfoc_me</span>
<span id="cb129-472"><a href="#cb129-472" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_ae'</span>] <span class="op">=</span> df[<span class="st">'sum_ae_ene'</span>] <span class="op">*</span> sfoc_ae</span>
<span id="cb129-473"><a href="#cb129-473" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'combustible_ab'</span>] <span class="op">=</span> df[<span class="st">'sum_ab_ene'</span>] <span class="op">*</span> sfoc_ab</span>
<span id="cb129-474"><a href="#cb129-474" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'fuel_consumption'</span>] <span class="op">=</span> df[<span class="st">'combustible_me'</span>] <span class="op">+</span> df[<span class="st">'combustible_ae'</span>] <span class="op">+</span> df[<span class="st">'combustible_ab'</span>]</span>
<span id="cb129-475"><a href="#cb129-475" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CO2_emission'</span>] <span class="op">=</span> df[<span class="st">'fuel_consumption'</span>] <span class="op">*</span> factor_emision</span>
<span id="cb129-476"><a href="#cb129-476" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb129-477"><a href="#cb129-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-478"><a href="#cb129-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-479"><a href="#cb129-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-480"><a href="#cb129-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-483"><a href="#cb129-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-484"><a href="#cb129-484" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: target_emisiones</span></span>
<span id="cb129-485"><a href="#cb129-485" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-486"><a href="#cb129-486" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-487"><a href="#cb129-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-488"><a href="#cb129-488" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> crear_target_emisiones(train_val)</span>
<span id="cb129-489"><a href="#cb129-489" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">'CO2_emission'</span></span>
<span id="cb129-490"><a href="#cb129-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-491"><a href="#cb129-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-492"><a href="#cb129-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-493"><a href="#cb129-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-494"><a href="#cb129-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-495"><a href="#cb129-495" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Bloque 1: Ver ceros en CO2\_emission**</span></span>
<span id="cb129-496"><a href="#cb129-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-499"><a href="#cb129-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-500"><a href="#cb129-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: inspeccionar_ceros</span></span>
<span id="cb129-501"><a href="#cb129-501" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-502"><a href="#cb129-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-503"><a href="#cb129-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-504"><a href="#cb129-504" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar ceros en la variable objetivo</span></span>
<span id="cb129-505"><a href="#cb129-505" aria-hidden="true" tabindex="-1"></a>ceros_target <span class="op">=</span> (train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb129-506"><a href="#cb129-506" aria-hidden="true" tabindex="-1"></a>porc_ceros <span class="op">=</span> ceros_target <span class="op">/</span> <span class="bu">len</span>(train_val_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb129-507"><a href="#cb129-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-508"><a href="#cb129-508" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Registros con CO2_emission = 0: </span><span class="sc">{</span>ceros_target<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>porc_ceros<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb129-509"><a href="#cb129-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-510"><a href="#cb129-510" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspeccionar algunos registros con cero</span></span>
<span id="cb129-511"><a href="#cb129-511" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Primeros registros con CO2_emission = 0:"</span>)</span>
<span id="cb129-512"><a href="#cb129-512" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_val_filtrado[train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>].head())</span>
<span id="cb129-513"><a href="#cb129-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-514"><a href="#cb129-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-515"><a href="#cb129-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-516"><a href="#cb129-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-519"><a href="#cb129-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-520"><a href="#cb129-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mmsi_con_ceros</span></span>
<span id="cb129-521"><a href="#cb129-521" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-522"><a href="#cb129-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-523"><a href="#cb129-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-524"><a href="#cb129-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar registros con CO2_emission = 0</span></span>
<span id="cb129-525"><a href="#cb129-525" aria-hidden="true" tabindex="-1"></a>df_ceros <span class="op">=</span> train_val_filtrado[train_val_filtrado[target] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb129-526"><a href="#cb129-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-527"><a href="#cb129-527" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuántos MMSI distintos tienen registros con cero</span></span>
<span id="cb129-528"><a href="#cb129-528" aria-hidden="true" tabindex="-1"></a>mmsi_ceros <span class="op">=</span> df_ceros[<span class="st">'mmsi'</span>].nunique()</span>
<span id="cb129-529"><a href="#cb129-529" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Número de buques (mmsi) con al menos un CO2_emission = 0: </span><span class="sc">{</span>mmsi_ceros<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-530"><a href="#cb129-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-531"><a href="#cb129-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar registros con cero por buque</span></span>
<span id="cb129-532"><a href="#cb129-532" aria-hidden="true" tabindex="-1"></a>registros_ceros_por_mmsi <span class="op">=</span> df_ceros.groupby(<span class="st">'mmsi'</span>).size().reset_index(name<span class="op">=</span><span class="st">'registros_cero'</span>)</span>
<span id="cb129-533"><a href="#cb129-533" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Registros con CO2_emission = 0 por buque (top 10):"</span>)</span>
<span id="cb129-534"><a href="#cb129-534" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(registros_ceros_por_mmsi.sort_values(<span class="st">'registros_cero'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>))</span>
<span id="cb129-535"><a href="#cb129-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-536"><a href="#cb129-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-537"><a href="#cb129-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-538"><a href="#cb129-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-541"><a href="#cb129-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-542"><a href="#cb129-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mmsi_con_ceros_todos</span></span>
<span id="cb129-543"><a href="#cb129-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-544"><a href="#cb129-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-545"><a href="#cb129-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-546"><a href="#cb129-546" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(registros_ceros_por_mmsi.sort_values(<span class="st">'registros_cero'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb129-547"><a href="#cb129-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-548"><a href="#cb129-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-549"><a href="#cb129-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-550"><a href="#cb129-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-551"><a href="#cb129-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-554"><a href="#cb129-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-555"><a href="#cb129-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: resumen_mmsi_ceros</span></span>
<span id="cb129-556"><a href="#cb129-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-557"><a href="#cb129-557" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-558"><a href="#cb129-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-559"><a href="#cb129-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Total de buques únicos</span></span>
<span id="cb129-560"><a href="#cb129-560" aria-hidden="true" tabindex="-1"></a>total_mmsi <span class="op">=</span> train_val_filtrado[<span class="st">'mmsi'</span>].nunique()</span>
<span id="cb129-561"><a href="#cb129-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-562"><a href="#cb129-562" aria-hidden="true" tabindex="-1"></a><span class="co"># Buques con al menos un cero</span></span>
<span id="cb129-563"><a href="#cb129-563" aria-hidden="true" tabindex="-1"></a>mmsi_con_ceros <span class="op">=</span> train_val_filtrado.loc[train_val_filtrado[<span class="st">'CO2_emission'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'mmsi'</span>].nunique()</span>
<span id="cb129-564"><a href="#cb129-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-565"><a href="#cb129-565" aria-hidden="true" tabindex="-1"></a><span class="co"># Buques sin ceros</span></span>
<span id="cb129-566"><a href="#cb129-566" aria-hidden="true" tabindex="-1"></a>mmsi_sin_ceros <span class="op">=</span> total_mmsi <span class="op">-</span> mmsi_con_ceros</span>
<span id="cb129-567"><a href="#cb129-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-568"><a href="#cb129-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Armar tabla resumen</span></span>
<span id="cb129-569"><a href="#cb129-569" aria-hidden="true" tabindex="-1"></a>resumen_mmsi <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-570"><a href="#cb129-570" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grupo"</span>: [<span class="st">"Con ceros"</span>, <span class="st">"Sin ceros"</span>],</span>
<span id="cb129-571"><a href="#cb129-571" aria-hidden="true" tabindex="-1"></a>    <span class="st">"count_mmsi"</span>: [mmsi_con_ceros, mmsi_sin_ceros],</span>
<span id="cb129-572"><a href="#cb129-572" aria-hidden="true" tabindex="-1"></a>    <span class="st">"porcentaje"</span>: [mmsi_con_ceros<span class="op">/</span>total_mmsi<span class="op">*</span><span class="dv">100</span>, mmsi_sin_ceros<span class="op">/</span>total_mmsi<span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb129-573"><a href="#cb129-573" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-574"><a href="#cb129-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-575"><a href="#cb129-575" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total buques únicos (mmsi): </span><span class="sc">{</span>total_mmsi<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb129-576"><a href="#cb129-576" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(resumen_mmsi.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{<span class="st">"porcentaje"</span>: <span class="st">"</span><span class="sc">{:.2f}</span><span class="st">%"</span>.<span class="bu">format</span>}))</span>
<span id="cb129-577"><a href="#cb129-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-578"><a href="#cb129-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-579"><a href="#cb129-579" aria-hidden="true" tabindex="-1"></a>casi 3 de cada 10 buques pasan por situaciones de “cero emisiones” (posible parada, fondeo, error o falta de consumo registrado).</span>
<span id="cb129-580"><a href="#cb129-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-581"><a href="#cb129-581" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Eliminar registros con cero**</span></span>
<span id="cb129-582"><a href="#cb129-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-585"><a href="#cb129-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-586"><a href="#cb129-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eliminar_ceros</span></span>
<span id="cb129-587"><a href="#cb129-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-588"><a href="#cb129-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-589"><a href="#cb129-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-590"><a href="#cb129-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar filas donde CO2_emission es cero</span></span>
<span id="cb129-591"><a href="#cb129-591" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> train_val_filtrado[train_val_filtrado[target] <span class="op">!=</span> <span class="dv">0</span>].copy()</span>
<span id="cb129-592"><a href="#cb129-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-593"><a href="#cb129-593" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después de eliminar ceros en CO2_emission: </span><span class="sc">{</span><span class="bu">len</span>(train_val_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-594"><a href="#cb129-594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-595"><a href="#cb129-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-596"><a href="#cb129-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-597"><a href="#cb129-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-598"><a href="#cb129-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-599"><a href="#cb129-599" aria-hidden="true" tabindex="-1"></a><span class="fu">## Limpieza de NaN en target y verificación de secuencias mínimas</span></span>
<span id="cb129-600"><a href="#cb129-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-603"><a href="#cb129-603" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-604"><a href="#cb129-604" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: limpieza_nan_target</span></span>
<span id="cb129-605"><a href="#cb129-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-606"><a href="#cb129-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-607"><a href="#cb129-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar filas donde CO2_emission es NaN</span></span>
<span id="cb129-608"><a href="#cb129-608" aria-hidden="true" tabindex="-1"></a>train_val_target <span class="op">=</span> train_val_filtrado[train_val_filtrado[target].notna()].copy()</span>
<span id="cb129-609"><a href="#cb129-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-610"><a href="#cb129-610" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">4</span>  <span class="co"># longitud mínima de secuencia</span></span>
<span id="cb129-611"><a href="#cb129-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-612"><a href="#cb129-612" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar buques válidos antes y después de eliminar NaN</span></span>
<span id="cb129-613"><a href="#cb129-613" aria-hidden="true" tabindex="-1"></a>registros_por_buque_orig <span class="op">=</span> train_val_filtrado.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb129-614"><a href="#cb129-614" aria-hidden="true" tabindex="-1"></a>buques_validos_orig <span class="op">=</span> (registros_por_buque_orig <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb129-615"><a href="#cb129-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-616"><a href="#cb129-616" aria-hidden="true" tabindex="-1"></a>registros_por_buque_filtrado <span class="op">=</span> train_val_target.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb129-617"><a href="#cb129-617" aria-hidden="true" tabindex="-1"></a>buques_validos_filtrado <span class="op">=</span> (registros_por_buque_filtrado <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb129-618"><a href="#cb129-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-619"><a href="#cb129-619" aria-hidden="true" tabindex="-1"></a>resumen <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-620"><a href="#cb129-620" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'Original'</span>, <span class="st">'Filtrado por target'</span>],</span>
<span id="cb129-621"><a href="#cb129-621" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Buques válidos'</span>: [buques_validos_orig, buques_validos_filtrado],</span>
<span id="cb129-622"><a href="#cb129-622" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(train_val_filtrado), <span class="bu">len</span>(train_val_target)]</span>
<span id="cb129-623"><a href="#cb129-623" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-624"><a href="#cb129-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-625"><a href="#cb129-625" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-626"><a href="#cb129-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-627"><a href="#cb129-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-628"><a href="#cb129-628" aria-hidden="true" tabindex="-1"></a>Al filtrar los valores faltantes, quedarán 19,961 registros y 2,074 buques válidos. Esto significará que se habrán eliminado 71 registros individuales y 12 buques completos que ya no tendrán suficientes datos para formar secuencias mínimas.</span>
<span id="cb129-629"><a href="#cb129-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-630"><a href="#cb129-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-631"><a href="#cb129-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-632"><a href="#cb129-632" aria-hidden="true" tabindex="-1"></a><span class="fu">## Recorte de buques que no cumplen la longitud mínima</span></span>
<span id="cb129-633"><a href="#cb129-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-636"><a href="#cb129-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-637"><a href="#cb129-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recorte_buques_min</span></span>
<span id="cb129-638"><a href="#cb129-638" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-639"><a href="#cb129-639" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-640"><a href="#cb129-640" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para filtrar buques por cantidad mínima de registros</span></span>
<span id="cb129-641"><a href="#cb129-641" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filtrar_buques_por_min_registros(df, min_registros<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb129-642"><a href="#cb129-642" aria-hidden="true" tabindex="-1"></a>    registros_por_buque <span class="op">=</span> df.groupby(<span class="st">"mmsi"</span>).size()</span>
<span id="cb129-643"><a href="#cb129-643" aria-hidden="true" tabindex="-1"></a>    buques_validos <span class="op">=</span> registros_por_buque[registros_por_buque <span class="op">&gt;=</span> min_registros].index</span>
<span id="cb129-644"><a href="#cb129-644" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[df[<span class="st">'mmsi'</span>].isin(buques_validos)].copy()</span>
<span id="cb129-645"><a href="#cb129-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-646"><a href="#cb129-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-647"><a href="#cb129-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-648"><a href="#cb129-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-649"><a href="#cb129-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-652"><a href="#cb129-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-653"><a href="#cb129-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recorte_buques</span></span>
<span id="cb129-654"><a href="#cb129-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-655"><a href="#cb129-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-656"><a href="#cb129-656" aria-hidden="true" tabindex="-1"></a>train_val_filtrado <span class="op">=</span> filtrar_buques_por_min_registros(train_val_target, min_registros<span class="op">=</span>seq_len)</span>
<span id="cb129-657"><a href="#cb129-657" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después del recorte por secuencia mínima: </span><span class="sc">{</span><span class="bu">len</span>(train_val_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-658"><a href="#cb129-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-659"><a href="#cb129-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-660"><a href="#cb129-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-661"><a href="#cb129-661" aria-hidden="true" tabindex="-1"></a><span class="fu">## valores nulos</span></span>
<span id="cb129-664"><a href="#cb129-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-665"><a href="#cb129-665" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: valores_nulos</span></span>
<span id="cb129-666"><a href="#cb129-666" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-667"><a href="#cb129-667" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-668"><a href="#cb129-668" aria-hidden="true" tabindex="-1"></a>nulos_por_col <span class="op">=</span> train_val_filtrado.isnull().<span class="bu">sum</span>()</span>
<span id="cb129-669"><a href="#cb129-669" aria-hidden="true" tabindex="-1"></a>nulos_filtrados <span class="op">=</span> nulos_por_col[nulos_por_col <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb129-670"><a href="#cb129-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-671"><a href="#cb129-671" aria-hidden="true" tabindex="-1"></a>resumen_nulos <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-672"><a href="#cb129-672" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Columna'</span>: nulos_filtrados.index,</span>
<span id="cb129-673"><a href="#cb129-673" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Valores nulos'</span>: nulos_filtrados.values,</span>
<span id="cb129-674"><a href="#cb129-674" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Porcentaje nulos (%)'</span>: nulos_filtrados <span class="op">/</span> <span class="bu">len</span>(train_val_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb129-675"><a href="#cb129-675" aria-hidden="true" tabindex="-1"></a>}).sort_values(by<span class="op">=</span><span class="st">'Porcentaje nulos (%)'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-676"><a href="#cb129-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-677"><a href="#cb129-677" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_nulos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'grid'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb129-678"><a href="#cb129-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-679"><a href="#cb129-679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-680"><a href="#cb129-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-681"><a href="#cb129-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-684"><a href="#cb129-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-685"><a href="#cb129-685" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: filas_train_val_filtrado</span></span>
<span id="cb129-686"><a href="#cb129-686" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-687"><a href="#cb129-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-688"><a href="#cb129-688" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-689"><a href="#cb129-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-690"><a href="#cb129-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un pequeño DataFrame resumen</span></span>
<span id="cb129-691"><a href="#cb129-691" aria-hidden="true" tabindex="-1"></a>resumen_filas <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-692"><a href="#cb129-692" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'train_val_filtrado'</span>],</span>
<span id="cb129-693"><a href="#cb129-693" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(train_val_filtrado)]</span>
<span id="cb129-694"><a href="#cb129-694" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-695"><a href="#cb129-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-696"><a href="#cb129-696" aria-hidden="true" tabindex="-1"></a><span class="co"># Imprimir en formato tabulate</span></span>
<span id="cb129-697"><a href="#cb129-697" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_filas, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb129-698"><a href="#cb129-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-699"><a href="#cb129-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-700"><a href="#cb129-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-701"><a href="#cb129-701" aria-hidden="true" tabindex="-1"></a>Después de aplicar los filtros sobre el conjunto de datos, se eliminarán los registros con valores nulos en la variable objetivo CO2_emission y aquellos donde esta sea igual a cero. Tras estas operaciones, el dataset train_val_filtrado contendrá 19,140 filas, correspondientes a los buques que cumplen con los criterios mínimos de secuencia. Esto permitirá que los análisis y modelos posteriores se enfoquen únicamente en datos válidos y consistentes.</span>
<span id="cb129-702"><a href="#cb129-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-703"><a href="#cb129-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-704"><a href="#cb129-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-705"><a href="#cb129-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-706"><a href="#cb129-706" aria-hidden="true" tabindex="-1"></a><span class="fu">## Partición interna</span></span>
<span id="cb129-707"><a href="#cb129-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-708"><a href="#cb129-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-711"><a href="#cb129-711" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-712"><a href="#cb129-712" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: particion_interna</span></span>
<span id="cb129-713"><a href="#cb129-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-714"><a href="#cb129-714" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-715"><a href="#cb129-715" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb129-716"><a href="#cb129-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-717"><a href="#cb129-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir X (features) y y (target)</span></span>
<span id="cb129-718"><a href="#cb129-718" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> train_val_filtrado.drop(columns<span class="op">=</span>[target])</span>
<span id="cb129-719"><a href="#cb129-719" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> train_val_filtrado[target]</span>
<span id="cb129-720"><a href="#cb129-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-721"><a href="#cb129-721" aria-hidden="true" tabindex="-1"></a><span class="co"># Partición interna: entrenamiento interno y validación interna</span></span>
<span id="cb129-722"><a href="#cb129-722" aria-hidden="true" tabindex="-1"></a>X_train_int, X_val_int, y_train_int, y_val_int <span class="op">=</span> train_test_split(</span>
<span id="cb129-723"><a href="#cb129-723" aria-hidden="true" tabindex="-1"></a>    X, y,</span>
<span id="cb129-724"><a href="#cb129-724" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.2</span>,      <span class="co"># 20% para validación interna</span></span>
<span id="cb129-725"><a href="#cb129-725" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span>,    <span class="co"># para reproducibilidad</span></span>
<span id="cb129-726"><a href="#cb129-726" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb129-727"><a href="#cb129-727" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-728"><a href="#cb129-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-729"><a href="#cb129-729" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño X_train_int: </span><span class="sc">{</span>X_train_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-730"><a href="#cb129-730" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño X_val_int: </span><span class="sc">{</span>X_val_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-731"><a href="#cb129-731" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño y_train_int: </span><span class="sc">{</span>y_train_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-732"><a href="#cb129-732" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tamaño y_val_int: </span><span class="sc">{</span>y_val_int<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-733"><a href="#cb129-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-734"><a href="#cb129-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-735"><a href="#cb129-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-736"><a href="#cb129-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-737"><a href="#cb129-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-738"><a href="#cb129-738" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Definición de la función de imputación</span></span>
<span id="cb129-739"><a href="#cb129-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-742"><a href="#cb129-742" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-743"><a href="#cb129-743" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: imputacion_def</span></span>
<span id="cb129-744"><a href="#cb129-744" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-745"><a href="#cb129-745" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-746"><a href="#cb129-746" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> imputar_datos(df, columnas_numericas, columnas_categoricas, flags_nulos<span class="op">=</span><span class="va">None</span>, medianas<span class="op">=</span><span class="va">None</span>, modas<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb129-747"><a href="#cb129-747" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb129-748"><a href="#cb129-748" aria-hidden="true" tabindex="-1"></a><span class="co">    Imputa valores faltantes en un DataFrame.</span></span>
<span id="cb129-749"><a href="#cb129-749" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-750"><a href="#cb129-750" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb129-751"><a href="#cb129-751" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame a imputar.</span></span>
<span id="cb129-752"><a href="#cb129-752" aria-hidden="true" tabindex="-1"></a><span class="co">        columnas_numericas (list): Columnas numéricas a imputar con mediana.</span></span>
<span id="cb129-753"><a href="#cb129-753" aria-hidden="true" tabindex="-1"></a><span class="co">        columnas_categoricas (list): Columnas categóricas a imputar con moda.</span></span>
<span id="cb129-754"><a href="#cb129-754" aria-hidden="true" tabindex="-1"></a><span class="co">        flags_nulos (list, optional): Columnas para crear flag de valores nulos originales.</span></span>
<span id="cb129-755"><a href="#cb129-755" aria-hidden="true" tabindex="-1"></a><span class="co">        medianas (dict, optional): Median values para usar (train stats).</span></span>
<span id="cb129-756"><a href="#cb129-756" aria-hidden="true" tabindex="-1"></a><span class="co">        modas (dict, optional): Moda values para usar (train stats).</span></span>
<span id="cb129-757"><a href="#cb129-757" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb129-758"><a href="#cb129-758" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb129-759"><a href="#cb129-759" aria-hidden="true" tabindex="-1"></a><span class="co">        df_imputado (pd.DataFrame): DataFrame imputado.</span></span>
<span id="cb129-760"><a href="#cb129-760" aria-hidden="true" tabindex="-1"></a><span class="co">        medianas (dict): Median values calculadas si no se pasan.</span></span>
<span id="cb129-761"><a href="#cb129-761" aria-hidden="true" tabindex="-1"></a><span class="co">        modas (dict): Moda values calculadas si no se pasan.</span></span>
<span id="cb129-762"><a href="#cb129-762" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb129-763"><a href="#cb129-763" aria-hidden="true" tabindex="-1"></a>    df_imputado <span class="op">=</span> df.copy()</span>
<span id="cb129-764"><a href="#cb129-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-765"><a href="#cb129-765" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crear flags de nulos</span></span>
<span id="cb129-766"><a href="#cb129-766" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> flags_nulos:</span>
<span id="cb129-767"><a href="#cb129-767" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> flags_nulos:</span>
<span id="cb129-768"><a href="#cb129-768" aria-hidden="true" tabindex="-1"></a>            df_imputado[<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_is_missing"</span>] <span class="op">=</span> df_imputado[col].isna().astype(<span class="bu">int</span>)</span>
<span id="cb129-769"><a href="#cb129-769" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-770"><a href="#cb129-770" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Si no vienen medianas y modas, calcular a partir del df actual</span></span>
<span id="cb129-771"><a href="#cb129-771" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> medianas <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb129-772"><a href="#cb129-772" aria-hidden="true" tabindex="-1"></a>        medianas <span class="op">=</span> {col: df_imputado[col].median() <span class="cf">for</span> col <span class="kw">in</span> columnas_numericas}</span>
<span id="cb129-773"><a href="#cb129-773" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> modas <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb129-774"><a href="#cb129-774" aria-hidden="true" tabindex="-1"></a>        modas <span class="op">=</span> {col: df_imputado[col].mode()[<span class="dv">0</span>] <span class="cf">for</span> col <span class="kw">in</span> columnas_categoricas}</span>
<span id="cb129-775"><a href="#cb129-775" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-776"><a href="#cb129-776" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputar columnas numéricas</span></span>
<span id="cb129-777"><a href="#cb129-777" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columnas_numericas:</span>
<span id="cb129-778"><a href="#cb129-778" aria-hidden="true" tabindex="-1"></a>        df_imputado[col] <span class="op">=</span> df_imputado[col].fillna(medianas[col])</span>
<span id="cb129-779"><a href="#cb129-779" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-780"><a href="#cb129-780" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputar columnas categóricas</span></span>
<span id="cb129-781"><a href="#cb129-781" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columnas_categoricas:</span>
<span id="cb129-782"><a href="#cb129-782" aria-hidden="true" tabindex="-1"></a>        df_imputado[col] <span class="op">=</span> df_imputado[col].fillna(modas[col])</span>
<span id="cb129-783"><a href="#cb129-783" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-784"><a href="#cb129-784" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_imputado, medianas, modas</span>
<span id="cb129-785"><a href="#cb129-785" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-786"><a href="#cb129-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-787"><a href="#cb129-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-788"><a href="#cb129-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-789"><a href="#cb129-789" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Aplicación en training (entrenamiento interno)</span></span>
<span id="cb129-790"><a href="#cb129-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-793"><a href="#cb129-793" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-794"><a href="#cb129-794" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: imputacion_columnas</span></span>
<span id="cb129-795"><a href="#cb129-795" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-796"><a href="#cb129-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-797"><a href="#cb129-797" aria-hidden="true" tabindex="-1"></a>columnas_num <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>, <span class="st">'MainEngineRPM'</span>, <span class="st">'FuelType1Capacity'</span>, <span class="st">'ais_loa'</span>]</span>
<span id="cb129-798"><a href="#cb129-798" aria-hidden="true" tabindex="-1"></a>flags <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>]  <span class="co"># opcional si quieres marcar dónde estaban los nulos</span></span>
<span id="cb129-799"><a href="#cb129-799" aria-hidden="true" tabindex="-1"></a>columnas_cat <span class="op">=</span> []  <span class="co"># No hay columnas categóricas con nulos</span></span>
<span id="cb129-800"><a href="#cb129-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-801"><a href="#cb129-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-802"><a href="#cb129-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-803"><a href="#cb129-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-806"><a href="#cb129-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-807"><a href="#cb129-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: imputacion_train</span></span>
<span id="cb129-808"><a href="#cb129-808" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-809"><a href="#cb129-809" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-810"><a href="#cb129-810" aria-hidden="true" tabindex="-1"></a>X_train_int_imputado, medianas, modas <span class="op">=</span> imputar_datos(</span>
<span id="cb129-811"><a href="#cb129-811" aria-hidden="true" tabindex="-1"></a>    X_train_int,</span>
<span id="cb129-812"><a href="#cb129-812" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb129-813"><a href="#cb129-813" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb129-814"><a href="#cb129-814" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags</span>
<span id="cb129-815"><a href="#cb129-815" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-816"><a href="#cb129-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-817"><a href="#cb129-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-818"><a href="#cb129-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-819"><a href="#cb129-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-820"><a href="#cb129-820" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Aplicación en validación </span></span>
<span id="cb129-821"><a href="#cb129-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-824"><a href="#cb129-824" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-825"><a href="#cb129-825" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: imputacion_val</span></span>
<span id="cb129-826"><a href="#cb129-826" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-827"><a href="#cb129-827" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-828"><a href="#cb129-828" aria-hidden="true" tabindex="-1"></a>X_val_int_imputado, _, _ <span class="op">=</span> imputar_datos(</span>
<span id="cb129-829"><a href="#cb129-829" aria-hidden="true" tabindex="-1"></a>    X_val_int,</span>
<span id="cb129-830"><a href="#cb129-830" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb129-831"><a href="#cb129-831" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb129-832"><a href="#cb129-832" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags,</span>
<span id="cb129-833"><a href="#cb129-833" aria-hidden="true" tabindex="-1"></a>    medianas<span class="op">=</span>medianas,</span>
<span id="cb129-834"><a href="#cb129-834" aria-hidden="true" tabindex="-1"></a>    modas<span class="op">=</span>modas</span>
<span id="cb129-835"><a href="#cb129-835" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-836"><a href="#cb129-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-837"><a href="#cb129-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-838"><a href="#cb129-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-839"><a href="#cb129-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-840"><a href="#cb129-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-841"><a href="#cb129-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-842"><a href="#cb129-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-843"><a href="#cb129-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-844"><a href="#cb129-844" aria-hidden="true" tabindex="-1"></a><span class="fu">##  creación de features (feature engineering)</span></span>
<span id="cb129-845"><a href="#cb129-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-848"><a href="#cb129-848" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-849"><a href="#cb129-849" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_features_def</span></span>
<span id="cb129-850"><a href="#cb129-850" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-851"><a href="#cb129-851" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-852"><a href="#cb129-852" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crear_features(df):</span>
<span id="cb129-853"><a href="#cb129-853" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb129-854"><a href="#cb129-854" aria-hidden="true" tabindex="-1"></a><span class="co">    Crea nuevas variables/features a partir de un DataFrame imputado.</span></span>
<span id="cb129-855"><a href="#cb129-855" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-856"><a href="#cb129-856" aria-hidden="true" tabindex="-1"></a><span class="co">    Variables creadas:</span></span>
<span id="cb129-857"><a href="#cb129-857" aria-hidden="true" tabindex="-1"></a><span class="co">        - duration_min: duración entre posiciones consecutivas por buque</span></span>
<span id="cb129-858"><a href="#cb129-858" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_puerto: identificador de viaje basado en cambio de puerto</span></span>
<span id="cb129-859"><a href="#cb129-859" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_gap: identificador de viaje basado en gaps de tiempo</span></span>
<span id="cb129-860"><a href="#cb129-860" aria-hidden="true" tabindex="-1"></a><span class="co">        - viaje_leg: identificador de viaje basado en start_leg y end_leg</span></span>
<span id="cb129-861"><a href="#cb129-861" aria-hidden="true" tabindex="-1"></a><span class="co">        - frecuencia_puerto: número de veces que un puerto aparece como port_after por buque</span></span>
<span id="cb129-862"><a href="#cb129-862" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-863"><a href="#cb129-863" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb129-864"><a href="#cb129-864" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame imputado con columnas necesarias (fechas, puertos, leg info)</span></span>
<span id="cb129-865"><a href="#cb129-865" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb129-866"><a href="#cb129-866" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb129-867"><a href="#cb129-867" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: DataFrame con las nuevas features</span></span>
<span id="cb129-868"><a href="#cb129-868" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb129-869"><a href="#cb129-869" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb129-870"><a href="#cb129-870" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-871"><a href="#cb129-871" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ordenar por buque y tiempo</span></span>
<span id="cb129-872"><a href="#cb129-872" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(by<span class="op">=</span>[<span class="st">'mmsi'</span>,<span class="st">'first_dt_pos_utc'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-873"><a href="#cb129-873" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-874"><a href="#cb129-874" aria-hidden="true" tabindex="-1"></a>    <span class="co"># duration_min</span></span>
<span id="cb129-875"><a href="#cb129-875" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'duration_min'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'first_dt_pos_utc'</span>].diff().dt.total_seconds() <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb129-876"><a href="#cb129-876" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'duration_min'</span>] <span class="op">=</span> df[<span class="st">'duration_min'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb129-877"><a href="#cb129-877" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-878"><a href="#cb129-878" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_puerto</span></span>
<span id="cb129-879"><a href="#cb129-879" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_change_puerto'</span>] <span class="op">=</span> (</span>
<span id="cb129-880"><a href="#cb129-880" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">'port_before'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'port_before'</span>].shift(<span class="dv">1</span>)) <span class="op">|</span></span>
<span id="cb129-881"><a href="#cb129-881" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">'port_after'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'port_after'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb129-882"><a href="#cb129-882" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-883"><a href="#cb129-883" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_puerto'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'viaje_change_puerto'</span>].cumsum()</span>
<span id="cb129-884"><a href="#cb129-884" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">'viaje_change_puerto'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-885"><a href="#cb129-885" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-886"><a href="#cb129-886" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_gap</span></span>
<span id="cb129-887"><a href="#cb129-887" aria-hidden="true" tabindex="-1"></a>    umbral_gap <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb129-888"><a href="#cb129-888" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_change_gap'</span>] <span class="op">=</span> (df[<span class="st">'duration_min'</span>] <span class="op">&gt;</span> umbral_gap).astype(<span class="bu">int</span>)</span>
<span id="cb129-889"><a href="#cb129-889" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_gap'</span>] <span class="op">=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'viaje_change_gap'</span>].cumsum()</span>
<span id="cb129-890"><a href="#cb129-890" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">'viaje_change_gap'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-891"><a href="#cb129-891" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-892"><a href="#cb129-892" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viaje_leg</span></span>
<span id="cb129-893"><a href="#cb129-893" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'viaje_leg'</span>] <span class="op">=</span> ((df[<span class="st">'start_leg'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'start_leg'</span>].shift(<span class="dv">1</span>)) <span class="op">|</span></span>
<span id="cb129-894"><a href="#cb129-894" aria-hidden="true" tabindex="-1"></a>                       (df[<span class="st">'end_leg'</span>] <span class="op">!=</span> df.groupby(<span class="st">'mmsi'</span>)[<span class="st">'end_leg'</span>].shift(<span class="dv">1</span>))).cumsum()</span>
<span id="cb129-895"><a href="#cb129-895" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-896"><a href="#cb129-896" aria-hidden="true" tabindex="-1"></a>    <span class="co"># frecuencia_puerto</span></span>
<span id="cb129-897"><a href="#cb129-897" aria-hidden="true" tabindex="-1"></a>    freq_puerto <span class="op">=</span> df.groupby([<span class="st">'mmsi'</span>,<span class="st">'port_after'</span>]).size().rename(<span class="st">'frecuencia_puerto'</span>)</span>
<span id="cb129-898"><a href="#cb129-898" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(freq_puerto, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'mmsi'</span>,<span class="st">'port_after'</span>])</span>
<span id="cb129-899"><a href="#cb129-899" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-900"><a href="#cb129-900" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb129-901"><a href="#cb129-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-902"><a href="#cb129-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-903"><a href="#cb129-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-904"><a href="#cb129-904" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aplicación a entrenamiento interno</span></span>
<span id="cb129-905"><a href="#cb129-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-908"><a href="#cb129-908" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-909"><a href="#cb129-909" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_features_train</span></span>
<span id="cb129-910"><a href="#cb129-910" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-911"><a href="#cb129-911" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-912"><a href="#cb129-912" aria-hidden="true" tabindex="-1"></a>X_train_int_features <span class="op">=</span> crear_features(X_train_int_imputado)</span>
<span id="cb129-913"><a href="#cb129-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-914"><a href="#cb129-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-915"><a href="#cb129-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-916"><a href="#cb129-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-917"><a href="#cb129-917" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aplicación a validación interna</span></span>
<span id="cb129-918"><a href="#cb129-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-921"><a href="#cb129-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-922"><a href="#cb129-922" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_features_val</span></span>
<span id="cb129-923"><a href="#cb129-923" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-924"><a href="#cb129-924" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-925"><a href="#cb129-925" aria-hidden="true" tabindex="-1"></a>X_val_int_features <span class="op">=</span> crear_features(X_val_int_imputado)</span>
<span id="cb129-926"><a href="#cb129-926" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-927"><a href="#cb129-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-928"><a href="#cb129-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-929"><a href="#cb129-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-930"><a href="#cb129-930" aria-hidden="true" tabindex="-1"></a><span class="fu">### vista</span></span>
<span id="cb129-933"><a href="#cb129-933" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-934"><a href="#cb129-934" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: resumen_variables</span></span>
<span id="cb129-935"><a href="#cb129-935" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-936"><a href="#cb129-936" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-937"><a href="#cb129-937" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-938"><a href="#cb129-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-939"><a href="#cb129-939" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrame de ejemplo: X_train_int_imputado</span></span>
<span id="cb129-940"><a href="#cb129-940" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> X_train_int_imputado.copy()</span>
<span id="cb129-941"><a href="#cb129-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-942"><a href="#cb129-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear lista de variables y su tipo</span></span>
<span id="cb129-943"><a href="#cb129-943" aria-hidden="true" tabindex="-1"></a>variable_tipo <span class="op">=</span> [(col, <span class="bu">str</span>(df[col].dtype)) <span class="cf">for</span> col <span class="kw">in</span> df.columns]</span>
<span id="cb129-944"><a href="#cb129-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-945"><a href="#cb129-945" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar en formato tabulate</span></span>
<span id="cb129-946"><a href="#cb129-946" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(variable_tipo, headers<span class="op">=</span>[<span class="st">'Variable'</span>, <span class="st">'Tipo'</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span>
<span id="cb129-947"><a href="#cb129-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-948"><a href="#cb129-948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-949"><a href="#cb129-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-950"><a href="#cb129-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-951"><a href="#cb129-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-952"><a href="#cb129-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-953"><a href="#cb129-953" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Visualización de matriz de correlación (heatmap)</span></span>
<span id="cb129-954"><a href="#cb129-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-957"><a href="#cb129-957" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-958"><a href="#cb129-958" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualizar_correlacion</span></span>
<span id="cb129-959"><a href="#cb129-959" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-960"><a href="#cb129-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-961"><a href="#cb129-961" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb129-962"><a href="#cb129-962" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb129-963"><a href="#cb129-963" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb129-964"><a href="#cb129-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-965"><a href="#cb129-965" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mostrar_matriz_correlacion(df, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">10</span>), cmap<span class="op">=</span><span class="st">'coolwarm'</span>):</span>
<span id="cb129-966"><a href="#cb129-966" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb129-967"><a href="#cb129-967" aria-hidden="true" tabindex="-1"></a><span class="co">    Genera un heatmap de la matriz de correlación solo para columnas numéricas.</span></span>
<span id="cb129-968"><a href="#cb129-968" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-969"><a href="#cb129-969" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb129-970"><a href="#cb129-970" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): DataFrame a analizar.</span></span>
<span id="cb129-971"><a href="#cb129-971" aria-hidden="true" tabindex="-1"></a><span class="co">        figsize (tuple, optional): Tamaño de la figura. Default (12,10).</span></span>
<span id="cb129-972"><a href="#cb129-972" aria-hidden="true" tabindex="-1"></a><span class="co">        cmap (str, optional): Colormap de Seaborn. Default 'coolwarm'.</span></span>
<span id="cb129-973"><a href="#cb129-973" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb129-974"><a href="#cb129-974" aria-hidden="true" tabindex="-1"></a><span class="co">    Retorna:</span></span>
<span id="cb129-975"><a href="#cb129-975" aria-hidden="true" tabindex="-1"></a><span class="co">        corr (pd.DataFrame): Matriz de correlación (solo numéricas) para uso posterior.</span></span>
<span id="cb129-976"><a href="#cb129-976" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb129-977"><a href="#cb129-977" aria-hidden="true" tabindex="-1"></a>    df_numerico <span class="op">=</span> df.select_dtypes(include<span class="op">=</span><span class="st">'number'</span>)</span>
<span id="cb129-978"><a href="#cb129-978" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> df_numerico.corr()</span>
<span id="cb129-979"><a href="#cb129-979" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-980"><a href="#cb129-980" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>figsize)</span>
<span id="cb129-981"><a href="#cb129-981" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(corr, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">".2f"</span>, cmap<span class="op">=</span>cmap, cbar<span class="op">=</span><span class="va">True</span>, square<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-982"><a href="#cb129-982" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Matriz de correlación (columnas numéricas)"</span>)</span>
<span id="cb129-983"><a href="#cb129-983" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb129-984"><a href="#cb129-984" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-985"><a href="#cb129-985" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> corr</span>
<span id="cb129-986"><a href="#cb129-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-987"><a href="#cb129-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-988"><a href="#cb129-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-989"><a href="#cb129-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-990"><a href="#cb129-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-993"><a href="#cb129-993" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-994"><a href="#cb129-994" aria-hidden="true" tabindex="-1"></a><span class="co"># Instancia: aplicar a X_train_int_imputado</span></span>
<span id="cb129-995"><a href="#cb129-995" aria-hidden="true" tabindex="-1"></a>corr_train <span class="op">=</span> mostrar_matriz_correlacion(X_train_int_imputado)</span>
<span id="cb129-996"><a href="#cb129-996" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-997"><a href="#cb129-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-998"><a href="#cb129-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-999"><a href="#cb129-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1000"><a href="#cb129-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1001"><a href="#cb129-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1002"><a href="#cb129-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1003"><a href="#cb129-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1004"><a href="#cb129-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1005"><a href="#cb129-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1006"><a href="#cb129-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1007"><a href="#cb129-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Definición de la función para eliminar correlación alta**</span></span>
<span id="cb129-1008"><a href="#cb129-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1011"><a href="#cb129-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1012"><a href="#cb129-1012" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eliminar_correlacion</span></span>
<span id="cb129-1013"><a href="#cb129-1013" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1014"><a href="#cb129-1014" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1015"><a href="#cb129-1015" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1016"><a href="#cb129-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1017"><a href="#cb129-1017" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para elegir variables altamente correlacionadas</span></span>
<span id="cb129-1018"><a href="#cb129-1018" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> choose_one_from_highly_correlated(correlation_matrix, threshold<span class="op">=</span><span class="fl">0.60</span>):</span>
<span id="cb129-1019"><a href="#cb129-1019" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb129-1020"><a href="#cb129-1020" aria-hidden="true" tabindex="-1"></a><span class="co">    Identifica columnas a eliminar según correlación alta.</span></span>
<span id="cb129-1021"><a href="#cb129-1021" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-1022"><a href="#cb129-1022" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb129-1023"><a href="#cb129-1023" aria-hidden="true" tabindex="-1"></a><span class="co">        correlation_matrix (pd.DataFrame): matriz de correlación absoluta.</span></span>
<span id="cb129-1024"><a href="#cb129-1024" aria-hidden="true" tabindex="-1"></a><span class="co">        threshold (float): umbral de correlación para eliminar variables.</span></span>
<span id="cb129-1025"><a href="#cb129-1025" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb129-1026"><a href="#cb129-1026" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb129-1027"><a href="#cb129-1027" aria-hidden="true" tabindex="-1"></a><span class="co">        list: columnas a eliminar.</span></span>
<span id="cb129-1028"><a href="#cb129-1028" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb129-1029"><a href="#cb129-1029" aria-hidden="true" tabindex="-1"></a>    columns_to_remove <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb129-1030"><a href="#cb129-1030" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column <span class="kw">in</span> correlation_matrix.columns:</span>
<span id="cb129-1031"><a href="#cb129-1031" aria-hidden="true" tabindex="-1"></a>        high_corr_columns <span class="op">=</span> correlation_matrix[column][correlation_matrix[column] <span class="op">&gt;</span> threshold].index.tolist()</span>
<span id="cb129-1032"><a href="#cb129-1032" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> column <span class="kw">in</span> high_corr_columns:</span>
<span id="cb129-1033"><a href="#cb129-1033" aria-hidden="true" tabindex="-1"></a>            high_corr_columns.remove(column)</span>
<span id="cb129-1034"><a href="#cb129-1034" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> high_corr_columns:</span>
<span id="cb129-1035"><a href="#cb129-1035" aria-hidden="true" tabindex="-1"></a>            columns_to_remove.update(high_corr_columns[<span class="dv">1</span>:])</span>
<span id="cb129-1036"><a href="#cb129-1036" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(columns_to_remove)</span>
<span id="cb129-1037"><a href="#cb129-1037" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1038"><a href="#cb129-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1039"><a href="#cb129-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1040"><a href="#cb129-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1041"><a href="#cb129-1041" aria-hidden="true" tabindex="-1"></a><span class="fu">### **Aplicación de la función a entrenamiento y validación**</span></span>
<span id="cb129-1042"><a href="#cb129-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1045"><a href="#cb129-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1046"><a href="#cb129-1046" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: aplicar_eliminar_correlacion</span></span>
<span id="cb129-1047"><a href="#cb129-1047" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1048"><a href="#cb129-1048" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1049"><a href="#cb129-1049" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1050"><a href="#cb129-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1051"><a href="#cb129-1051" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular matriz de correlación absoluta solo de columnas numéricas</span></span>
<span id="cb129-1052"><a href="#cb129-1052" aria-hidden="true" tabindex="-1"></a>correlation_matrix_train <span class="op">=</span> X_train_int_imputado.select_dtypes(include<span class="op">=</span>[np.number]).corr().<span class="bu">abs</span>()</span>
<span id="cb129-1053"><a href="#cb129-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1054"><a href="#cb129-1054" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar columnas a eliminar según correlación</span></span>
<span id="cb129-1055"><a href="#cb129-1055" aria-hidden="true" tabindex="-1"></a>columns_to_drop <span class="op">=</span> choose_one_from_highly_correlated(correlation_matrix_train, threshold<span class="op">=</span><span class="fl">0.60</span>)</span>
<span id="cb129-1056"><a href="#cb129-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1057"><a href="#cb129-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar columnas de X_train_int y X_val_int</span></span>
<span id="cb129-1058"><a href="#cb129-1058" aria-hidden="true" tabindex="-1"></a>X_train_int_sin_corr <span class="op">=</span> X_train_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb129-1059"><a href="#cb129-1059" aria-hidden="true" tabindex="-1"></a>X_val_int_sin_corr <span class="op">=</span> X_val_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb129-1060"><a href="#cb129-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1061"><a href="#cb129-1061" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen</span></span>
<span id="cb129-1062"><a href="#cb129-1062" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas originales en train: </span><span class="sc">{</span>X_train_int_imputado<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1063"><a href="#cb129-1063" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas eliminadas por alta correlación: </span><span class="sc">{</span><span class="bu">len</span>(columns_to_drop)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1064"><a href="#cb129-1064" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas después de eliminación en train: </span><span class="sc">{</span>X_train_int_sin_corr<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1065"><a href="#cb129-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1066"><a href="#cb129-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1067"><a href="#cb129-1067" aria-hidden="true" tabindex="-1"></a><span class="fu"># Aplicar la eliminación de columnas seleccionadas a train y validación</span></span>
<span id="cb129-1070"><a href="#cb129-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1071"><a href="#cb129-1071" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: eliminar_variables</span></span>
<span id="cb129-1072"><a href="#cb129-1072" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1073"><a href="#cb129-1073" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1074"><a href="#cb129-1074" aria-hidden="true" tabindex="-1"></a><span class="co"># eliminar de train y validación usando la lista calculada</span></span>
<span id="cb129-1075"><a href="#cb129-1075" aria-hidden="true" tabindex="-1"></a>X_train_int_imputado <span class="op">=</span> X_train_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb129-1076"><a href="#cb129-1076" aria-hidden="true" tabindex="-1"></a>X_val_int_imputado   <span class="op">=</span> X_val_int_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb129-1077"><a href="#cb129-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1078"><a href="#cb129-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1079"><a href="#cb129-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1080"><a href="#cb129-1080" aria-hidden="true" tabindex="-1"></a><span class="fu">## variables resultante</span></span>
<span id="cb129-1081"><a href="#cb129-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1084"><a href="#cb129-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1085"><a href="#cb129-1085" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-1086"><a href="#cb129-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1087"><a href="#cb129-1087" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear lista de columnas y su tipo</span></span>
<span id="cb129-1088"><a href="#cb129-1088" aria-hidden="true" tabindex="-1"></a>variable_tipo <span class="op">=</span> [(col, <span class="bu">str</span>(X_train_int_imputado[col].dtype)) <span class="cf">for</span> col <span class="kw">in</span> X_train_int_imputado.columns]</span>
<span id="cb129-1089"><a href="#cb129-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1090"><a href="#cb129-1090" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar en formato tabla</span></span>
<span id="cb129-1091"><a href="#cb129-1091" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(variable_tipo, headers<span class="op">=</span>[<span class="st">'Variable'</span>, <span class="st">'Tipo'</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span>
<span id="cb129-1092"><a href="#cb129-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1093"><a href="#cb129-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1094"><a href="#cb129-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1095"><a href="#cb129-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1096"><a href="#cb129-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1097"><a href="#cb129-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1098"><a href="#cb129-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1099"><a href="#cb129-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1100"><a href="#cb129-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1101"><a href="#cb129-1101" aria-hidden="true" tabindex="-1"></a><span class="fu">## outliers</span></span>
<span id="cb129-1102"><a href="#cb129-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1103"><a href="#cb129-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1104"><a href="#cb129-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1105"><a href="#cb129-1105" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Definir features numéricas y categóricas**</span></span>
<span id="cb129-1106"><a href="#cb129-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1109"><a href="#cb129-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1110"><a href="#cb129-1110" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: definir_features</span></span>
<span id="cb129-1111"><a href="#cb129-1111" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1112"><a href="#cb129-1112" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1113"><a href="#cb129-1113" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb129-1114"><a href="#cb129-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1115"><a href="#cb129-1115" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas numéricas que vamos a escalar</span></span>
<span id="cb129-1116"><a href="#cb129-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1117"><a href="#cb129-1117" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [</span>
<span id="cb129-1118"><a href="#cb129-1118" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GrossTonnage_x'</span>, <span class="st">'sum_me_ene'</span>, <span class="st">'sum_ab_ene'</span>, </span>
<span id="cb129-1119"><a href="#cb129-1119" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Speedmax'</span>, <span class="st">'BreadthExtreme'</span>, <span class="st">'FuelType1Capacity'</span>, </span>
<span id="cb129-1120"><a href="#cb129-1120" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineRPM'</span>, <span class="st">'Powerkwservice'</span>, <span class="st">'combustible_ab'</span>, </span>
<span id="cb129-1121"><a href="#cb129-1121" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TotalBunkerCapacity_is_missing'</span></span>
<span id="cb129-1122"><a href="#cb129-1122" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb129-1123"><a href="#cb129-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1124"><a href="#cb129-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1125"><a href="#cb129-1125" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas categóricas (objetos) excluyendo h3_sequence</span></span>
<span id="cb129-1126"><a href="#cb129-1126" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> X_train_int_imputado.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>]).columns.tolist()</span>
<span id="cb129-1127"><a href="#cb129-1127" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'h3_sequence'</span> <span class="kw">in</span> categorical_features:</span>
<span id="cb129-1128"><a href="#cb129-1128" aria-hidden="true" tabindex="-1"></a>    categorical_features.remove(<span class="st">'h3_sequence'</span>)</span>
<span id="cb129-1129"><a href="#cb129-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1130"><a href="#cb129-1130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Numéricas:"</span>, numeric_features)</span>
<span id="cb129-1131"><a href="#cb129-1131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Categóricas:"</span>, categorical_features)</span>
<span id="cb129-1132"><a href="#cb129-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1133"><a href="#cb129-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1134"><a href="#cb129-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1135"><a href="#cb129-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1136"><a href="#cb129-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Escalado de features numéricas y codificación de categóricas**</span></span>
<span id="cb129-1137"><a href="#cb129-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1138"><a href="#cb129-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1139"><a href="#cb129-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1142"><a href="#cb129-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1143"><a href="#cb129-1143" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: escalado_numerico</span></span>
<span id="cb129-1144"><a href="#cb129-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1145"><a href="#cb129-1145" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1146"><a href="#cb129-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># Escalado numérico</span></span>
<span id="cb129-1147"><a href="#cb129-1147" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb129-1148"><a href="#cb129-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1149"><a href="#cb129-1149" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb129-1150"><a href="#cb129-1150" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="op">=</span> X_train_int_imputado.copy()</span>
<span id="cb129-1151"><a href="#cb129-1151" aria-hidden="true" tabindex="-1"></a>X_val_scaled <span class="op">=</span> X_val_int_imputado.copy()</span>
<span id="cb129-1152"><a href="#cb129-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1153"><a href="#cb129-1153" aria-hidden="true" tabindex="-1"></a>X_train_scaled[numeric_features] <span class="op">=</span> scaler.fit_transform(X_train_scaled[numeric_features])</span>
<span id="cb129-1154"><a href="#cb129-1154" aria-hidden="true" tabindex="-1"></a>X_val_scaled[numeric_features] <span class="op">=</span> scaler.transform(X_val_scaled[numeric_features])</span>
<span id="cb129-1155"><a href="#cb129-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1156"><a href="#cb129-1156" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Escalado numérico realizado ✅"</span>)</span>
<span id="cb129-1157"><a href="#cb129-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1158"><a href="#cb129-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1159"><a href="#cb129-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1160"><a href="#cb129-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1163"><a href="#cb129-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1164"><a href="#cb129-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: conversion_categoricas</span></span>
<span id="cb129-1165"><a href="#cb129-1165" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1166"><a href="#cb129-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1167"><a href="#cb129-1167" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir todas las columnas categóricas a string (por si hay tipos mixtos)</span></span>
<span id="cb129-1168"><a href="#cb129-1168" aria-hidden="true" tabindex="-1"></a>X_train_scaled[categorical_features] <span class="op">=</span> X_train_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb129-1169"><a href="#cb129-1169" aria-hidden="true" tabindex="-1"></a>X_val_scaled[categorical_features] <span class="op">=</span> X_val_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb129-1170"><a href="#cb129-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1171"><a href="#cb129-1171" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Columnas categóricas convertidas a string ✅"</span>)</span>
<span id="cb129-1172"><a href="#cb129-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1173"><a href="#cb129-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1174"><a href="#cb129-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1175"><a href="#cb129-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1176"><a href="#cb129-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1177"><a href="#cb129-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1178"><a href="#cb129-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1181"><a href="#cb129-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1182"><a href="#cb129-1182" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: codificacion_onehot</span></span>
<span id="cb129-1183"><a href="#cb129-1183" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1184"><a href="#cb129-1184" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1185"><a href="#cb129-1185" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder</span>
<span id="cb129-1186"><a href="#cb129-1186" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb129-1187"><a href="#cb129-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1188"><a href="#cb129-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># Codificación one-hot</span></span>
<span id="cb129-1189"><a href="#cb129-1189" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> ColumnTransformer(</span>
<span id="cb129-1190"><a href="#cb129-1190" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[(<span class="st">'cat'</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>), categorical_features)],</span>
<span id="cb129-1191"><a href="#cb129-1191" aria-hidden="true" tabindex="-1"></a>    remainder<span class="op">=</span><span class="st">'drop'</span>  <span class="co"># solo se procesan las columnas categóricas que definimos</span></span>
<span id="cb129-1192"><a href="#cb129-1192" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1193"><a href="#cb129-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1194"><a href="#cb129-1194" aria-hidden="true" tabindex="-1"></a>X_train_enc <span class="op">=</span> encoder.fit_transform(X_train_scaled)</span>
<span id="cb129-1195"><a href="#cb129-1195" aria-hidden="true" tabindex="-1"></a>X_val_enc <span class="op">=</span> encoder.transform(X_val_scaled)</span>
<span id="cb129-1196"><a href="#cb129-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1197"><a href="#cb129-1197" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Codificación One-Hot realizada ✅"</span>)</span>
<span id="cb129-1198"><a href="#cb129-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1199"><a href="#cb129-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1200"><a href="#cb129-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1201"><a href="#cb129-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1202"><a href="#cb129-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1203"><a href="#cb129-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1206"><a href="#cb129-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1207"><a href="#cb129-1207" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: conversion_dataframe</span></span>
<span id="cb129-1208"><a href="#cb129-1208" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1209"><a href="#cb129-1209" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1210"><a href="#cb129-1210" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertimos a DataFrame para inspección</span></span>
<span id="cb129-1211"><a href="#cb129-1211" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb129-1212"><a href="#cb129-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1213"><a href="#cb129-1213" aria-hidden="true" tabindex="-1"></a>X_train_df <span class="op">=</span> pd.DataFrame(X_train_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_train_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_train_enc)</span>
<span id="cb129-1214"><a href="#cb129-1214" aria-hidden="true" tabindex="-1"></a>X_val_df <span class="op">=</span> pd.DataFrame(X_val_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_val_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_val_enc)</span>
<span id="cb129-1215"><a href="#cb129-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1216"><a href="#cb129-1216" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conversión a DataFrame realizada ✅"</span>)</span>
<span id="cb129-1217"><a href="#cb129-1217" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dimensiones X_train_df:"</span>, X_train_df.shape)</span>
<span id="cb129-1218"><a href="#cb129-1218" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dimensiones X_val_df:"</span>, X_val_df.shape)</span>
<span id="cb129-1219"><a href="#cb129-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1220"><a href="#cb129-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1221"><a href="#cb129-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1222"><a href="#cb129-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1223"><a href="#cb129-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1226"><a href="#cb129-1226" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1227"><a href="#cb129-1227" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: verificacion_targuet</span></span>
<span id="cb129-1228"><a href="#cb129-1228" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1229"><a href="#cb129-1229" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1230"><a href="#cb129-1230" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_train_int:"</span>, y_train_int.isna().<span class="bu">sum</span>())</span>
<span id="cb129-1231"><a href="#cb129-1231" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_val_int:"</span>, y_val_int.isna().<span class="bu">sum</span>())</span>
<span id="cb129-1232"><a href="#cb129-1232" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores únicos en y_train_int:"</span>, y_train_int.unique())</span>
<span id="cb129-1233"><a href="#cb129-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1234"><a href="#cb129-1234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1235"><a href="#cb129-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1236"><a href="#cb129-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1237"><a href="#cb129-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1238"><a href="#cb129-1238" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Escalado de la variable objetivo**</span></span>
<span id="cb129-1239"><a href="#cb129-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1242"><a href="#cb129-1242" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1243"><a href="#cb129-1243" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: escalado_target</span></span>
<span id="cb129-1244"><a href="#cb129-1244" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1245"><a href="#cb129-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1246"><a href="#cb129-1246" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb129-1247"><a href="#cb129-1247" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1248"><a href="#cb129-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1249"><a href="#cb129-1249" aria-hidden="true" tabindex="-1"></a>scaler_y <span class="op">=</span> MinMaxScaler()</span>
<span id="cb129-1250"><a href="#cb129-1250" aria-hidden="true" tabindex="-1"></a>y_train_scaled <span class="op">=</span> scaler_y.fit_transform(y_train_int.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb129-1251"><a href="#cb129-1251" aria-hidden="true" tabindex="-1"></a>y_val_scaled <span class="op">=</span> scaler_y.transform(y_val_int.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb129-1252"><a href="#cb129-1252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1253"><a href="#cb129-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1254"><a href="#cb129-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1255"><a href="#cb129-1255" aria-hidden="true" tabindex="-1"></a><span class="fu">## inspeccionar_target</span></span>
<span id="cb129-1256"><a href="#cb129-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1259"><a href="#cb129-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1260"><a href="#cb129-1260" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: verificar_y</span></span>
<span id="cb129-1261"><a href="#cb129-1261" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1262"><a href="#cb129-1262" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1263"><a href="#cb129-1263" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1264"><a href="#cb129-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1265"><a href="#cb129-1265" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_train_scaled:"</span>, np.isnan(y_train_scaled).<span class="bu">sum</span>())</span>
<span id="cb129-1266"><a href="#cb129-1266" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Inf en y_train_scaled:"</span>, np.isinf(y_train_scaled).<span class="bu">sum</span>())</span>
<span id="cb129-1267"><a href="#cb129-1267" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NaN en y_val_scaled:"</span>, np.isnan(y_val_scaled).<span class="bu">sum</span>())</span>
<span id="cb129-1268"><a href="#cb129-1268" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Inf en y_val_scaled:"</span>, np.isinf(y_val_scaled).<span class="bu">sum</span>())</span>
<span id="cb129-1269"><a href="#cb129-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1270"><a href="#cb129-1270" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores mínimos y máximos en y_train_scaled:"</span>, y_train_scaled.<span class="bu">min</span>(), y_train_scaled.<span class="bu">max</span>())</span>
<span id="cb129-1271"><a href="#cb129-1271" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valores mínimos y máximos en y_val_scaled:"</span>, y_val_scaled.<span class="bu">min</span>(), y_val_scaled.<span class="bu">max</span>())</span>
<span id="cb129-1272"><a href="#cb129-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1273"><a href="#cb129-1273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1274"><a href="#cb129-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1275"><a href="#cb129-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1276"><a href="#cb129-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1277"><a href="#cb129-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1278"><a href="#cb129-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1279"><a href="#cb129-1279" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Crear secuencias para LSTM (con índices originales)**</span></span>
<span id="cb129-1280"><a href="#cb129-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1283"><a href="#cb129-1283" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1284"><a href="#cb129-1284" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_secuencias</span></span>
<span id="cb129-1285"><a href="#cb129-1285" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1286"><a href="#cb129-1286" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1287"><a href="#cb129-1287" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb129-1288"><a href="#cb129-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1289"><a href="#cb129-1289" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_sequences(X, y, df_indices, seq_len<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb129-1290"><a href="#cb129-1290" aria-hidden="true" tabindex="-1"></a>    X_seq, y_seq, idx_seq_all <span class="op">=</span> [], [], []</span>
<span id="cb129-1291"><a href="#cb129-1291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, group <span class="kw">in</span> df_indices.groupby(<span class="st">'mmsi'</span>):</span>
<span id="cb129-1292"><a href="#cb129-1292" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb129-1293"><a href="#cb129-1293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&lt;=</span> seq_len:</span>
<span id="cb129-1294"><a href="#cb129-1294" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb129-1295"><a href="#cb129-1295" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n <span class="op">-</span> seq_len):</span>
<span id="cb129-1296"><a href="#cb129-1296" aria-hidden="true" tabindex="-1"></a>            idx_seq <span class="op">=</span> group.index[i:i<span class="op">+</span>seq_len].to_list()</span>
<span id="cb129-1297"><a href="#cb129-1297" aria-hidden="true" tabindex="-1"></a>            X_seq.append(X[idx_seq])</span>
<span id="cb129-1298"><a href="#cb129-1298" aria-hidden="true" tabindex="-1"></a>            y_seq.append(y[idx_seq[<span class="op">-</span><span class="dv">1</span>]])</span>
<span id="cb129-1299"><a href="#cb129-1299" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Guardamos el índice real del último valor de la secuencia</span></span>
<span id="cb129-1300"><a href="#cb129-1300" aria-hidden="true" tabindex="-1"></a>            idx_seq_all.append(group.loc[idx_seq[<span class="op">-</span><span class="dv">1</span>], <span class="st">"index_original"</span>])</span>
<span id="cb129-1301"><a href="#cb129-1301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(X_seq), np.array(y_seq), np.array(idx_seq_all)</span>
<span id="cb129-1302"><a href="#cb129-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1303"><a href="#cb129-1303" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar índice original</span></span>
<span id="cb129-1304"><a href="#cb129-1304" aria-hidden="true" tabindex="-1"></a>X_train_scaled_reset <span class="op">=</span> X_train_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-1305"><a href="#cb129-1305" aria-hidden="true" tabindex="-1"></a>X_train_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_train_scaled_reset.index</span>
<span id="cb129-1306"><a href="#cb129-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1307"><a href="#cb129-1307" aria-hidden="true" tabindex="-1"></a>X_val_scaled_reset <span class="op">=</span> X_val_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-1308"><a href="#cb129-1308" aria-hidden="true" tabindex="-1"></a>X_val_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_val_scaled_reset.index</span>
<span id="cb129-1309"><a href="#cb129-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1310"><a href="#cb129-1310" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear secuencias</span></span>
<span id="cb129-1311"><a href="#cb129-1311" aria-hidden="true" tabindex="-1"></a>X_train_seq, y_train_seq, idx_train_seq <span class="op">=</span> create_sequences(</span>
<span id="cb129-1312"><a href="#cb129-1312" aria-hidden="true" tabindex="-1"></a>    X_train_df.values, y_train_scaled, X_train_scaled_reset, seq_len</span>
<span id="cb129-1313"><a href="#cb129-1313" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1314"><a href="#cb129-1314" aria-hidden="true" tabindex="-1"></a>X_val_seq, y_val_seq, idx_val_seq <span class="op">=</span> create_sequences(</span>
<span id="cb129-1315"><a href="#cb129-1315" aria-hidden="true" tabindex="-1"></a>    X_val_df.values, y_val_scaled, X_val_scaled_reset, seq_len</span>
<span id="cb129-1316"><a href="#cb129-1316" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1317"><a href="#cb129-1317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1318"><a href="#cb129-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1319"><a href="#cb129-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1320"><a href="#cb129-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1321"><a href="#cb129-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1322"><a href="#cb129-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1323"><a href="#cb129-1323" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Construcción y entrenamiento del modelo LSTM**</span></span>
<span id="cb129-1324"><a href="#cb129-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1327"><a href="#cb129-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1328"><a href="#cb129-1328" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: entrenamiento_lstm</span></span>
<span id="cb129-1329"><a href="#cb129-1329" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1330"><a href="#cb129-1330" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1331"><a href="#cb129-1331" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false   # Evita que Quarto intente renderizar toda la barra de progreso</span></span>
<span id="cb129-1332"><a href="#cb129-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1333"><a href="#cb129-1333" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb129-1334"><a href="#cb129-1334" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> LSTM, Dense, Dropout, Input</span>
<span id="cb129-1335"><a href="#cb129-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1336"><a href="#cb129-1336" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb129-1337"><a href="#cb129-1337" aria-hidden="true" tabindex="-1"></a>model.add(Input(shape<span class="op">=</span>(seq_len, X_train_seq.shape[<span class="dv">2</span>])))</span>
<span id="cb129-1338"><a href="#cb129-1338" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">64</span>, return_sequences<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb129-1339"><a href="#cb129-1339" aria-hidden="true" tabindex="-1"></a>model.add(Dropout(<span class="fl">0.2</span>))</span>
<span id="cb129-1340"><a href="#cb129-1340" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span>
<span id="cb129-1341"><a href="#cb129-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1342"><a href="#cb129-1342" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mse'</span>, metrics<span class="op">=</span>[<span class="st">'mae'</span>])</span>
<span id="cb129-1343"><a href="#cb129-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1344"><a href="#cb129-1344" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(</span>
<span id="cb129-1345"><a href="#cb129-1345" aria-hidden="true" tabindex="-1"></a>    X_train_seq, y_train_seq,</span>
<span id="cb129-1346"><a href="#cb129-1346" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb129-1347"><a href="#cb129-1347" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb129-1348"><a href="#cb129-1348" aria-hidden="true" tabindex="-1"></a>    validation_data<span class="op">=</span>(X_val_seq, y_val_seq),</span>
<span id="cb129-1349"><a href="#cb129-1349" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb129-1350"><a href="#cb129-1350" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1351"><a href="#cb129-1351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1352"><a href="#cb129-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1353"><a href="#cb129-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1354"><a href="#cb129-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1355"><a href="#cb129-1355" aria-hidden="true" tabindex="-1"></a><span class="fu">## **Evaluación del modelo**</span></span>
<span id="cb129-1356"><a href="#cb129-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1359"><a href="#cb129-1359" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1360"><a href="#cb129-1360" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: evaluacion_lstm_metricas</span></span>
<span id="cb129-1361"><a href="#cb129-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1362"><a href="#cb129-1362" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1363"><a href="#cb129-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1364"><a href="#cb129-1364" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb129-1365"><a href="#cb129-1365" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1366"><a href="#cb129-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1367"><a href="#cb129-1367" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluación del modelo en validación</span></span>
<span id="cb129-1368"><a href="#cb129-1368" aria-hidden="true" tabindex="-1"></a>loss, mae <span class="op">=</span> model.evaluate(X_val_seq, y_val_seq, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb129-1369"><a href="#cb129-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1370"><a href="#cb129-1370" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicciones</span></span>
<span id="cb129-1371"><a href="#cb129-1371" aria-hidden="true" tabindex="-1"></a>y_pred_scaled <span class="op">=</span> model.predict(X_val_seq, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb129-1372"><a href="#cb129-1372" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> scaler_y.inverse_transform(y_pred_scaled.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb129-1373"><a href="#cb129-1373" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> scaler_y.inverse_transform(y_val_seq.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb129-1374"><a href="#cb129-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1375"><a href="#cb129-1375" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas</span></span>
<span id="cb129-1376"><a href="#cb129-1376" aria-hidden="true" tabindex="-1"></a>mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_pred))</span>
<span id="cb129-1377"><a href="#cb129-1377" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_true, y_pred)</span>
<span id="cb129-1378"><a href="#cb129-1378" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb129-1379"><a href="#cb129-1379" aria-hidden="true" tabindex="-1"></a>mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((y_true <span class="op">-</span> y_pred) <span class="op">/</span> (y_true <span class="op">+</span> epsilon))) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb129-1380"><a href="#cb129-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1381"><a href="#cb129-1381" aria-hidden="true" tabindex="-1"></a><span class="co"># Prints resumidos y claros</span></span>
<span id="cb129-1382"><a href="#cb129-1382" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R²: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb129-1383"><a href="#cb129-1383" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb129-1384"><a href="#cb129-1384" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loss (scaled): </span><span class="sc">{</span>loss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb129-1385"><a href="#cb129-1385" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAE (scaled): </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb129-1386"><a href="#cb129-1386" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAE original: </span><span class="sc">{</span>mae_original<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb129-1387"><a href="#cb129-1387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1388"><a href="#cb129-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1391"><a href="#cb129-1391" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1392"><a href="#cb129-1392" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tu_loss</span></span>
<span id="cb129-1393"><a href="#cb129-1393" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1394"><a href="#cb129-1394" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1395"><a href="#cb129-1395" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb129-1396"><a href="#cb129-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1397"><a href="#cb129-1397" aria-hidden="true" tabindex="-1"></a><span class="co"># Supongamos que tu entrenamiento devuelve un objeto 'history'</span></span>
<span id="cb129-1398"><a href="#cb129-1398" aria-hidden="true" tabindex="-1"></a><span class="co"># history.history['loss'] contiene el loss por época</span></span>
<span id="cb129-1399"><a href="#cb129-1399" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> history.history[<span class="st">'loss'</span>]  </span>
<span id="cb129-1400"><a href="#cb129-1400" aria-hidden="true" tabindex="-1"></a>val_loss <span class="op">=</span> history.history.get(<span class="st">'val_loss'</span>)  <span class="co"># opcional, si tienes validación</span></span>
<span id="cb129-1401"><a href="#cb129-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1402"><a href="#cb129-1402" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb129-1403"><a href="#cb129-1403" aria-hidden="true" tabindex="-1"></a>plt.plot(loss, label<span class="op">=</span><span class="st">'Entrenamiento'</span>)</span>
<span id="cb129-1404"><a href="#cb129-1404" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> val_loss:</span>
<span id="cb129-1405"><a href="#cb129-1405" aria-hidden="true" tabindex="-1"></a>    plt.plot(val_loss, label<span class="op">=</span><span class="st">'Validación'</span>)</span>
<span id="cb129-1406"><a href="#cb129-1406" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Evolución del Loss'</span>)</span>
<span id="cb129-1407"><a href="#cb129-1407" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Época'</span>)</span>
<span id="cb129-1408"><a href="#cb129-1408" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb129-1409"><a href="#cb129-1409" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb129-1410"><a href="#cb129-1410" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb129-1411"><a href="#cb129-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1412"><a href="#cb129-1412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1413"><a href="#cb129-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1414"><a href="#cb129-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1415"><a href="#cb129-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1416"><a href="#cb129-1416" aria-hidden="true" tabindex="-1"></a><span class="fu">## conjunto de prueba</span></span>
<span id="cb129-1417"><a href="#cb129-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1418"><a href="#cb129-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1419"><a href="#cb129-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1420"><a href="#cb129-1420" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Crear target CO2\_emission en test</span></span>
<span id="cb129-1421"><a href="#cb129-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1424"><a href="#cb129-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1425"><a href="#cb129-1425" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crear_target_test</span></span>
<span id="cb129-1426"><a href="#cb129-1426" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1427"><a href="#cb129-1427" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1428"><a href="#cb129-1428" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear target en test_ext</span></span>
<span id="cb129-1429"><a href="#cb129-1429" aria-hidden="true" tabindex="-1"></a>test_ext <span class="op">=</span> crear_target_emisiones(test_ext)</span>
<span id="cb129-1430"><a href="#cb129-1430" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">'CO2_emission'</span></span>
<span id="cb129-1431"><a href="#cb129-1431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1432"><a href="#cb129-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1435"><a href="#cb129-1435" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1436"><a href="#cb129-1436" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1437"><a href="#cb129-1437" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1438"><a href="#cb129-1438" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> test_ext.copy()</span>
<span id="cb129-1439"><a href="#cb129-1439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1440"><a href="#cb129-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1441"><a href="#cb129-1441" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Eliminar filas con CO2\_emission = 0</span></span>
<span id="cb129-1442"><a href="#cb129-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1445"><a href="#cb129-1445" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1446"><a href="#cb129-1446" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1447"><a href="#cb129-1447" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1448"><a href="#cb129-1448" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> test_ext_filtrado[test_ext_filtrado[target] <span class="op">!=</span> <span class="dv">0</span>].copy()</span>
<span id="cb129-1449"><a href="#cb129-1449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1450"><a href="#cb129-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1451"><a href="#cb129-1451" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb129-1452"><a href="#cb129-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1453"><a href="#cb129-1453" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Revisar cuántas filas quedan tras eliminar ceros</span></span>
<span id="cb129-1454"><a href="#cb129-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1457"><a href="#cb129-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1458"><a href="#cb129-1458" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1459"><a href="#cb129-1459" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1460"><a href="#cb129-1460" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas en test después de eliminar ceros en CO2_emission: </span><span class="sc">{</span><span class="bu">len</span>(test_ext_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1461"><a href="#cb129-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1462"><a href="#cb129-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1463"><a href="#cb129-1463" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb129-1464"><a href="#cb129-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1465"><a href="#cb129-1465" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Filtrar filas con target válido y revisar buques con secuencia mínima</span></span>
<span id="cb129-1466"><a href="#cb129-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1469"><a href="#cb129-1469" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1470"><a href="#cb129-1470" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1471"><a href="#cb129-1471" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1472"><a href="#cb129-1472" aria-hidden="true" tabindex="-1"></a>seq_len <span class="op">=</span> <span class="dv">4</span>  <span class="co"># longitud mínima de secuencia</span></span>
<span id="cb129-1473"><a href="#cb129-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1474"><a href="#cb129-1474" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar filas con target válido</span></span>
<span id="cb129-1475"><a href="#cb129-1475" aria-hidden="true" tabindex="-1"></a>test_ext_target <span class="op">=</span> test_ext_filtrado[test_ext_filtrado[<span class="st">'CO2_emission'</span>].notna()].copy()</span>
<span id="cb129-1476"><a href="#cb129-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1477"><a href="#cb129-1477" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar buques válidos antes y después de filtrar NaN</span></span>
<span id="cb129-1478"><a href="#cb129-1478" aria-hidden="true" tabindex="-1"></a>registros_por_buque_orig <span class="op">=</span> test_ext_filtrado.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb129-1479"><a href="#cb129-1479" aria-hidden="true" tabindex="-1"></a>buques_validos_orig <span class="op">=</span> (registros_por_buque_orig <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb129-1480"><a href="#cb129-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1481"><a href="#cb129-1481" aria-hidden="true" tabindex="-1"></a>registros_por_buque_filtrado <span class="op">=</span> test_ext_target.groupby(<span class="st">'mmsi'</span>).size()</span>
<span id="cb129-1482"><a href="#cb129-1482" aria-hidden="true" tabindex="-1"></a>buques_validos_filtrado <span class="op">=</span> (registros_por_buque_filtrado <span class="op">&gt;=</span> seq_len).<span class="bu">sum</span>()</span>
<span id="cb129-1483"><a href="#cb129-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1484"><a href="#cb129-1484" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen</span></span>
<span id="cb129-1485"><a href="#cb129-1485" aria-hidden="true" tabindex="-1"></a>resumen_test <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-1486"><a href="#cb129-1486" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dataset'</span>: [<span class="st">'Original test'</span>, <span class="st">'Filtrado por target'</span>],</span>
<span id="cb129-1487"><a href="#cb129-1487" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Buques válidos'</span>: [buques_validos_orig, buques_validos_filtrado],</span>
<span id="cb129-1488"><a href="#cb129-1488" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Filas totales'</span>: [<span class="bu">len</span>(test_ext_filtrado), <span class="bu">len</span>(test_ext_target)]</span>
<span id="cb129-1489"><a href="#cb129-1489" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-1490"><a href="#cb129-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1491"><a href="#cb129-1491" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-1492"><a href="#cb129-1492" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_test, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'psql'</span>))</span>
<span id="cb129-1493"><a href="#cb129-1493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1494"><a href="#cb129-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1495"><a href="#cb129-1495" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb129-1496"><a href="#cb129-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1497"><a href="#cb129-1497" aria-hidden="true" tabindex="-1"></a><span class="fu">##  Recorte de buques por secuencia mínima</span></span>
<span id="cb129-1498"><a href="#cb129-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1501"><a href="#cb129-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1502"><a href="#cb129-1502" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1503"><a href="#cb129-1503" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1504"><a href="#cb129-1504" aria-hidden="true" tabindex="-1"></a>test_ext_filtrado <span class="op">=</span> filtrar_buques_por_min_registros(test_ext_target, min_registros<span class="op">=</span>seq_len)</span>
<span id="cb129-1505"><a href="#cb129-1505" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Filas después del recorte por secuencia mínima en test: </span><span class="sc">{</span><span class="bu">len</span>(test_ext_filtrado)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1506"><a href="#cb129-1506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1507"><a href="#cb129-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1508"><a href="#cb129-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1511"><a href="#cb129-1511" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1512"><a href="#cb129-1512" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1513"><a href="#cb129-1513" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1514"><a href="#cb129-1514" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver valores nulos en test_ext_filtrado</span></span>
<span id="cb129-1515"><a href="#cb129-1515" aria-hidden="true" tabindex="-1"></a>nulos_por_col <span class="op">=</span> test_ext_filtrado.isnull().<span class="bu">sum</span>()</span>
<span id="cb129-1516"><a href="#cb129-1516" aria-hidden="true" tabindex="-1"></a>nulos_filtrados <span class="op">=</span> nulos_por_col[nulos_por_col <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb129-1517"><a href="#cb129-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1518"><a href="#cb129-1518" aria-hidden="true" tabindex="-1"></a>resumen_nulos <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-1519"><a href="#cb129-1519" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Columna'</span>: nulos_filtrados.index,</span>
<span id="cb129-1520"><a href="#cb129-1520" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Valores nulos'</span>: nulos_filtrados.values,</span>
<span id="cb129-1521"><a href="#cb129-1521" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Porcentaje nulos (%)'</span>: nulos_filtrados <span class="op">/</span> <span class="bu">len</span>(test_ext_filtrado) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb129-1522"><a href="#cb129-1522" aria-hidden="true" tabindex="-1"></a>}).sort_values(by<span class="op">=</span><span class="st">'Porcentaje nulos (%)'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-1523"><a href="#cb129-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1524"><a href="#cb129-1524" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-1525"><a href="#cb129-1525" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_nulos, headers<span class="op">=</span><span class="st">'keys'</span>, tablefmt<span class="op">=</span><span class="st">'grid'</span>, showindex<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb129-1526"><a href="#cb129-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1527"><a href="#cb129-1527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1528"><a href="#cb129-1528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1529"><a href="#cb129-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1530"><a href="#cb129-1530" aria-hidden="true" tabindex="-1"></a><span class="fu">## definir vairables de entrada </span></span>
<span id="cb129-1531"><a href="#cb129-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1534"><a href="#cb129-1534" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1535"><a href="#cb129-1535" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1536"><a href="#cb129-1536" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1537"><a href="#cb129-1537" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_ext_filtrado.drop(columns<span class="op">=</span>[target])</span>
<span id="cb129-1538"><a href="#cb129-1538" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_ext_filtrado[target]</span>
<span id="cb129-1539"><a href="#cb129-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1540"><a href="#cb129-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1541"><a href="#cb129-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1542"><a href="#cb129-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1545"><a href="#cb129-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1546"><a href="#cb129-1546" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1547"><a href="#cb129-1547" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1548"><a href="#cb129-1548" aria-hidden="true" tabindex="-1"></a><span class="co"># Columnas a imputar en test</span></span>
<span id="cb129-1549"><a href="#cb129-1549" aria-hidden="true" tabindex="-1"></a>columnas_num <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>, <span class="st">'MainEngineRPM'</span>, <span class="st">'FuelType1Capacity'</span>]</span>
<span id="cb129-1550"><a href="#cb129-1550" aria-hidden="true" tabindex="-1"></a>flags <span class="op">=</span> [<span class="st">'TotalBunkerCapacity'</span>]  <span class="co"># opcional: marcar dónde había nulos</span></span>
<span id="cb129-1551"><a href="#cb129-1551" aria-hidden="true" tabindex="-1"></a>columnas_cat <span class="op">=</span> []  <span class="co"># no hay categóricas con nulos</span></span>
<span id="cb129-1552"><a href="#cb129-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1553"><a href="#cb129-1553" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar imputación al test usando stats del train</span></span>
<span id="cb129-1554"><a href="#cb129-1554" aria-hidden="true" tabindex="-1"></a>X_test_imputado, _, _ <span class="op">=</span> imputar_datos(</span>
<span id="cb129-1555"><a href="#cb129-1555" aria-hidden="true" tabindex="-1"></a>    X_test,</span>
<span id="cb129-1556"><a href="#cb129-1556" aria-hidden="true" tabindex="-1"></a>    columnas_numericas<span class="op">=</span>columnas_num,</span>
<span id="cb129-1557"><a href="#cb129-1557" aria-hidden="true" tabindex="-1"></a>    columnas_categoricas<span class="op">=</span>columnas_cat,</span>
<span id="cb129-1558"><a href="#cb129-1558" aria-hidden="true" tabindex="-1"></a>    flags_nulos<span class="op">=</span>flags,</span>
<span id="cb129-1559"><a href="#cb129-1559" aria-hidden="true" tabindex="-1"></a>    medianas<span class="op">=</span>medianas,  <span class="co"># de X_train_int_imputado</span></span>
<span id="cb129-1560"><a href="#cb129-1560" aria-hidden="true" tabindex="-1"></a>    modas<span class="op">=</span>modas</span>
<span id="cb129-1561"><a href="#cb129-1561" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1562"><a href="#cb129-1562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1563"><a href="#cb129-1563" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1564"><a href="#cb129-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1565"><a href="#cb129-1565" aria-hidden="true" tabindex="-1"></a><span class="fu">## features</span></span>
<span id="cb129-1568"><a href="#cb129-1568" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1569"><a href="#cb129-1569" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1570"><a href="#cb129-1570" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1571"><a href="#cb129-1571" aria-hidden="true" tabindex="-1"></a>X_test_features <span class="op">=</span> crear_features(X_test_imputado)</span>
<span id="cb129-1572"><a href="#cb129-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1573"><a href="#cb129-1573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1574"><a href="#cb129-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1575"><a href="#cb129-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1576"><a href="#cb129-1576" aria-hidden="true" tabindex="-1"></a><span class="fu">## ajustes de correlaciones</span></span>
<span id="cb129-1577"><a href="#cb129-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1580"><a href="#cb129-1580" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1581"><a href="#cb129-1581" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1582"><a href="#cb129-1582" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1583"><a href="#cb129-1583" aria-hidden="true" tabindex="-1"></a>X_test_sin_corr <span class="op">=</span> X_test_imputado.drop(columns<span class="op">=</span>columns_to_drop)</span>
<span id="cb129-1584"><a href="#cb129-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1585"><a href="#cb129-1585" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas en test antes de eliminar correladas: </span><span class="sc">{</span>X_test_imputado<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1586"><a href="#cb129-1586" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columnas en test después de eliminar correladas: </span><span class="sc">{</span>X_test_sin_corr<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-1587"><a href="#cb129-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1588"><a href="#cb129-1588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1589"><a href="#cb129-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1590"><a href="#cb129-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1593"><a href="#cb129-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1594"><a href="#cb129-1594" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1595"><a href="#cb129-1595" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1596"><a href="#cb129-1596" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb129-1597"><a href="#cb129-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1598"><a href="#cb129-1598" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de columnas finales del test</span></span>
<span id="cb129-1599"><a href="#cb129-1599" aria-hidden="true" tabindex="-1"></a>resumen_test_final <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-1600"><a href="#cb129-1600" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Columnas finales"</span>: X_test_sin_corr.columns,</span>
<span id="cb129-1601"><a href="#cb129-1601" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tipo"</span>: X_test_sin_corr.dtypes.values</span>
<span id="cb129-1602"><a href="#cb129-1602" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-1603"><a href="#cb129-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1604"><a href="#cb129-1604" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(resumen_test_final, headers<span class="op">=</span><span class="st">"keys"</span>, tablefmt<span class="op">=</span><span class="st">"psql"</span>))</span>
<span id="cb129-1605"><a href="#cb129-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1606"><a href="#cb129-1606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1607"><a href="#cb129-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1608"><a href="#cb129-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1609"><a href="#cb129-1609" aria-hidden="true" tabindex="-1"></a><span class="fu">## features test</span></span>
<span id="cb129-1610"><a href="#cb129-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1613"><a href="#cb129-1613" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1614"><a href="#cb129-1614" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1615"><a href="#cb129-1615" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1616"><a href="#cb129-1616" aria-hidden="true" tabindex="-1"></a><span class="co"># Features numéricas (las que se escalan)</span></span>
<span id="cb129-1617"><a href="#cb129-1617" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [</span>
<span id="cb129-1618"><a href="#cb129-1618" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GrossTonnage_x'</span>, <span class="st">'sum_me_ene'</span>, <span class="st">'sum_ab_ene'</span>,</span>
<span id="cb129-1619"><a href="#cb129-1619" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Speedmax'</span>, <span class="st">'BreadthExtreme'</span>, <span class="st">'FuelType1Capacity'</span>,</span>
<span id="cb129-1620"><a href="#cb129-1620" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineRPM'</span>, <span class="st">'Powerkwservice'</span>, <span class="st">'combustible_ab'</span>,</span>
<span id="cb129-1621"><a href="#cb129-1621" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TotalBunkerCapacity_is_missing'</span></span>
<span id="cb129-1622"><a href="#cb129-1622" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb129-1623"><a href="#cb129-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1624"><a href="#cb129-1624" aria-hidden="true" tabindex="-1"></a><span class="co"># Features categóricas (objetos), excluyendo 'h3_sequence'</span></span>
<span id="cb129-1625"><a href="#cb129-1625" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [</span>
<span id="cb129-1626"><a href="#cb129-1626" aria-hidden="true" tabindex="-1"></a>    <span class="st">'port_before'</span>, <span class="st">'country_before'</span>, <span class="st">'port_after'</span>, <span class="st">'country_after'</span>,</span>
<span id="cb129-1627"><a href="#cb129-1627" aria-hidden="true" tabindex="-1"></a>    <span class="st">'op_phase'</span>, <span class="st">'StandardVesselType_x'</span>, <span class="st">'MainEngineModel'</span>, </span>
<span id="cb129-1628"><a href="#cb129-1628" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MainEngineType'</span>, <span class="st">'PropulsionType'</span>, <span class="st">'ShiptypeLevel5'</span>,</span>
<span id="cb129-1629"><a href="#cb129-1629" aria-hidden="true" tabindex="-1"></a>    <span class="st">'StandardVesselType_y'</span>, <span class="st">'fuel'</span>, <span class="st">'meType'</span></span>
<span id="cb129-1630"><a href="#cb129-1630" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb129-1631"><a href="#cb129-1631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1632"><a href="#cb129-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1633"><a href="#cb129-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1634"><a href="#cb129-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1637"><a href="#cb129-1637" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1638"><a href="#cb129-1638" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1639"><a href="#cb129-1639" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1640"><a href="#cb129-1640" aria-hidden="true" tabindex="-1"></a><span class="co"># Escalar columnas numéricas</span></span>
<span id="cb129-1641"><a href="#cb129-1641" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="op">=</span> X_test_sin_corr.copy()</span>
<span id="cb129-1642"><a href="#cb129-1642" aria-hidden="true" tabindex="-1"></a>X_test_scaled[numeric_features] <span class="op">=</span> scaler.transform(X_test_scaled[numeric_features])</span>
<span id="cb129-1643"><a href="#cb129-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1644"><a href="#cb129-1644" aria-hidden="true" tabindex="-1"></a><span class="co">#  Convertir categóricas a string</span></span>
<span id="cb129-1645"><a href="#cb129-1645" aria-hidden="true" tabindex="-1"></a>X_test_scaled[categorical_features] <span class="op">=</span> X_test_scaled[categorical_features].astype(<span class="bu">str</span>)</span>
<span id="cb129-1646"><a href="#cb129-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1647"><a href="#cb129-1647" aria-hidden="true" tabindex="-1"></a><span class="co">#  Codificación One-Hot usando encoder ya ajustado</span></span>
<span id="cb129-1648"><a href="#cb129-1648" aria-hidden="true" tabindex="-1"></a>X_test_enc <span class="op">=</span> encoder.transform(X_test_scaled)</span>
<span id="cb129-1649"><a href="#cb129-1649" aria-hidden="true" tabindex="-1"></a>X_test_df <span class="op">=</span> pd.DataFrame(X_test_enc.toarray() <span class="cf">if</span> <span class="bu">hasattr</span>(X_test_enc, <span class="st">"toarray"</span>) <span class="cf">else</span> X_test_enc)</span>
<span id="cb129-1650"><a href="#cb129-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1651"><a href="#cb129-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1652"><a href="#cb129-1652" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1653"><a href="#cb129-1653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1654"><a href="#cb129-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1657"><a href="#cb129-1657" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1658"><a href="#cb129-1658" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1659"><a href="#cb129-1659" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1660"><a href="#cb129-1660" aria-hidden="true" tabindex="-1"></a><span class="co">#  Escalar variable objetivo</span></span>
<span id="cb129-1661"><a href="#cb129-1661" aria-hidden="true" tabindex="-1"></a>y_test_scaled <span class="op">=</span> scaler_y.transform(y_test.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb129-1662"><a href="#cb129-1662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1663"><a href="#cb129-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1664"><a href="#cb129-1664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1665"><a href="#cb129-1665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1666"><a href="#cb129-1666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1667"><a href="#cb129-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1670"><a href="#cb129-1670" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1671"><a href="#cb129-1671" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1672"><a href="#cb129-1672" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1673"><a href="#cb129-1673" aria-hidden="true" tabindex="-1"></a><span class="co">#  Crear secuencias para LSTM</span></span>
<span id="cb129-1674"><a href="#cb129-1674" aria-hidden="true" tabindex="-1"></a>X_test_scaled_reset <span class="op">=</span> X_test_scaled.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-1675"><a href="#cb129-1675" aria-hidden="true" tabindex="-1"></a>X_test_scaled_reset[<span class="st">'index_original'</span>] <span class="op">=</span> X_test_scaled_reset.index</span>
<span id="cb129-1676"><a href="#cb129-1676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1677"><a href="#cb129-1677" aria-hidden="true" tabindex="-1"></a>X_test_seq, y_test_seq, idx_test_seq <span class="op">=</span> create_sequences(</span>
<span id="cb129-1678"><a href="#cb129-1678" aria-hidden="true" tabindex="-1"></a>    X_test_df.values, y_test_scaled, X_test_scaled_reset, seq_len</span>
<span id="cb129-1679"><a href="#cb129-1679" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb129-1680"><a href="#cb129-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1681"><a href="#cb129-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1682"><a href="#cb129-1682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1683"><a href="#cb129-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1684"><a href="#cb129-1684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1687"><a href="#cb129-1687" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1688"><a href="#cb129-1688" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1689"><a href="#cb129-1689" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1690"><a href="#cb129-1690" aria-hidden="true" tabindex="-1"></a><span class="co">#  Evaluar modelo</span></span>
<span id="cb129-1691"><a href="#cb129-1691" aria-hidden="true" tabindex="-1"></a>loss, mae <span class="op">=</span> model.evaluate(X_test_seq, y_test_seq)</span>
<span id="cb129-1692"><a href="#cb129-1692" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test Loss:"</span>, loss, <span class="st">"Test MAE:"</span>, mae)</span>
<span id="cb129-1693"><a href="#cb129-1693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1694"><a href="#cb129-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1695"><a href="#cb129-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1698"><a href="#cb129-1698" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1699"><a href="#cb129-1699" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1700"><a href="#cb129-1700" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1701"><a href="#cb129-1701" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener predicciones en el test</span></span>
<span id="cb129-1702"><a href="#cb129-1702" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> model.predict(X_test_seq)</span>
<span id="cb129-1703"><a href="#cb129-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1704"><a href="#cb129-1704" aria-hidden="true" tabindex="-1"></a><span class="co"># Reconstrucción con índices originales</span></span>
<span id="cb129-1705"><a href="#cb129-1705" aria-hidden="true" tabindex="-1"></a>df_results_test <span class="op">=</span> pd.DataFrame({</span>
<span id="cb129-1706"><a href="#cb129-1706" aria-hidden="true" tabindex="-1"></a>    <span class="st">"index_original"</span>: idx_test_seq,</span>
<span id="cb129-1707"><a href="#cb129-1707" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y_true"</span>: y_test_seq.flatten(),</span>
<span id="cb129-1708"><a href="#cb129-1708" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y_pred"</span>: y_test_pred.flatten()</span>
<span id="cb129-1709"><a href="#cb129-1709" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb129-1710"><a href="#cb129-1710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1711"><a href="#cb129-1711" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver las primeras filas</span></span>
<span id="cb129-1712"><a href="#cb129-1712" aria-hidden="true" tabindex="-1"></a>df_results_test.head()</span>
<span id="cb129-1713"><a href="#cb129-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1714"><a href="#cb129-1714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1715"><a href="#cb129-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1718"><a href="#cb129-1718" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1719"><a href="#cb129-1719" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb129-1720"><a href="#cb129-1720" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb129-1721"><a href="#cb129-1721" aria-hidden="true" tabindex="-1"></a>df_results_test.to_csv(<span class="st">"df_results_test.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb129-1722"><a href="#cb129-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1723"><a href="#cb129-1723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1724"><a href="#cb129-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1727"><a href="#cb129-1727" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1728"><a href="#cb129-1728" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraer mmsi para cada predicción</span></span>
<span id="cb129-1729"><a href="#cb129-1729" aria-hidden="true" tabindex="-1"></a>df_results_test[<span class="st">'mmsi'</span>] <span class="op">=</span> X_test_scaled_reset.loc[df_results_test[<span class="st">'index_original'</span>], <span class="st">'mmsi'</span>].values</span>
<span id="cb129-1730"><a href="#cb129-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1731"><a href="#cb129-1731" aria-hidden="true" tabindex="-1"></a><span class="co"># Elegir un MMSI aleatorio del conjunto de prueba</span></span>
<span id="cb129-1732"><a href="#cb129-1732" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb129-1733"><a href="#cb129-1733" aria-hidden="true" tabindex="-1"></a>mmsi_random <span class="op">=</span> np.random.choice(df_results_test[<span class="st">'mmsi'</span>].unique())</span>
<span id="cb129-1734"><a href="#cb129-1734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1735"><a href="#cb129-1735" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar predicciones de ese buque</span></span>
<span id="cb129-1736"><a href="#cb129-1736" aria-hidden="true" tabindex="-1"></a>df_buque <span class="op">=</span> df_results_test[df_results_test[<span class="st">'mmsi'</span>] <span class="op">==</span> mmsi_random]</span>
<span id="cb129-1737"><a href="#cb129-1737" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_buque)</span>
<span id="cb129-1738"><a href="#cb129-1738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1739"><a href="#cb129-1739" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1740"><a href="#cb129-1740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1743"><a href="#cb129-1743" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb129-1744"><a href="#cb129-1744" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb129-1745"><a href="#cb129-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1746"><a href="#cb129-1746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1747"><a href="#cb129-1747" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar cuántos registros tiene cada MMSI</span></span>
<span id="cb129-1748"><a href="#cb129-1748" aria-hidden="true" tabindex="-1"></a>conteo_buques <span class="op">=</span> df_results_test[<span class="st">'mmsi'</span>].value_counts()</span>
<span id="cb129-1749"><a href="#cb129-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1750"><a href="#cb129-1750" aria-hidden="true" tabindex="-1"></a><span class="co"># Elegir un MMSI con al menos, por ejemplo, 5 secuencias</span></span>
<span id="cb129-1751"><a href="#cb129-1751" aria-hidden="true" tabindex="-1"></a>mmsi_ejemplo <span class="op">=</span> conteo_buques[conteo_buques <span class="op">&gt;=</span> <span class="dv">5</span>].index[<span class="dv">0</span>]</span>
<span id="cb129-1752"><a href="#cb129-1752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1753"><a href="#cb129-1753" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar predicciones de ese buque</span></span>
<span id="cb129-1754"><a href="#cb129-1754" aria-hidden="true" tabindex="-1"></a>df_buque <span class="op">=</span> df_results_test[df_results_test[<span class="st">'mmsi'</span>] <span class="op">==</span> mmsi_ejemplo]</span>
<span id="cb129-1755"><a href="#cb129-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1756"><a href="#cb129-1756" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar</span></span>
<span id="cb129-1757"><a href="#cb129-1757" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb129-1758"><a href="#cb129-1758" aria-hidden="true" tabindex="-1"></a>plt.plot(df_buque[<span class="st">'y_true'</span>].values, label<span class="op">=</span><span class="st">'y_true'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb129-1759"><a href="#cb129-1759" aria-hidden="true" tabindex="-1"></a>plt.plot(df_buque[<span class="st">'y_pred'</span>].values, label<span class="op">=</span><span class="st">'y_pred'</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb129-1760"><a href="#cb129-1760" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Predicciones vs Valores reales para MMSI </span><span class="sc">{</span>mmsi_ejemplo<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb129-1761"><a href="#cb129-1761" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Secuencia'</span>)</span>
<span id="cb129-1762"><a href="#cb129-1762" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'CO2_emission (escalado)'</span>)</span>
<span id="cb129-1763"><a href="#cb129-1763" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb129-1764"><a href="#cb129-1764" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb129-1765"><a href="#cb129-1765" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb129-1766"><a href="#cb129-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1767"><a href="#cb129-1767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb129-1768"><a href="#cb129-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-1769"><a href="#cb129-1769" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copiar al portapapeles" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>